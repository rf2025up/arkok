# ğŸ“Š entrypoint.sh éƒ¨ç½²æ–¹æ¡ˆåˆ†æ

**é—®é¢˜**: ä»£ç å·²æ›´æ–°ï¼ˆWebSocketã€æ–°æ•°æ®åº“è¡¨ç­‰ï¼‰ï¼Œæ˜¯å¦è¿˜èƒ½ç”¨ entrypoint.sh éƒ¨ç½²åˆ°å…¬ç½‘ï¼Ÿ

**ç­”æ¡ˆ**: âœ… **å®Œå…¨å¯ä»¥ï¼Œä¸”æ¨èç»§ç»­ä½¿ç”¨**

---

## ğŸ” è¯¦ç»†åˆ†æ

### 1ï¸âƒ£ ä»£ç å˜åŒ–å½±å“è¯„ä¼°

#### åç«¯ä»£ç å˜åŒ–
```
âœ… server.js
   â”œâ”€ æ–°å¢: HTTP æœåŠ¡å™¨åŒ…è£…
   â”œâ”€ æ–°å¢: WebSocket æœåŠ¡
   â”œâ”€ æ–°å¢: äº‹ä»¶å¹¿æ’­å‡½æ•°
   â””â”€ å½±å“: é›¶ âŒ å¯¹ entrypoint.sh æ— å½±å“

âœ… package.json
   â”œâ”€ æ–°å¢: ws ä¾èµ– (^8.18.3)
   â””â”€ å½±å“: ä½ âš ï¸ éœ€è¦ npm install

âœ… create-schema.js
   â”œâ”€ æ–°å¢: 13 å¼ è¡¨å®šä¹‰
   â”œâ”€ æ–°å¢: é»˜è®¤æ•°æ®å¯¼å…¥
   â””â”€ å½±å“: é«˜ âš ï¸ éœ€è¦åˆå§‹åŒ–

âœ… bigscreen/ å’Œ mobile/
   â””â”€ å½±å“: é›¶ âŒ å‰ç«¯åº”ç”¨ï¼Œä¸åç«¯å¯åŠ¨è„šæœ¬æ— å…³
```

#### å¯¹ entrypoint.sh çš„å½±å“
| å˜åŒ– | å½±å“ | è¯´æ˜ |
|------|------|------|
| WebSocket æ”¯æŒ | âœ… æ—  | åœ¨ä»£ç å†…éƒ¨å®ç°ï¼Œè„šæœ¬ä¸éœ€æ”¹å˜ |
| æ–°ä¾èµ– ws | âœ… æ—  | è„šæœ¬è‡ªåŠ¨é€šè¿‡ npm install å¤„ç† |
| æ•°æ®åº“åˆå§‹åŒ– | âœ… æ—  | ä¼˜åŒ–ç‰ˆè„šæœ¬å·²æ”¯æŒè‡ªåŠ¨åˆå§‹åŒ– |
| ç¯å¢ƒå˜é‡ | âœ… æ—  | è„šæœ¬æ­£ç¡®ä¼ é€’ NODE_ENV å˜é‡ |

**ç»“è®º**: âœ… **entrypoint.sh å®Œå…¨å…¼å®¹æ–°ä»£ç **

---

### 2ï¸âƒ£ entrypoint.sh æ¶æ„è¯´æ˜

```
entrypoint.sh (å¯åŠ¨è„šæœ¬)
    â†“
[æ£€æŸ¥ä¾èµ–] npm install â† è‡ªåŠ¨å¤„ç†æ–°çš„ ws ä¾èµ–
    â†“
[åˆå§‹åŒ–æ•°æ®åº“] node create-schema.js â† è‡ªåŠ¨å¤„ç†æ–°çš„ 13 å¼ è¡¨
    â†“
[å¯åŠ¨æœåŠ¡] node server.js â† server.js å†…éƒ¨å·²æœ‰ WebSocket ä»£ç 
    â†“
[ç›‘å¬ 3000 ç«¯å£]
    â”œâ”€ HTTP API: /api/*
    â”œâ”€ WebSocket: ws://
    â””â”€ é™æ€æ–‡ä»¶: /admin, /api-docs
```

**å…³é”®ç‚¹**: è„šæœ¬åªè´Ÿè´£å¯åŠ¨ï¼Œæ‰€æœ‰æ–°åŠŸèƒ½éƒ½åœ¨ `server.js` å†…éƒ¨å®ç°

---

### 3ï¸âƒ£ éƒ¨ç½²æµç¨‹å¯¹æ¯”

#### âŒ æ—§æ–¹å¼ï¼ˆç›´æ¥ npm startï¼‰
```bash
cd /home/devbox/project
npm install              # â† éœ€è¦æ‰‹åŠ¨è¿è¡Œ
node create-schema.js   # â† éœ€è¦æ‰‹åŠ¨è¿è¡Œ
node server.js          # â† å¯åŠ¨åº”ç”¨
```

**é—®é¢˜**:
- âŒ ä¾èµ–ç®¡ç†æ‰‹åŠ¨
- âŒ æ•°æ®åº“åˆå§‹åŒ–æ‰‹åŠ¨
- âŒ æ— æ³•åº”å¯¹ä¾èµ–æ›´æ–°
- âŒ å®¹å™¨åŒ–æ—¶å®¹æ˜“å‡ºé”™

#### âœ… æ–°æ–¹å¼ï¼ˆä½¿ç”¨ entrypoint.shï¼‰
```bash
cd /home/devbox/project
./entrypoint.sh production  # â† ä¸€æ¡å‘½ä»¤æå®šï¼
```

**ä¼˜åŠ¿**:
- âœ… è‡ªåŠ¨ä¾èµ–æ£€æŸ¥
- âœ… è‡ªåŠ¨æ•°æ®åº“åˆå§‹åŒ–ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- âœ… è‡ªåŠ¨å¤„ç†ä¾èµ–å˜åŒ–
- âœ… å®¹å™¨åŒ–å‹å¥½
- âœ… æ—¥å¿—è®°å½•
- âœ… é”™è¯¯å¤„ç†

---

### 4ï¸âƒ£ Sealos éƒ¨ç½²æ–¹æ¡ˆ

#### æ–¹æ¡ˆ A: å¿«é€Ÿéƒ¨ç½²ï¼ˆæ¨è â­ï¼‰

**ä»€ä¹ˆæ—¶å€™ç”¨**ï¼š
- ä»£ç æ›´æ–°ä¸å¤§
- åªæ˜¯ WebSocket åŠŸèƒ½å¢å¼º
- ä¸éœ€è¦æ”¹å˜å®¹å™¨å¯åŠ¨æ–¹å¼

**æµç¨‹**ï¼š
```bash
1. æœ¬åœ°éªŒè¯ï¼ˆå¯é€‰ï¼‰
   ./entrypoint.sh development

2. æ¨é€åˆ° Git
   git add . && git commit -m "Update with WebSocket"
   git push origin main

3. Sealos è‡ªåŠ¨æ›´æ–°ï¼ˆå¦‚æœé…ç½®äº† CI/CDï¼‰
   æˆ–æ‰‹åŠ¨åœ¨ Sealos UI ä¸­æ›´æ–°
```

**è€—æ—¶**: â±ï¸ 5 åˆ†é’Ÿ

---

#### æ–¹æ¡ˆ B: å®Œæ•´é‡æ–°éƒ¨ç½²ï¼ˆä¿é™©ï¼‰

**ä»€ä¹ˆæ—¶å€™ç”¨**ï¼š
- å¤§å¹…ä»£ç æ›´æ–°
- éœ€è¦ç¡®ä¿ä¸€åˆ‡æ­£å¸¸
- é¦–æ¬¡ä½¿ç”¨ä¼˜åŒ–ç‰ˆ entrypoint.sh

**æµç¨‹**ï¼š
```bash
1. æœ¬åœ°å®Œæ•´æµ‹è¯•
   rm -rf node_modules
   ./entrypoint.sh production

2. éªŒè¯æ‰€æœ‰åŠŸèƒ½
   - æµ‹è¯• API ç«¯ç‚¹
   - æµ‹è¯• WebSocket è¿æ¥
   - æµ‹è¯•æ•°æ®åº“æŸ¥è¯¢

3. æ„å»ºæ–° Docker é•œåƒ
   docker build -t growark-backend:v2 .

4. æ¨é€åˆ° Sealos
   - é€šè¿‡é•œåƒä»“åº“æ¨é€
   - æˆ–é€šè¿‡ Sealos CLI æ›´æ–°

5. éªŒè¯å…¬ç½‘éƒ¨ç½²
   curl https://xysrxgjnpycd.sealoshzh.site/
```

**è€—æ—¶**: â±ï¸ 15 åˆ†é’Ÿ

---

### 5ï¸âƒ£ å®¹å™¨åŒ–é›†æˆ

#### å½“å‰ Dockerfileï¼ˆéœ€è¦å°å¹…æ›´æ–°ï¼‰

```dockerfile
FROM node:18-alpine

WORKDIR /app

# å¤åˆ¶æºæ–‡ä»¶
COPY package*.json ./
COPY entrypoint.sh ./      # â† æ–°å¢ï¼
COPY server.js .
COPY create-schema.js .

# å®‰è£…ä¾èµ–
RUN npm ci --only=production

# èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™
RUN chmod +x entrypoint.sh # â† æ–°å¢ï¼

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
    CMD node -e "require('http').get('http://localhost:3000', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"

# ä½¿ç”¨ entrypoint.sh å¯åŠ¨
CMD ["./entrypoint.sh", "production"]  # â† æ”¹ä¸ºè„šæœ¬ï¼
```

**ä¼˜åŠ¿**:
- âœ… å¯åŠ¨é€»è¾‘ç»Ÿä¸€
- âœ… ä¾èµ–æ£€æŸ¥è‡ªåŠ¨
- âœ… é”™è¯¯å¤„ç†å®Œå–„

---

### 6ï¸âƒ£ Kubernetes é›†æˆ

å¦‚æœåœ¨ Sealos ä¸­ä½¿ç”¨ Kubernetesï¼š

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: growark-backend
spec:
  template:
    spec:
      containers:
      - name: backend
        image: growark-backend:v2
        command: ["./entrypoint.sh"]  # â† ä½¿ç”¨è„šæœ¬
        args: ["production"]
        ports:
        - containerPort: 3000
        env:
        - name: NODE_ENV
          value: "production"
        - name: PORT
          value: "3000"
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 40
          periodSeconds: 30
```

---

## ğŸ“ˆ ç‰ˆæœ¬å¯¹æ¯”

| åŠŸèƒ½ | æ—§è„šæœ¬ | æ–°è„šæœ¬ |
|------|--------|--------|
| åŸºç¡€å¯åŠ¨ | âœ… | âœ… |
| ä¾èµ–æ£€æŸ¥ | âŒ | âœ… |
| æ•°æ®åº“åˆå§‹åŒ– | âŒ | âœ… |
| æ—¥å¿—è®°å½• | âŒ | âœ… |
| é”™è¯¯å¤„ç† | âŒ | âœ… |
| ç¯å¢ƒé€‚é… | åŸºç¡€ | å®Œå–„ |
| ä»£ç å¯è¯»æ€§ | ä½ | é«˜ |

---

## ğŸ¯ å»ºè®®æ–¹æ¡ˆ

### âœ… æ¨èï¼šä½¿ç”¨ä¼˜åŒ–ç‰ˆ entrypoint.sh éƒ¨ç½²

**ç†ç”±**ï¼š
1. âœ… å®Œå…¨å…¼å®¹æ–°ä»£ç 
2. âœ… è‡ªåŠ¨åŒ–ç¨‹åº¦é«˜
3. âœ… å®¹å™¨åŒ–å‹å¥½
4. âœ… æ˜“äºç»´æŠ¤
5. âœ… ç¤¾ä¸šçº§è´¨é‡

**ç«‹å³è¡ŒåŠ¨**ï¼š
```bash
# 1. æœ¬åœ°éªŒè¯
./entrypoint.sh development

# 2. æäº¤ä»£ç 
git add entrypoint.sh DEPLOY_WITH_ENTRYPOINT.md
git commit -m "Optimize entrypoint.sh for WebSocket deployment"
git push

# 3. éƒ¨ç½²åˆ° Sealos
# æ ¹æ®ä½ çš„ CI/CD é…ç½®è‡ªåŠ¨æˆ–æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
```

---

## ğŸ’¡ å¸¸è§é—®é¢˜

**Q: WebSocket ä¼šå› ä¸ºå¯åŠ¨è„šæœ¬è€Œä¸å·¥ä½œå—ï¼Ÿ**
A: ä¸ä¼šã€‚WebSocket åœ¨ `server.js` å†…éƒ¨å®ç°ï¼Œä¸å¯åŠ¨è„šæœ¬æ— å…³ã€‚è„šæœ¬åªè´Ÿè´£å¯åŠ¨ `server.js`ã€‚

**Q: æ–°çš„æ•°æ®åº“è¡¨ä¼šè‡ªåŠ¨åˆ›å»ºå—ï¼Ÿ**
A: ä¼šã€‚ä¼˜åŒ–ç‰ˆè„šæœ¬åœ¨ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨è¿è¡Œ `create-schema.js`ã€‚

**Q: å¦‚æœä¾èµ–å¢åŠ äº†æ€ä¹ˆåŠï¼Ÿ**
A: è„šæœ¬è‡ªåŠ¨æ£€æµ‹ `package.json` å˜åŒ–å¹¶è¿è¡Œ `npm install`ã€‚

**Q: æ—§çš„ entrypoint.sh è¿˜èƒ½ç”¨å—ï¼Ÿ**
A: èƒ½ï¼Œä½†ä¸æ¨èã€‚æ–°ç‰ˆæœ¬æ›´å¼ºå¤§ï¼Œå®Œå…¨å‘åå…¼å®¹ã€‚

**Q: éœ€è¦æ”¹å˜ Dockerfile å—ï¼Ÿ**
A: æ¨èæ”¹ä¸ºä½¿ç”¨è„šæœ¬å¯åŠ¨ï¼Œä½†ä¸å¼ºåˆ¶ã€‚å½“å‰æ–¹å¼ä¹Ÿèƒ½å·¥ä½œã€‚

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰æ£€æŸ¥ï¼š

- [ ] entrypoint.sh å·²æ›´æ–°åˆ° v2.0
- [ ] package.json åŒ…å« ws ä¾èµ–
- [ ] create-schema.js å­˜åœ¨
- [ ] server.js åŒ…å« WebSocket ä»£ç 
- [ ] æœ¬åœ°æµ‹è¯•é€šè¿‡ï¼ˆ./entrypoint.sh developmentï¼‰
- [ ] Dockerfile å·²æ›´æ–°ï¼ˆå¯é€‰ä½†æ¨èï¼‰
- [ ] Git ä»“åº“å·²æäº¤
- [ ] Sealos éƒ¨ç½²å·²æ›´æ–°

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. **ç«‹å³ä½¿ç”¨æ–°è„šæœ¬**
   ```bash
   ./entrypoint.sh production
   ```

2. **æ›´æ–° Dockerfile**ï¼ˆå¯é€‰ï¼‰
   å‚è€ƒä¸Šé¢çš„ Dockerfile ç¤ºä¾‹

3. **éƒ¨ç½²åˆ° Sealos**
   æ¨é€ä»£ç ï¼Œè§¦å‘ CI/CD æˆ–æ‰‹åŠ¨æ›´æ–°

4. **éªŒè¯éƒ¨ç½²**
   ```bash
   curl https://xysrxgjnpycd.sealoshzh.site/
   ```

---

**æœ€åæ›´æ–°**: 2025-11-22
**åˆ†æç»“è®º**: âœ… entrypoint.sh å®Œå…¨é€‚åˆæ–°ä»£ç éƒ¨ç½²
**æ¨èè¡ŒåŠ¨**: ç«‹å³ä½¿ç”¨å¹¶éƒ¨ç½²åˆ° Sealos
