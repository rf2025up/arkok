# æ˜Ÿé€”æˆé•¿æ–¹èˆŸÂ·Growark - å®Œæ•´æŠ€æœ¯æ¶æ„æ–‡æ¡£

> **æ–‡æ¡£ç›®çš„ï¼š** æä¾›ç³»ç»Ÿå®Œæ•´çš„æŠ€æœ¯æ¶æ„ã€æ•°æ®æµå‘ã€APIæ¥å£ã€å‰åç«¯å¯¹åº”å…³ç³»ï¼Œç¡®ä¿æ¯æ¬¡éœ€æ±‚ä¿®æ”¹éƒ½æœ‰æ¸…æ™°çš„ä¸Šä¸‹æ–‡å’Œç³»ç»Ÿæ€§æŒ‡å¯¼ã€‚

## ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ€»è§ˆ](#ç³»ç»Ÿæ¶æ„æ€»è§ˆ)
2. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
3. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
4. [APIæ¥å£æ–‡æ¡£](#apiæ¥å£æ–‡æ¡£)
5. [å‰ç«¯æ¶æ„](#å‰ç«¯æ¶æ„)
6. [æ•°æ®æµå‘](#æ•°æ®æµå‘)
7. [å®æ—¶é€šä¿¡æœºåˆ¶](#å®æ—¶é€šä¿¡æœºåˆ¶)
8. [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
9. [å†å²é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å†å²é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)

---

## ç³»ç»Ÿæ¶æ„æ€»è§ˆ

### é¡¹ç›®ç®€ä»‹

æ˜Ÿé€”æˆé•¿æ–¹èˆŸï¼ˆGrowarkï¼‰æ˜¯ä¸€ä¸ªè¯¾å ‚ç®¡ç†ç³»ç»Ÿï¼ŒåŒ…å«ä¸‰ä¸ªä¸»è¦åº”ç”¨ç«¯ï¼š
- **æ•™å¸ˆç«¯/ç®¡ç†ç«¯ï¼ˆAdminï¼‰**ï¼šæ‰‹æœºç«¯åº”ç”¨ï¼Œç”¨äºç­çº§ç®¡ç†ã€å­¦ç”Ÿç®¡ç†ã€ä»»åŠ¡å‘å¸ƒã€æŒ‘æˆ˜åˆ›å»ºç­‰
- **å¤§å±æ˜¾ç¤ºç«¯ï¼ˆScreenï¼‰**ï¼šå¤§å±å±•ç¤ºåº”ç”¨ï¼Œå®æ—¶æ˜¾ç¤ºå­¦ç”Ÿæ’è¡Œæ¦œã€PKå¯¹æˆ˜ã€æŒ‘æˆ˜æ“‚å°ã€è£èª‰å‹‹ç« ç­‰
- **å­¦ç”Ÿç«¯ï¼ˆStudentï¼‰**ï¼šå­¦ç”ŸæŸ¥çœ‹ä¸ªäººä¿¡æ¯å’Œä»»åŠ¡ï¼ˆé¢„ç•™ï¼‰

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Growark ç³»ç»Ÿæ¶æ„                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•™å¸ˆç«¯/ç®¡ç†ç«¯    â”‚         â”‚   åç«¯ API æœåŠ¡   â”‚         â”‚   PostgreSQL     â”‚
â”‚   (Admin)        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   (Node/Express) â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   æ•°æ®åº“          â”‚
â”‚   ç§»åŠ¨ç«¯åº”ç”¨      â”‚  REST   â”‚   + WebSocket    â”‚  SQL    â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   API   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â–²                            â”‚
                                      â”‚                            â”‚
                                      â”‚ HTTP Polling (2s)          â”‚
                                      â”‚ + WebSocket                â”‚
                                      â”‚                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚                            â”‚
â”‚   å¤§å±æ˜¾ç¤ºç«¯      â”‚                  â”‚                            â”‚
â”‚   (Screen)       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚   å®æ—¶å±•ç¤º        â”‚                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
                                                                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚   å­¦ç”Ÿç«¯          â”‚                                               â”‚
â”‚   (Student)      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚   ä¸ªäººä¿¡æ¯æŸ¥çœ‹    â”‚              REST API
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          åŠŸèƒ½æ¨¡å—æ¶æ„                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ•™å¸ˆç«¯ï¼ˆAdminï¼‰                    åç«¯æœåŠ¡                    æ•°æ®åº“è¡¨
â”œâ”€ ç­çº§ç®¡ç†                       â”œâ”€ å­¦ç”Ÿç®¡ç† API              â”œâ”€ students
â”‚  â”œâ”€ å­¦ç”Ÿåˆ—è¡¨                    â”‚  â”œâ”€ GET /api/students     â”‚  â”œâ”€ id, name, score
â”‚  â”œâ”€ å­¦ç”Ÿè¯¦æƒ…                    â”‚  â”œâ”€ POST /api/students    â”‚  â”œâ”€ avatar_url
â”‚  â”œâ”€ ç§¯åˆ†ç®¡ç†                    â”‚  â”œâ”€ PUT /api/students/:id â”‚  â”œâ”€ total_exp, level
â”‚  â””â”€ å‹‹ç« æˆäºˆ                    â”‚  â””â”€ DELETE /api/students  â”‚  â””â”€ team_id, class_name
â”‚                                 â”‚                            â”‚
â”œâ”€ ä»»åŠ¡ç®¡ç†                       â”œâ”€ ä»»åŠ¡ç®¡ç† API              â”œâ”€ tasks
â”‚  â”œâ”€ ä»»åŠ¡å‘å¸ƒ                    â”‚  â”œâ”€ GET /api/tasks        â”‚  â”œâ”€ id, title
â”‚  â”œâ”€ ä»»åŠ¡åˆ†é…                    â”‚  â”œâ”€ POST /api/tasks       â”‚  â”œâ”€ description
â”‚  â””â”€ ä»»åŠ¡å®Œæˆ                    â”‚  â””â”€ DELETE /api/tasks/:id â”‚  â””â”€ exp_value
â”‚                                 â”‚                            â”‚
â”‚                                 â”‚                            â”œâ”€ task_assignments
â”‚                                 â”‚                            â”‚  â”œâ”€ task_id
â”‚                                 â”‚                            â”‚  â””â”€ student_id
â”‚                                 â”‚                            â”‚
â”œâ”€ æŒ‘æˆ˜ç®¡ç†                       â”œâ”€ æŒ‘æˆ˜ç®¡ç† API              â”œâ”€ challenges
â”‚  â”œâ”€ æŒ‘æˆ˜å‘å¸ƒ                    â”‚  â”œâ”€ GET /api/challenges   â”‚  â”œâ”€ id, title
â”‚  â”œâ”€ æŒ‘æˆ˜äººé€‰æ‹©                  â”‚  â”œâ”€ POST /api/challenges  â”‚  â”œâ”€ challenger_id
â”‚  â””â”€ æŒ‘æˆ˜ç»“æœ                    â”‚  â””â”€ PUT /api/challenges   â”‚  â”œâ”€ reward_points
â”‚                                 â”‚                            â”‚  â””â”€ status, result
â”‚                                 â”‚                            â”‚
â”‚                                 â”‚                            â”œâ”€ challenge_participants
â”‚                                 â”‚                            â”‚  â”œâ”€ challenge_id
â”‚                                 â”‚                            â”‚  â””â”€ student_id
â”‚                                 â”‚                            â”‚
â”œâ”€ PKç®¡ç†                         â”œâ”€ PKç®¡ç† API                â”œâ”€ pk_matches
â”‚  â”œâ”€ PKåˆ›å»º                      â”‚  â”œâ”€ GET /api/pk-matches   â”‚  â”œâ”€ id
â”‚  â”œâ”€ PKå¯¹æˆ˜                      â”‚  â”œâ”€ POST /api/pk-matches  â”‚  â”œâ”€ student_a_id
â”‚  â””â”€ PKç»“æœ                      â”‚  â””â”€ PUT /api/pk-matches   â”‚  â”œâ”€ student_b_id
â”‚                                 â”‚                            â”‚  â”œâ”€ topic
â”‚                                 â”‚                            â”‚  â”œâ”€ status
â”‚                                 â”‚                            â”‚  â””â”€ winner_id
â”‚                                 â”‚                            â”‚
â”œâ”€ ä¹ æƒ¯æ‰“å¡                       â”œâ”€ ä¹ æƒ¯ç®¡ç† API              â”œâ”€ habits
â”‚  â”œâ”€ ä¹ æƒ¯åˆ›å»º                    â”‚  â”œâ”€ GET /api/habits       â”‚  â”œâ”€ id, name
â”‚  â”œâ”€ æ‰“å¡è®°å½•                    â”‚  â”œâ”€ POST /api/habits      â”‚  â””â”€ icon, points
â”‚  â””â”€ æ‰“å¡ç»Ÿè®¡                    â”‚  â””â”€ POST /api/habit-check â”‚
â”‚                                 â”‚                            â”œâ”€ habit_checkins
â”‚                                 â”‚                            â”‚  â”œâ”€ habit_id
â”‚                                 â”‚                            â”‚  â”œâ”€ student_id
â”‚                                 â”‚                            â”‚  â””â”€ checked_at
â”‚                                 â”‚                            â”‚
â””â”€ å‹‹ç« ç®¡ç†                       â”œâ”€ å‹‹ç« ç®¡ç† API              â”œâ”€ badges
   â”œâ”€ å‹‹ç« å®šä¹‰                    â”‚  â”œâ”€ GET /api/badges       â”‚  â”œâ”€ id, name
   â””â”€ å‹‹ç« æˆäºˆ                    â”‚  â””â”€ POST /api/award-badge â”‚  â”œâ”€ icon
                                  â”‚                            â”‚  â””â”€ description
                                  â”‚                            â”‚
                                  â”‚                            â”œâ”€ student_badges
                                  â”‚                            â”‚  â”œâ”€ student_id
                                  â”‚                            â”‚  â”œâ”€ badge_id
                                  â”‚                            â”‚  â””â”€ awarded_at
                                  â”‚                            â”‚
å¤§å±ç«¯ï¼ˆScreenï¼‰                  â”œâ”€ WebSocket äº‹ä»¶            â”œâ”€ teams
â”œâ”€ å­¦ç”Ÿæ’è¡Œæ¦œ                     â”‚  â”œâ”€ student:updated       â”‚  â”œâ”€ id, name
â”œâ”€ PKå¯¹æˆ˜æ¦œ                       â”‚  â”œâ”€ challenge:created     â”‚  â”œâ”€ color
â”œâ”€ æŒ‘æˆ˜æ“‚å°                       â”‚  â”œâ”€ pk:created            â”‚  â””â”€ text_color
â”œâ”€ è£èª‰å‹‹ç«                        â”‚  â””â”€ badge:awarded         â”‚
â””â”€ å®æ—¶æ›´æ–°                       â”‚                            â”œâ”€ groups
   (HTTPè½®è¯¢ 2s)                  â”‚                            â”‚  â”œâ”€ id, name
                                  â”‚                            â”‚  â””â”€ display_order
                                  â”‚                            â”‚
                                  â”‚                            â”œâ”€ score_history
                                  â”‚                            â”‚  â”œâ”€ student_id
                                  â”‚                            â”‚  â”œâ”€ points_change
                                  â”‚                            â”‚  â””â”€ reason
```

---

## æŠ€æœ¯æ ˆ

### åç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Node.js | 18+ | è¿è¡Œæ—¶ç¯å¢ƒ |
| Express | 5.1.0 | Webæ¡†æ¶ |
| PostgreSQL | 14+ | å…³ç³»å‹æ•°æ®åº“ |
| pg | 8.16.3 | PostgreSQLå®¢æˆ·ç«¯ |
| ws | 8.18.3 | WebSocketæœåŠ¡ |
| dotenv | 17.2.3 | ç¯å¢ƒå˜é‡ç®¡ç† |
| cors | 2.8.5 | è·¨åŸŸèµ„æºå…±äº« |
| body-parser | 2.2.0 | è¯·æ±‚ä½“è§£æ |

### å‰ç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| React | 18+ | UIæ¡†æ¶ |
| TypeScript | 5+ | ç±»å‹ç³»ç»Ÿ |
| Vite | 5+ | æ„å»ºå·¥å…· |
| Tailwind CSS | 3+ | CSSæ¡†æ¶ |
| React Router | 6+ | è·¯ç”±ç®¡ç† |

### éƒ¨ç½²ç¯å¢ƒ

| ç»„ä»¶ | ç¯å¢ƒ | è¯´æ˜ |
|------|------|------|
| åº”ç”¨æœåŠ¡å™¨ | Sealos/Devbox | å®¹å™¨åŒ–éƒ¨ç½² |
| æ•°æ®åº“ | Neon PostgreSQL | äº‘æ•°æ®åº“æœåŠ¡ |
| é™æ€èµ„æº | Express Static | é™æ€æ–‡ä»¶æœåŠ¡ |
| åå‘ä»£ç† | Sealos Gateway | å†…ç½‘ç©¿é€å’ŒHTTPS |

---

## æ•°æ®åº“è®¾è®¡

### ER å›¾æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   teams     â”‚         â”‚  students   â”‚         â”‚   groups    â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK)     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚ id (PK)     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ id (PK)     â”‚
â”‚ name        â”‚         â”‚ name        â”‚         â”‚ name        â”‚
â”‚ color       â”‚         â”‚ score       â”‚         â”‚ display_ord â”‚
â”‚ text_color  â”‚         â”‚ avatar_url  â”‚         â”‚ color       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ total_exp   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ level       â”‚
                        â”‚ team_id(FK) â”‚
                        â”‚ group_id(FK)â”‚
                        â”‚ class_name  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
        â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚student_badgesâ”‚      â”‚task_assign  â”‚       â”‚challenge_   â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚participants â”‚
â”‚ student_id  â”‚       â”‚ task_id(FK) â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ badge_id(FK)â”‚       â”‚ student_id  â”‚       â”‚challenge_id â”‚
â”‚ awarded_at  â”‚       â”‚ assigned_at â”‚       â”‚ student_id  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚                     â”‚
        â”‚                     â”‚                     â”‚
        â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   badges    â”‚       â”‚    tasks    â”‚       â”‚ challenges  â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK)     â”‚       â”‚ id (PK)     â”‚       â”‚ id (PK)     â”‚
â”‚ name        â”‚       â”‚ title       â”‚       â”‚ title       â”‚
â”‚ icon        â”‚       â”‚ description â”‚       â”‚ description â”‚
â”‚ description â”‚       â”‚ exp_value   â”‚       â”‚ challenger  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ status      â”‚       â”‚ reward_pts  â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ reward_exp  â”‚
                                            â”‚ status      â”‚
                                            â”‚ result      â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pk_matches  â”‚       â”‚   habits    â”‚       â”‚habit_checkinâ”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK)     â”‚       â”‚ id (PK)     â”‚       â”‚ habit_id(FK)â”‚
â”‚ student_a_idâ”‚       â”‚ name        â”‚       â”‚ student_id  â”‚
â”‚ student_b_idâ”‚       â”‚ icon        â”‚       â”‚ checked_at  â”‚
â”‚ topic       â”‚       â”‚ points      â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ status      â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ winner_id   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚score_historyâ”‚
                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
                      â”‚ student_id  â”‚
                      â”‚ points_chg  â”‚
                      â”‚ reason      â”‚
                      â”‚ created_at  â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæ•°æ®è¡¨è¯¦è§£

#### 1. students è¡¨ï¼ˆå­¦ç”Ÿä¿¡æ¯ï¼‰

```sql
CREATE TABLE students (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL UNIQUE,
  score INTEGER DEFAULT 0,                    -- å½“å‰ç§¯åˆ†
  avatar_url VARCHAR(500),                    -- å¤´åƒURL
  total_exp INTEGER DEFAULT 0,                -- æ€»ç»éªŒå€¼
  level INTEGER DEFAULT 1,                    -- ç­‰çº§
  team_id INTEGER REFERENCES teams(id),       -- æ‰€å±é˜Ÿä¼
  group_id INTEGER REFERENCES groups(id),     -- æ‰€å±å°ç»„
  class_name VARCHAR(50),                     -- ç­çº§åç§°
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**å­—æ®µè¯´æ˜ï¼š**
- `score`: å­¦ç”Ÿå½“å‰ç§¯åˆ†ï¼Œç”¨äºæ’è¡Œæ¦œæ’åº
- `total_exp`: ç´¯è®¡ç»éªŒå€¼ï¼Œç”¨äºç­‰çº§è®¡ç®—
- `level`: å­¦ç”Ÿç­‰çº§ï¼Œæ ¹æ®ç»éªŒå€¼è‡ªåŠ¨è®¡ç®—
- `team_id`: é˜Ÿä¼IDï¼Œç”¨äºå›¢é˜ŸPKå’Œæ’è¡Œ
- `group_id`: å°ç»„IDï¼Œç”¨äºå°ç»„ç®¡ç†
- `class_name`: ç­çº§åç§°ï¼Œæ”¯æŒå¤šç­çº§ç®¡ç†

**APIè¿”å›æ ¼å¼ï¼š**
```json
{
  "id": 16,
  "name": "å´é€¸æ¡",
  "score": 150,
  "avatar_url": "https://api.dicebear.com/7.x/avataaars/svg?seed=å´é€¸æ¡",
  "total_exp": 500,
  "level": 3,
  "team_id": 1,
  "class_name": "ä¸€å¹´çº§1ç­",
  "badges": [
    {
      "id": 1,
      "name": "å­¦éœ¸ä¹‹æ˜Ÿ",
      "icon": "â­",
      "awarded_at": "2025-11-26T10:30:00Z"
    }
  ]
}
```

#### 2. tasks è¡¨ï¼ˆä»»åŠ¡ï¼‰

```sql
CREATE TABLE tasks (
  id SERIAL PRIMARY KEY,
  title VARCHAR(200) NOT NULL,
  description TEXT,
  exp_value INTEGER DEFAULT 0,                -- ç»éªŒå€¼å¥–åŠ±
  status VARCHAR(20) DEFAULT 'active',        -- active, completed, deleted
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**å…³è”è¡¨ï¼štask_assignmentsï¼ˆä»»åŠ¡åˆ†é…ï¼‰**
```sql
CREATE TABLE task_assignments (
  id SERIAL PRIMARY KEY,
  task_id INTEGER NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
  student_id INTEGER NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(task_id, student_id)
);
```

**æ•°æ®æµç¨‹ï¼š**
1. æ•™å¸ˆç«¯åˆ›å»ºä»»åŠ¡ â†’ `tasks` è¡¨
2. é€‰æ‹©æ‰§è¡Œäºº â†’ `task_assignments` è¡¨
3. GET /api/tasks è¿”å›ä»»åŠ¡åŠæ‰§è¡Œäººåˆ—è¡¨
4. å­¦ç”Ÿä¸ªäººä¿¡æ¯é¡µæ˜¾ç¤ºä»»åŠ¡è®°å½•

**APIè¿”å›æ ¼å¼ï¼š**
```json
{
  "id": 1,
  "title": "å®Œæˆæ•°å­¦ä½œä¸š",
  "description": "ç¬¬3ç« ç»ƒä¹ é¢˜",
  "exp_value": 50,
  "assigned_to": [
    {
      "student_id": 16,
      "student_name": "å´é€¸æ¡",
      "student_avatar": "https://..."
    }
  ]
}
```

#### 3. challenges è¡¨ï¼ˆæŒ‘æˆ˜ï¼‰

```sql
CREATE TABLE challenges (
  id SERIAL PRIMARY KEY,
  title VARCHAR(200) NOT NULL,
  description TEXT,
  status VARCHAR(20) DEFAULT 'active',        -- active, completed
  result VARCHAR(20),                         -- success, fail
  challenger_id INTEGER REFERENCES students(id),  -- æŒ‘æˆ˜è€…
  reward_points INTEGER DEFAULT 0,
  reward_exp INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**å…³è”è¡¨ï¼šchallenge_participantsï¼ˆæŒ‘æˆ˜å‚ä¸è€…ï¼‰**
```sql
CREATE TABLE challenge_participants (
  id SERIAL PRIMARY KEY,
  challenge_id INTEGER NOT NULL REFERENCES challenges(id) ON DELETE CASCADE,
  student_id INTEGER NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(challenge_id, student_id)
);
```

**æ•°æ®æµç¨‹ï¼š**
1. æ•™å¸ˆç«¯åˆ›å»ºæŒ‘æˆ˜ â†’ `challenges` è¡¨ï¼ˆåŒ…å« `challenger_id`ï¼‰
2. é€‰æ‹©å‚ä¸è€… â†’ `challenge_participants` è¡¨
3. GET /api/challenges JOIN students è¿”å›æŒ‘æˆ˜è€…ä¿¡æ¯
4. å¤§å±ç«¯æ˜¾ç¤ºæŒ‘æˆ˜è€…åç§°å’Œå¤´åƒ

**APIè¿”å›æ ¼å¼ï¼š**
```json
{
  "id": 1,
  "title": "èƒŒå¤è¯—æŒ‘æˆ˜",
  "description": "èƒŒè¯µã€Šé™å¤œæ€ã€‹",
  "status": "active",
  "result": null,
  "challenger_id": 16,
  "challenger_name": "å´é€¸æ¡",
  "challenger_avatar": "https://...",
  "reward_points": 20,
  "reward_exp": 10,
  "participants": [
    {"student_id": 16},
    {"student_id": 17}
  ]
}
```

#### 4. pk_matches è¡¨ï¼ˆPKå¯¹æˆ˜ï¼‰

```sql
CREATE TABLE pk_matches (
  id SERIAL PRIMARY KEY,
  student_a_id INTEGER NOT NULL REFERENCES students(id),
  student_b_id INTEGER NOT NULL REFERENCES students(id),
  topic VARCHAR(200),                         -- PKä¸»é¢˜
  status VARCHAR(20) DEFAULT 'pending',       -- pending, finished
  winner_id INTEGER REFERENCES students(id),  -- è·èƒœè€…
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**æ•°æ®æµç¨‹ï¼š**
1. æ•™å¸ˆç«¯åˆ›å»ºPK â†’ `pk_matches` è¡¨
2. å¤§å±ç«¯æŒ‰ç§¯åˆ†æ’åºç”ŸæˆPKé…å¯¹
3. æ•™å¸ˆç«¯è®¾ç½®PKç»“æœ â†’ æ›´æ–° `winner_id`
4. å­¦ç”Ÿä¸ªäººä¿¡æ¯é¡µæ˜¾ç¤ºPKå†å²

**APIè¿”å›æ ¼å¼ï¼š**
```json
{
  "id": 1,
  "student_a_id": 16,
  "student_b_id": 17,
  "topic": "é€Ÿç®—æ¯”èµ›",
  "status": "finished",
  "winner_id": 16,
  "created_at": "2025-11-26T10:00:00Z"
}
```

#### 5. badges è¡¨ï¼ˆå‹‹ç« å®šä¹‰ï¼‰

```sql
CREATE TABLE badges (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL UNIQUE,
  icon VARCHAR(10),                           -- emojiå›¾æ ‡
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**å…³è”è¡¨ï¼šstudent_badgesï¼ˆå‹‹ç« æˆäºˆè®°å½•ï¼‰**
```sql
CREATE TABLE student_badges (
  id SERIAL PRIMARY KEY,
  student_id INTEGER NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  badge_id INTEGER NOT NULL REFERENCES badges(id) ON DELETE CASCADE,
  awarded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(student_id, badge_id)
);
```

**æ•°æ®æµç¨‹ï¼š**
1. ç³»ç»Ÿé¢„å®šä¹‰å‹‹ç«  â†’ `badges` è¡¨
2. æ•™å¸ˆç«¯æˆäºˆå‹‹ç«  â†’ `student_badges` è¡¨
3. GET /api/students è¿”å›å­¦ç”ŸåŠå…¶å‹‹ç« åˆ—è¡¨
4. å¤§å±ç«¯å’Œä¸ªäººä¿¡æ¯é¡µæ˜¾ç¤ºå‹‹ç« 

**APIè¿”å›æ ¼å¼ï¼š**
```json
{
  "id": 1,
  "name": "å­¦éœ¸ä¹‹æ˜Ÿ",
  "icon": "â­",
  "description": "å­¦ä¹ è¡¨ç°çªå‡º",
  "awarded_at": "2025-11-26T10:30:00Z"
}
```

#### 6. habits è¡¨ï¼ˆä¹ æƒ¯ï¼‰

```sql
CREATE TABLE habits (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  icon VARCHAR(10),
  points INTEGER DEFAULT 1,                   -- æ‰“å¡å¥–åŠ±ç§¯åˆ†
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**å…³è”è¡¨ï¼šhabit_checkinsï¼ˆæ‰“å¡è®°å½•ï¼‰**
```sql
CREATE TABLE habit_checkins (
  id SERIAL PRIMARY KEY,
  habit_id INTEGER NOT NULL REFERENCES habits(id) ON DELETE CASCADE,
  student_id INTEGER NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  checked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(habit_id, student_id, DATE(checked_at))  -- æ¯å¤©åªèƒ½æ‰“å¡ä¸€æ¬¡
);
```

#### 7. score_history è¡¨ï¼ˆç§¯åˆ†å†å²ï¼‰

```sql
CREATE TABLE score_history (
  id SERIAL PRIMARY KEY,
  student_id INTEGER NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  points_change INTEGER NOT NULL,             -- ç§¯åˆ†å˜åŒ–ï¼ˆæ­£æ•°æˆ–è´Ÿæ•°ï¼‰
  reason VARCHAR(200),                        -- å˜åŒ–åŸå› 
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**ç”¨é€”ï¼š**
- è®°å½•æ‰€æœ‰ç§¯åˆ†å˜åŒ–
- ç”¨äºç§¯åˆ†å†å²æŸ¥è¯¢å’Œç»Ÿè®¡
- æ”¯æŒç§¯åˆ†å›æº¯å’Œå®¡è®¡

---

## ç³»ç»Ÿæ¶æ„

### é¡¹ç›®ç®€ä»‹

æ˜Ÿé€”æˆé•¿æ–¹èˆŸæ˜¯ä¸€ä¸ªè¯¾å ‚ç®¡ç†ç³»ç»Ÿï¼ŒåŒ…å«æ•™å¸ˆç«¯ï¼ˆClassHeroï¼‰å’Œå¤§å±æ˜¾ç¤ºç«¯ï¼ˆBigscreenï¼‰ä¸¤ä¸ªåº”ç”¨ã€‚ç³»ç»Ÿé€šè¿‡å®æ—¶æ•°æ®åŒæ­¥å°†æ•™å¸ˆç«¯çš„å­¦ç”Ÿç§¯åˆ†æ›´æ–°è‡ªåŠ¨åæ˜ åœ¨å¤§å±æ˜¾ç¤ºä¸Šã€‚

### é€šä¿¡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Teacher App    â”‚         â”‚   API Server     â”‚         â”‚   Database   â”‚
â”‚  (ClassHero)    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  (Node/Express)  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ (PostgreSQL) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â–²
                                    â”‚
                                    â”‚ HTTP Polling (2s)
                                    â”‚
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  Bigscreen App   â”‚
                            â”‚  (Display)       â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## APIæ¥å£æ–‡æ¡£

### APIåŸºç¡€ä¿¡æ¯

- **Base URL**: `http://localhost:3000/api` (å¼€å‘ç¯å¢ƒ)
- **ç”Ÿäº§URL**: `https://esboimzbkure.sealosbja.site/api`
- **è®¤è¯æ–¹å¼**: æš‚æ— ï¼ˆå†…éƒ¨ç³»ç»Ÿï¼‰
- **æ•°æ®æ ¼å¼**: JSON
- **å­—ç¬¦ç¼–ç **: UTF-8

### ç»Ÿä¸€å“åº”æ ¼å¼

```json
{
  "success": true,
  "data": {},
  "timestamp": "2025-11-26T10:00:00Z"
}
```

### å­¦ç”Ÿç®¡ç† API

#### GET /api/students
è·å–æ‰€æœ‰å­¦ç”Ÿåˆ—è¡¨ï¼ˆåŒ…å«å‹‹ç« ä¿¡æ¯ï¼‰

**è¯·æ±‚å‚æ•°ï¼š** æ— 

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": [
    {
      "id": 16,
      "name": "å´é€¸æ¡",
      "score": 150,
      "avatar_url": "https://api.dicebear.com/7.x/avataaars/svg?seed=å´é€¸æ¡",
      "total_exp": 500,
      "level": 3,
      "team_id": 1,
      "class_name": "ä¸€å¹´çº§1ç­",
      "badges": [
        {
          "id": 1,
          "name": "å­¦éœ¸ä¹‹æ˜Ÿ",
          "icon": "â­",
          "awarded_at": "2025-11-26T10:30:00Z"
        }
      ]
    }
  ]
}
```

**SQLæŸ¥è¯¢ï¼š**
```sql
SELECT
  s.*,
  COALESCE(
    json_agg(
      json_build_object(
        'id', b.id,
        'name', b.name,
        'icon', b.icon,
        'awarded_at', sb.awarded_at
      )
    ) FILTER (WHERE b.id IS NOT NULL),
    '[]'
  ) as badges
FROM students s
LEFT JOIN student_badges sb ON s.id = sb.student_id
LEFT JOIN badges b ON sb.badge_id = b.id
GROUP BY s.id
ORDER BY s.score DESC
```

#### POST /api/students
åˆ›å»ºæ–°å­¦ç”Ÿ

**è¯·æ±‚ä½“ï¼š**
```json
{
  "name": "å¼ ä¸‰",
  "avatar_url": "https://...",
  "team_id": 1,
  "class_name": "ä¸€å¹´çº§1ç­"
}
```

#### PUT /api/students/:id
æ›´æ–°å­¦ç”Ÿä¿¡æ¯ï¼ˆåŒ…æ‹¬ç§¯åˆ†ï¼‰

**è¯·æ±‚ä½“ï¼š**
```json
{
  "score": 160,
  "total_exp": 520
}
```

**å‰¯ä½œç”¨ï¼š**
- è‡ªåŠ¨è®°å½•ç§¯åˆ†å˜åŒ–åˆ° `score_history` è¡¨
- è§¦å‘ WebSocket äº‹ä»¶ `student:updated`

#### DELETE /api/students/:id
åˆ é™¤å­¦ç”Ÿ

**çº§è”åˆ é™¤ï¼š**
- `student_badges` è®°å½•
- `task_assignments` è®°å½•
- `challenge_participants` è®°å½•
- `habit_checkins` è®°å½•
- `score_history` è®°å½•

### ä»»åŠ¡ç®¡ç† API

#### GET /api/tasks
è·å–æ‰€æœ‰ä»»åŠ¡ï¼ˆåŒ…å«æ‰§è¡Œäººä¿¡æ¯ï¼‰

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "title": "å®Œæˆæ•°å­¦ä½œä¸š",
      "description": "ç¬¬3ç« ç»ƒä¹ é¢˜",
      "exp_value": 50,
      "assigned_to": [
        {
          "student_id": 16,
          "student_name": "å´é€¸æ¡",
          "student_avatar": "https://..."
        }
      ]
    }
  ]
}
```

**SQLæŸ¥è¯¢ï¼š**
```sql
SELECT
  t.id,
  t.title,
  t.description,
  t.exp_value,
  COALESCE(
    json_agg(
      json_build_object(
        'student_id', ta.student_id,
        'student_name', s.name,
        'student_avatar', s.avatar_url
      )
    ) FILTER (WHERE ta.student_id IS NOT NULL),
    '[]'
  ) as assigned_to
FROM tasks t
LEFT JOIN task_assignments ta ON t.id = ta.task_id
LEFT JOIN students s ON ta.student_id = s.id
GROUP BY t.id
ORDER BY t.id DESC
```

#### POST /api/tasks
åˆ›å»ºæ–°ä»»åŠ¡

**è¯·æ±‚ä½“ï¼š**
```json
{
  "title": "å®Œæˆæ•°å­¦ä½œä¸š",
  "description": "ç¬¬3ç« ç»ƒä¹ é¢˜",
  "exp_value": 50,
  "assigned_to": [16, 17]  // å­¦ç”ŸIDæ•°ç»„
}
```

**å¤„ç†æµç¨‹ï¼š**
1. æ’å…¥ä»»åŠ¡åˆ° `tasks` è¡¨
2. ä¸ºæ¯ä¸ªå­¦ç”Ÿæ’å…¥è®°å½•åˆ° `task_assignments` è¡¨
3. è¿”å›å®Œæ•´ä»»åŠ¡ä¿¡æ¯ï¼ˆåŒ…å«æ‰§è¡Œäººï¼‰

#### DELETE /api/tasks/:id
åˆ é™¤ä»»åŠ¡

**çº§è”åˆ é™¤ï¼š**
- `task_assignments` è®°å½•è‡ªåŠ¨åˆ é™¤ï¼ˆON DELETE CASCADEï¼‰

### æŒ‘æˆ˜ç®¡ç† API

#### GET /api/challenges
è·å–æ‰€æœ‰æŒ‘æˆ˜ï¼ˆåŒ…å«æŒ‘æˆ˜è€…å’Œå‚ä¸è€…ä¿¡æ¯ï¼‰

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "title": "èƒŒå¤è¯—æŒ‘æˆ˜",
      "description": "èƒŒè¯µã€Šé™å¤œæ€ã€‹",
      "status": "active",
      "result": null,
      "challenger_id": 16,
      "challenger_name": "å´é€¸æ¡",
      "challenger_avatar": "https://...",
      "reward_points": 20,
      "reward_exp": 10,
      "participants": [
        {"student_id": 16},
        {"student_id": 17}
      ]
    }
  ]
}
```

**SQLæŸ¥è¯¢ï¼š**
```sql
SELECT
  c.id,
  c.title,
  c.description,
  c.status,
  c.result,
  c.reward_points,
  c.reward_exp,
  c.challenger_id,
  s.name as challenger_name,
  s.avatar_url as challenger_avatar,
  COALESCE(
    json_agg(
      json_build_object('student_id', cp.student_id)
    ) FILTER (WHERE cp.student_id IS NOT NULL),
    '[]'
  ) as participants
FROM challenges c
LEFT JOIN students s ON c.challenger_id = s.id
LEFT JOIN challenge_participants cp ON c.id = cp.challenge_id
GROUP BY c.id, s.name, s.avatar_url
ORDER BY c.created_at DESC
```

#### POST /api/challenges
åˆ›å»ºæ–°æŒ‘æˆ˜

**è¯·æ±‚ä½“ï¼š**
```json
{
  "title": "èƒŒå¤è¯—æŒ‘æˆ˜",
  "description": "èƒŒè¯µã€Šé™å¤œæ€ã€‹",
  "status": "active",
  "reward_points": 20,
  "reward_exp": 10,
  "challenger_id": 16,
  "participant_ids": [16, 17]
}
```

**å¤„ç†æµç¨‹ï¼š**
1. æ’å…¥æŒ‘æˆ˜åˆ° `challenges` è¡¨ï¼ˆåŒ…å« `challenger_id`ï¼‰
2. ä¸ºæ¯ä¸ªå‚ä¸è€…æ’å…¥è®°å½•åˆ° `challenge_participants` è¡¨
3. æŸ¥è¯¢å®Œæ•´æŒ‘æˆ˜ä¿¡æ¯ï¼ˆJOIN students è·å–æŒ‘æˆ˜è€…ä¿¡æ¯ï¼‰
4. è§¦å‘ WebSocket äº‹ä»¶ `challenge:created`
5. è¿”å›å®Œæ•´æŒ‘æˆ˜ä¿¡æ¯

#### PUT /api/challenges/:id
æ›´æ–°æŒ‘æˆ˜çŠ¶æ€å’Œç»“æœ

**è¯·æ±‚ä½“ï¼š**
```json
{
  "status": "completed",
  "result": "success"
}
```

### PKç®¡ç† API

#### GET /api/pk-matches
è·å–æ‰€æœ‰PKè®°å½•

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "student_a_id": 16,
      "student_b_id": 17,
      "topic": "é€Ÿç®—æ¯”èµ›",
      "status": "finished",
      "winner_id": 16,
      "created_at": "2025-11-26T10:00:00Z"
    }
  ]
}
```

#### POST /api/pk-matches
åˆ›å»ºæ–°PK

**è¯·æ±‚ä½“ï¼š**
```json
{
  "student_a_id": 16,
  "student_b_id": 17,
  "topic": "é€Ÿç®—æ¯”èµ›"
}
```

#### PUT /api/pk-matches/:id
æ›´æ–°PKç»“æœ

**è¯·æ±‚ä½“ï¼š**
```json
{
  "status": "finished",
  "winner_id": 16
}
```

### å‹‹ç« ç®¡ç† API

#### GET /api/badges
è·å–æ‰€æœ‰å‹‹ç« å®šä¹‰

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "å­¦éœ¸ä¹‹æ˜Ÿ",
      "icon": "â­",
      "description": "å­¦ä¹ è¡¨ç°çªå‡º"
    }
  ]
}
```

#### POST /api/award-badge
æˆäºˆå‹‹ç« ç»™å­¦ç”Ÿ

**è¯·æ±‚ä½“ï¼š**
```json
{
  "student_id": 16,
  "badge_id": 1
}
```

**å¤„ç†æµç¨‹ï¼š**
1. æ’å…¥è®°å½•åˆ° `student_badges` è¡¨
2. è§¦å‘ WebSocket äº‹ä»¶ `badge:awarded`
3. è¿”å›æˆäºˆç»“æœ

### ä¹ æƒ¯ç®¡ç† API

#### GET /api/habits
è·å–æ‰€æœ‰ä¹ æƒ¯

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "æ—©ç¡æ—©èµ·",
      "icon": "ğŸŒ™",
      "points": 5
    }
  ]
}
```

#### POST /api/habit-checkin
ä¹ æƒ¯æ‰“å¡

**è¯·æ±‚ä½“ï¼š**
```json
{
  "habit_id": 1,
  "student_ids": [16, 17]
}
```

**å¤„ç†æµç¨‹ï¼š**
1. ä¸ºæ¯ä¸ªå­¦ç”Ÿæ’å…¥æ‰“å¡è®°å½•åˆ° `habit_checkins` è¡¨
2. æ›´æ–°å­¦ç”Ÿç§¯åˆ†ï¼ˆå¢åŠ  `habit.points`ï¼‰
3. è®°å½•ç§¯åˆ†å˜åŒ–åˆ° `score_history` è¡¨
4. è§¦å‘ WebSocket äº‹ä»¶ `student:updated`

### é˜Ÿä¼ç®¡ç† API

#### GET /api/teams
è·å–æ‰€æœ‰é˜Ÿä¼

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "æ–°æ˜Ÿå‰é”‹",
      "color": "bg-cyan-500",
      "text_color": "text-cyan-400"
    }
  ]
}
```

---

## å‰ç«¯æ¶æ„

### é¡¹ç›®ç»“æ„

```
mobile/                          # å‰ç«¯é¡¹ç›®æ ¹ç›®å½•
â”œâ”€â”€ App.tsx                      # ä¸»åº”ç”¨å…¥å£ï¼ˆæ•™å¸ˆç«¯ï¼‰
â”œâ”€â”€ index.tsx                    # Reactå…¥å£
â”œâ”€â”€ types.ts                     # TypeScriptç±»å‹å®šä¹‰
â”œâ”€â”€ constants.ts                 # å¸¸é‡å®šä¹‰
â”œâ”€â”€ pages/                       # é¡µé¢ç»„ä»¶
â”‚   â”œâ”€â”€ ClassManage.tsx          # ç­çº§ç®¡ç†é¡µï¼ˆæ ¸å¿ƒé¡µé¢ï¼‰
â”‚   â”œâ”€â”€ Habits.tsx               # ä¹ æƒ¯æ‰“å¡é¡µ
â”‚   â””â”€â”€ ...
â”œâ”€â”€ components/                  # é€šç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ StudentCard.tsx          # å­¦ç”Ÿå¡ç‰‡
â”‚   â””â”€â”€ ...
â”œâ”€â”€ services/                    # APIæœåŠ¡å±‚
â”‚   â””â”€â”€ api.ts                   # APIè¯·æ±‚å°è£…
â”œâ”€â”€ bigscreen/                   # å¤§å±ç«¯åº”ç”¨
â”‚   â”œâ”€â”€ main.tsx                 # å¤§å±ç«¯å…¥å£
â”‚   â”œâ”€â”€ components/              # å¤§å±ç«¯ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ PKBoardCard.tsx      # PKæ¦œå•å¡ç‰‡
â”‚   â”‚   â”œâ”€â”€ ChallengeArenaCard.tsx  # æŒ‘æˆ˜æ“‚å°å¡ç‰‡
â”‚   â”‚   â”œâ”€â”€ HonorBadgesCard.tsx  # è£èª‰å‹‹ç« å¡ç‰‡
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ services/                # å¤§å±ç«¯æœåŠ¡
â”‚   â”‚   â””â”€â”€ sealosService.ts     # APIå’ŒWebSocketæœåŠ¡
â”‚   â””â”€â”€ types.ts                 # å¤§å±ç«¯ç±»å‹å®šä¹‰
â”œâ”€â”€ dist/                        # æ„å»ºäº§ç‰©
â””â”€â”€ vite.config.ts               # Viteé…ç½®
```

### æ ¸å¿ƒç±»å‹å®šä¹‰

#### mobile/types.ts

```typescript
// å­¦ç”Ÿç±»å‹
export interface Student {
  id: string;
  name: string;
  score: number;
  avatar?: string;
  totalExp?: number;
  level?: number;
  teamId?: string;
  groupId?: string;
  className?: string;
  badges?: Array<{
    id: number;
    name: string;
    icon: string;
    awarded_at: string;
  }>;
  badgeHistory?: StudentBadgeRecord[];
  taskHistory?: StudentTaskRecord[];
  challengeHistory?: StudentChallengeRecord[];
  pkHistory?: StudentPKRecord[];
}

// ä»»åŠ¡ç±»å‹
export interface Task {
  id: string;
  title: string;
  description?: string;
  expValue: number;
  assignedTo: string[];  // å­¦ç”ŸIDæ•°ç»„
  createdAt?: string;
}

// æŒ‘æˆ˜ç±»å‹
export interface Challenge {
  id: string;
  title: string;
  desc: string;
  status: 'active' | 'completed';
  result?: 'success' | 'fail';
  participants: string[];  // å‚ä¸è€…IDæ•°ç»„
  challengerId?: string;   // æŒ‘æˆ˜è€…ID
  challengerName?: string; // æŒ‘æˆ˜è€…å§“å
  challengerAvatar?: string;  // æŒ‘æˆ˜è€…å¤´åƒ
  rewardPoints: number;
  rewardExp?: number;
  date?: string;
}

// PKç±»å‹
export interface PKMatch {
  id: string;
  studentA: string;
  studentB: string;
  topic: string;
  status: 'pending' | 'finished';
  winnerId?: string;
  date?: string;
}

// ä¹ æƒ¯ç±»å‹
export interface Habit {
  id: string;
  name: string;
  icon: string;
  points: number;
}
```

### æ•°æ®æµå‘

#### æ•™å¸ˆç«¯æ•°æ®æµ

```
ç”¨æˆ·æ“ä½œ â†’ ç»„ä»¶äº‹ä»¶ â†’ APIè¯·æ±‚ â†’ åç«¯å¤„ç† â†’ æ•°æ®åº“æ›´æ–°
                                    â†“
                              WebSocketå¹¿æ’­
                                    â†“
                              å¤§å±ç«¯æ¥æ”¶æ›´æ–°
```

**ç¤ºä¾‹ï¼šä¿®æ”¹å­¦ç”Ÿç§¯åˆ†**

```typescript
// 1. ç”¨æˆ·åœ¨ClassManage.tsxä¸­ä¿®æ”¹ç§¯åˆ†
const handleScoreChange = async (studentId: string, newScore: number) => {
  // 2. å‘é€APIè¯·æ±‚
  const response = await fetch(`/api/students/${studentId}`, {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ score: newScore })
  });

  // 3. æ›´æ–°æœ¬åœ°çŠ¶æ€
  if (response.ok) {
    setStudents(prev => prev.map(s =>
      s.id === studentId ? {...s, score: newScore} : s
    ));
  }
};

// 4. åç«¯å¤„ç†ï¼ˆserver.jsï¼‰
app.put('/api/students/:id', async (req, res) => {
  const { score } = req.body;

  // æ›´æ–°æ•°æ®åº“
  await pool.query('UPDATE students SET score = $1 WHERE id = $2', [score, id]);

  // å¹¿æ’­WebSocketäº‹ä»¶
  wss.clients.forEach(client => {
    client.send(JSON.stringify({
      type: 'student:updated',
      payload: { id, score }
    }));
  });
});

// 5. å¤§å±ç«¯æ¥æ”¶ï¼ˆbigscreen/main.tsxï¼‰
// é€šè¿‡HTTPè½®è¯¢ï¼ˆæ¯2ç§’ï¼‰è‡ªåŠ¨è·å–æœ€æ–°æ•°æ®
useEffect(() => {
  const pollStudents = async () => {
    const res = await fetch('/api/students');
    const data = await res.json();
    setStudents(data.data);
  };

  const interval = setInterval(pollStudents, 2000);
  return () => clearInterval(interval);
}, []);
```

#### å¤§å±ç«¯æ•°æ®æµ

```
HTTPè½®è¯¢ï¼ˆ2sï¼‰ â†’ GET /api/students â†’ æ•°æ®æ¯”è¾ƒ â†’ çŠ¶æ€æ›´æ–° â†’ UIé‡æ¸²æŸ“
                                         â†“
                                    æ•°æ®æ’åºå’Œè®¡ç®—
                                         â†“
                              ç”ŸæˆPK/æŒ‘æˆ˜/å‹‹ç« æ•°æ®
```

**å…³é”®å®ç°ï¼š**

```typescript
// bigscreen/main.tsx
useEffect(() => {
  let lastData = JSON.stringify([]);

  const pollStudents = async () => {
    const res = await fetch('/api/students');
    const data = await res.json();

    // æ•°æ®å˜åŒ–æ£€æµ‹
    const newData = JSON.stringify(data.data);
    if (lastData !== newData) {
      lastData = newData;
      setStudents(data.data);
    }
  };

  pollStudents();
  const interval = setInterval(pollStudents, 2000);
  return () => clearInterval(interval);
}, []);

// æ ¹æ®å­¦ç”Ÿæ•°æ®ç”ŸæˆPKé…å¯¹
const generatedPks = useMemo(() => {
  // æŒ‰ç§¯åˆ†æ’åº
  const sorted = [...students].sort((a, b) => b.total_points - a.total_points);

  // ç”ŸæˆPKé…å¯¹
  const pks = [];
  for (let i = 0; i < Math.min(6, Math.floor(sorted.length / 2)); i++) {
    pks.push({
      id: `pk-${i}`,
      student_a: sorted[i * 2].id,
      student_b: sorted[i * 2 + 1].id,
      topic: ['èƒŒå¤è¯—', 'é€Ÿç®—', 'è‹±è¯­æ‹¼å†™'][i % 3]
    });
  }
  return pks;
}, [students]);
```

### çŠ¶æ€ç®¡ç†

#### æ•™å¸ˆç«¯çŠ¶æ€ï¼ˆApp.tsxï¼‰

```typescript
const [students, setStudents] = useState<Student[]>([]);
const [tasks, setTasks] = useState<Task[]>([]);
const [challenges, setChallenges] = useState<Challenge[]>([]);
const [pkMatches, setPkMatches] = useState<PKMatch[]>([]);
const [habits, setHabits] = useState<Habit[]>([]);
const [teams, setTeams] = useState<Team[]>([]);

// è‡ªåŠ¨ç”Ÿæˆå­¦ç”Ÿå†å²è®°å½•
useEffect(() => {
  setStudents(prevStudents => prevStudents.map(student => {
    // ç”Ÿæˆä»»åŠ¡å†å²
    const taskHistory = tasks
      .filter(t => t.assignedTo?.includes(student.id))
      .map(t => ({...}));

    // ç”ŸæˆæŒ‘æˆ˜å†å²
    const challengeHistory = challenges
      .filter(c => c.participants.includes(student.id))
      .map(c => ({...}));

    // ç”ŸæˆPKå†å²
    const pkHistory = pkMatches
      .filter(pk => pk.studentA === student.id || pk.studentB === student.id)
      .map(pk => ({...}));

    return { ...student, taskHistory, challengeHistory, pkHistory };
  }));
}, [tasks, challenges, pkMatches]);
```

#### å¤§å±ç«¯çŠ¶æ€ï¼ˆbigscreen/main.tsxï¼‰

```typescript
const [students, setStudents] = useState<Student[]>([]);
const [challenges, setChallenges] = useState<Challenge[]>([]);
const [teams, setTeams] = useState<Team[]>([]);

// è®¡ç®—æ´¾ç”Ÿæ•°æ®
const generatedPks = useMemo(() => {...}, [students]);
const generatedChallenges = useMemo(() => {...}, [students]);
const generatedBadges = useMemo(() => {...}, [students]);
```

---

## å®æ—¶é€šä¿¡æœºåˆ¶

### WebSocketäº‹ä»¶ç±»å‹

| äº‹ä»¶ç±»å‹ | è§¦å‘æ—¶æœº | æ•°æ®æ ¼å¼ |
|---------|---------|---------|
| `student:updated` | å­¦ç”Ÿä¿¡æ¯æ›´æ–° | `{id, name, score, ...}` |
| `challenge:created` | åˆ›å»ºæ–°æŒ‘æˆ˜ | `{id, title, challenger_name, ...}` |
| `pk:created` | åˆ›å»ºæ–°PK | `{id, student_a_id, student_b_id, ...}` |
| `badge:awarded` | æˆäºˆå‹‹ç«  | `{student_id, badge_id, ...}` |

### WebSocketæœåŠ¡ç«¯å®ç°

```javascript
// server.js
const wss = new WebSocket.Server({ server });

// å¹¿æ’­å‡½æ•°
function broadcast(type, payload) {
  wss.clients.forEach(client => {
    if (client.readyState === WebSocket.OPEN) {
      client.send(JSON.stringify({
        type,
        payload,
        timestamp: new Date().toISOString()
      }));
    }
  });
}

// ç¤ºä¾‹ï¼šåˆ›å»ºæŒ‘æˆ˜æ—¶å¹¿æ’­
app.post('/api/challenges', async (req, res) => {
  // ... åˆ›å»ºæŒ‘æˆ˜é€»è¾‘

  broadcast('challenge:created', challengeData);

  res.json({ success: true, data: challengeData });
});
```

### å¤§å±ç«¯HTTPè½®è¯¢æœºåˆ¶

ç”±äºSealosåå‘ä»£ç†ä¸æ”¯æŒWebSocketï¼Œå¤§å±ç«¯ä½¿ç”¨HTTPè½®è¯¢æ›¿ä»£ï¼š

```typescript
// bigscreen/main.tsx
useEffect(() => {
  let lastData = JSON.stringify([]);

  const pollStudents = async () => {
    try {
      const res = await fetch(`${API_BASE_URL}/students`);
      const data = await res.json();

      // ä½¿ç”¨JSONå­—ç¬¦ä¸²æ¯”è¾ƒæ£€æµ‹æ•°æ®å˜åŒ–
      const newData = JSON.stringify(data.data);
      if (lastData !== newData) {
        lastData = newData;
        setStudents(data.data);
        setWsConnected(true);
      }
    } catch (error) {
      console.error('Polling error:', error);
      setWsConnected(false);
    }
  };

  pollStudents();
  const interval = setInterval(pollStudents, 2000);  // 2ç§’è½®è¯¢

  return () => clearInterval(interval);
}, []);
```

**è½®è¯¢å‚æ•°é€‰æ‹©ï¼š**
- **é—´éš”æ—¶é—´**: 2000msï¼ˆ2ç§’ï¼‰
- **é€‰æ‹©åŸå› **:
  - è¶³å¤Ÿé¢‘ç¹ï¼Œç”¨æˆ·æ„ŸçŸ¥å®æ—¶æ€§
  - ä¸ä¼šå¯¹æœåŠ¡å™¨é€ æˆè¿‡è½½
  - å¹³è¡¡æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ

**æ•°æ®å˜åŒ–æ£€æµ‹ï¼š**
- ä½¿ç”¨ `JSON.stringify()` å…¨é‡æ¯”è¾ƒ
- ç®€æ´é«˜æ•ˆï¼Œå‡†ç¡®æ£€æµ‹ä»»ä½•æ•°æ®å˜åŒ–
- æ€§èƒ½å¯æ¥å—ï¼ˆJSON.stringifyå¾ˆå¿«ï¼‰

---

## éƒ¨ç½²æ¶æ„

### æ–‡ä»¶ç»“æ„

```
/home/devbox/project/arkok/
â”œâ”€â”€ server.js                    # åç«¯æœåŠ¡å™¨
â”œâ”€â”€ package.json                 # åç«¯ä¾èµ–
â”œâ”€â”€ .env                         # ç¯å¢ƒå˜é‡
â”œâ”€â”€ entrypoint.sh                # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ create-schema.js             # æ•°æ®åº“åˆå§‹åŒ–
â”œâ”€â”€ seed-students.js             # æµ‹è¯•æ•°æ®
â”œâ”€â”€ mobile/                      # å‰ç«¯æºç 
â”‚   â”œâ”€â”€ App.tsx
â”‚   â”œâ”€â”€ bigscreen/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ public/                      # é™æ€æ–‡ä»¶ï¼ˆæ„å»ºäº§ç‰©ï¼‰
â”‚   â”œâ”€â”€ index.html               # æ•™å¸ˆç«¯å…¥å£
â”‚   â”œâ”€â”€ index.css                # å…¨å±€æ ·å¼
â”‚   â”œâ”€â”€ assets/                  # æ•™å¸ˆç«¯èµ„æº
â”‚   â”‚   â”œâ”€â”€ main-*.js
â”‚   â”‚   â””â”€â”€ index-*.js
â”‚   â””â”€â”€ bigscreen/               # å¤§å±ç«¯èµ„æº
â”‚       â”œâ”€â”€ index.html           # å¤§å±ç«¯å…¥å£
â”‚       â””â”€â”€ assets/
â”‚           â”œâ”€â”€ index-*.js
â”‚           â””â”€â”€ bigscreen-*.js
â””â”€â”€ node_modules/
```

### è·¯ç”±æ˜ å°„

| URLè·¯å¾„ | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|---------|------|
| `/admin` | `public/index.html` | æ•™å¸ˆç«¯/ç®¡ç†ç«¯ |
| `/screen` | `public/bigscreen/index.html` | å¤§å±æ˜¾ç¤ºç«¯ |
| `/student` | `public/index.html` | å­¦ç”Ÿç«¯ï¼ˆé¢„ç•™ï¼‰ |
| `/assets/*` | `public/assets/*` | æ•™å¸ˆç«¯é™æ€èµ„æº |
| `/bigscreen/*` | `public/bigscreen/*` | å¤§å±ç«¯é™æ€èµ„æº |
| `/api/*` | Express API | åç«¯APIæ¥å£ |

### æ„å»ºæµç¨‹

```bash
# 1. æ„å»ºå‰ç«¯
cd /home/devbox/project/arkok/mobile
npm run build

# 2. å¤åˆ¶æ„å»ºäº§ç‰©åˆ°publicç›®å½•
cp -r dist/* ../public/

# 3. éªŒè¯æ–‡ä»¶
ls -la ../public/
ls -la ../public/bigscreen/

# 4. é‡å¯æœåŠ¡å™¨
cd ..
./entrypoint.sh
```

### ç¯å¢ƒå˜é‡

```bash
# .env
DATABASE_URL=postgresql://user:password@host:port/database
DB_HOST=growark-postgresql.ns-bg6fgs6y.svc
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=kngwb5cb
DB_NAME=postgres
NODE_ENV=development
PORT=3000
```

### å¯åŠ¨æµç¨‹

```bash
#!/bin/bash
# entrypoint.sh

# 1. åŠ è½½ç¯å¢ƒå˜é‡
source .env

# 2. æ£€æŸ¥æ•°æ®åº“è¿æ¥
echo "Testing database connection..."

# 3. å¯åŠ¨æœåŠ¡å™¨
NODE_ENV=development node server.js
```

### è®¿é—®åœ°å€

**å¼€å‘ç¯å¢ƒï¼š**
- æ•™å¸ˆç«¯: http://localhost:3000/admin
- å¤§å±ç«¯: http://localhost:3000/screen
- API: http://localhost:3000/api

**ç”Ÿäº§ç¯å¢ƒï¼ˆSealosï¼‰ï¼š**
- æ•™å¸ˆç«¯: https://esboimzbkure.sealosbja.site/admin
- å¤§å±ç«¯: https://esboimzbkure.sealosbja.site/screen
- API: https://esboimzbkure.sealosbja.site/api

---

## å†å²é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1: WebSocket è¿æ¥å¤±è´¥

**ç—‡çŠ¶ï¼š**
- å¤§å±ç«¯ä»£ç ä¸­æœ‰ WebSocket è¿æ¥ä»£ç ï¼Œä½†å®æ—¶æ›´æ–°ä¸å·¥ä½œ
- é”™è¯¯æ—¥å¿—æ˜¾ç¤º WSSï¼ˆWebSocket Secureï¼‰è¿æ¥æ— æ³•å»ºç«‹

**æ ¹æœ¬åŸå› ï¼š**
- Sealos åå‘ä»£ç†ä¸æ”¯æŒ WebSocket å‡çº§ï¼ˆWSSï¼‰
- WebSocket éœ€è¦ HTTP upgrade è¯·æ±‚ï¼Œä½†åå‘ä»£ç†é…ç½®ä¸æ”¯æŒ

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// âŒ åˆ é™¤äº†ä»¥ä¸‹ä»£ç ï¼ˆåŸæ¥çš„ WebSocket å®ç°ï¼‰
const ws = new WebSocket('wss://...')
ws.onmessage = (event) => {
  // å¤„ç†å®æ—¶æ¶ˆæ¯
}

// âœ… æ”¹ä¸º HTTP è½®è¯¢
useEffect(() => {
  let pollInterval: NodeJS.Timeout | null = null
  let lastData = JSON.stringify([])

  const pollStudents = async () => {
    try {
      const studentsRes = await fetch(`${API_BASE_URL}/students`)
      const studentsData = await studentsRes.json()

      if (studentsData.success && Array.isArray(studentsData.data)) {
        const mappedStudents = studentsData.data.map((s: any) => ({
          id: String(s.id),
          name: s.name,
          team_id: `t${s.team_id}`,
          total_exp: s.total_exp || 0,
          total_points: s.score || 0,
          avatar_url: s.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(s.name)}`,
          badges: []
        }))

        // ä½¿ç”¨ JSON å­—ç¬¦ä¸²æ¯”è¾ƒæ£€æµ‹æ•°æ®å˜åŒ–
        const newData = JSON.stringify(mappedStudents)
        if (lastData !== newData) {
          lastData = newData
          setStudents(mappedStudents)
          setWsConnected(true)
        } else if (!wsConnected) {
          setWsConnected(true)
        }
      }
    } catch (error) {
      console.error('Polling error:', error)
      setWsConnected(false)
    }
  }

  pollStudents()
  pollInterval = setInterval(pollStudents, 2000) // 2ç§’è½®è¯¢ä¸€æ¬¡

  return () => {
    if (pollInterval) clearInterval(pollInterval)
  }
}, [])
```

**å…³é”®å‚æ•°ï¼š**
- è½®è¯¢é—´éš”ï¼š2000msï¼ˆ2ç§’ï¼‰
- æ•°æ®æ¯”è¾ƒæ–¹æ³•ï¼šJSON.stringify å…¨é‡æ¯”è¾ƒ
- è¿æ¥çŠ¶æ€æŒ‡ç¤ºï¼š`wsConnected` çŠ¶æ€

**æ–‡ä»¶ä½ç½®ï¼š** `mobile/bigscreen/main.tsx:34-77`

---

### é—®é¢˜ 2: PK æ¦œå•æ˜¾ç¤ºå›ºå®šå­¦ç”Ÿï¼Œä¸éšç§¯åˆ†æ›´æ–°

**ç—‡çŠ¶ï¼š**
- æ‰‹æœºç«¯ä¿®æ”¹å­¦ç”Ÿç§¯åˆ†åï¼Œå¤§å± PK æ¦œå•ä¸­æ˜¾ç¤ºçš„å­¦ç”Ÿæ²¡æœ‰å˜åŒ–
- PK æ¦œæ€»æ˜¯æ˜¾ç¤ºå­¦ç”Ÿ ID 16 å¯¹å­¦ç”Ÿ ID 17
- å³ä½¿å…¶ä»–å­¦ç”Ÿç§¯åˆ†å¾ˆé«˜ï¼Œä¹Ÿä¸å‡ºç°åœ¨ PK æ¦œä¸­

**æ ¹æœ¬åŸå› ï¼š**
- API è¿”å›çš„å­¦ç”Ÿæ•°æ®æŒ‰ ID å›ºå®šæ’åºï¼ˆID 16, 17, 18...ï¼‰
- PK æ•°æ®ç”Ÿæˆé€»è¾‘ä½¿ç”¨åŸå§‹å­¦ç”Ÿæ•°ç»„ç´¢å¼•ï¼š
  ```typescript
  // âŒ é”™è¯¯çš„å®ç°
  const studentA = students[0]  // æ€»æ˜¯ ID 16
  const studentB = students[1]  // æ€»æ˜¯ ID 17
  ```

**è°ƒè¯•è¿‡ç¨‹ï¼š**
```javascript
// é€šè¿‡æ§åˆ¶å°æ—¥å¿—å‘ç°è§„å¾‹
console.log('first pk student_a:', generatedPks[0]?.student_a)
// è¾“å‡ºï¼š16ï¼ˆå§‹ç»ˆç›¸åŒï¼‰

console.log('first pk student_b:', generatedPks[0]?.student_b)
// è¾“å‡ºï¼š17ï¼ˆå§‹ç»ˆç›¸åŒï¼‰
```

**è§£å†³æ–¹æ¡ˆï¼š**
åœ¨ç”Ÿæˆ PK æ•°æ®å‰ï¼Œå…ˆæŒ‰ `total_points`ï¼ˆç§¯åˆ†ï¼‰å¯¹å­¦ç”Ÿæ•°ç»„è¿›è¡Œæ’åºï¼š

```typescript
// âœ… æ­£ç¡®çš„å®ç°
const generatedPks = useMemo(() => {
  if (students.length < 2) return []

  // å…³é”®æ­¥éª¤ï¼šæŒ‰ç§¯åˆ†ä»é«˜åˆ°ä½æ’åº
  const sortedStudents = [...students].sort((a, b) => b.total_points - a.total_points)
  const pksData = []

  for (let i = 0; i < Math.min(6, Math.floor(sortedStudents.length / 2)); i++) {
    const studentA = sortedStudents[i * 2]      // ç¬¬ä¸€ã€ä¸‰ã€äº”...é«˜åˆ†å­¦ç”Ÿ
    const studentB = sortedStudents[i * 2 + 1]  // ç¬¬äºŒã€å››ã€å…­...é«˜åˆ†å­¦ç”Ÿ

    pksData.push({
      id: `pk-${i}`,
      student_a: studentA.id,
      student_b: studentB.id,
      topic: ['èƒŒå¤è¯—', 'é€Ÿç®—', 'è‹±è¯­æ‹¼å†™', 'æ•°å­¦ç«èµ›', 'å†™ä½œæ¯”èµ›', 'åˆ›æ„æ€ç»´'][i % 6],
      status: i % 3 === 0 ? 'finished' : 'pending',
      winner_id: i % 3 === 0 ? (Math.random() > 0.5 ? studentA.id : studentB.id) : undefined,
      updated_at: new Date().toISOString()
    })
  }

  return pksData
}, [students])  // ä¾èµ– students æ•°ç»„ï¼Œç¡®ä¿å­¦ç”Ÿå˜åŒ–æ—¶é‡æ–°è®¡ç®—
```

**å…³é”®ç‚¹ï¼š**
- ä½¿ç”¨ `useMemo` ç¼“å­˜è®¡ç®—ç»“æœ
- ä¾èµ–æ•°ç»„ä¸­åŒ…å« `[students]`ï¼Œç¡®ä¿å­¦ç”Ÿæ•°æ®å˜åŒ–æ—¶é‡æ–°ç”Ÿæˆ PK æ•°æ®
- æŒ‰ `total_points` ä»é«˜åˆ°ä½æ’åºï¼Œè·å–åˆ†æ•°æœ€é«˜çš„å­¦ç”Ÿé…å¯¹

**æ–‡ä»¶ä½ç½®ï¼š** `mobile/bigscreen/main.tsx:83-105`

**éªŒè¯æ–¹æ³•ï¼š**
1. åœ¨æ•™å¸ˆç«¯ä¿®æ”¹å­¦ç”Ÿç§¯åˆ†
2. ç­‰å¾… 2 ç§’ï¼ˆè½®è¯¢é—´éš”ï¼‰
3. è§‚å¯Ÿå¤§å± PK æ¦œå•æ˜¯å¦æ›´æ–°ä¸ºæ–°çš„é«˜åˆ†å­¦ç”Ÿé…å¯¹

---

### é—®é¢˜ 3: æŒ‘æˆ˜æ¦œå’Œè£èª‰å‹‹ç« ä¸æ›´æ–°

**ç—‡çŠ¶ï¼š**
- å¤§å±åº•éƒ¨çš„"æŒ‘æˆ˜æ¦œ"å’Œ"è£èª‰å‹‹ç« "æ˜¾ç¤ºçš„å§‹ç»ˆæ˜¯å›ºå®šæ•°æ®
- ä¸éšå­¦ç”Ÿç§¯åˆ†å˜åŒ–è€Œæ›´æ–°æ’åº

**æ ¹æœ¬åŸå› ï¼š**
- åŒé—®é¢˜ 2ï¼Œæ•°æ®ç”Ÿæˆé€»è¾‘ä½¿ç”¨äº†æœªæ’åºçš„å­¦ç”Ÿæ•°ç»„

**è§£å†³æ–¹æ¡ˆï¼š**
å¯¹æ‰€æœ‰åŠ¨æ€ç”Ÿæˆçš„æ•°æ®ï¼ˆPKã€æŒ‘æˆ˜ã€å‹‹ç« ï¼‰éƒ½åº”ç”¨ç›¸åŒçš„æ’åºé€»è¾‘ï¼š

```typescript
// æŒ‘æˆ˜æ•°æ®ç”Ÿæˆ
const generatedChallenges = useMemo(() => {
  if (students.length === 0) return []

  // æŒ‰ç§¯åˆ†æ’åº
  const sortedStudents = [...students].sort((a, b) => b.total_points - a.total_points)
  const challengeTypes = ['ä¸€å‘¨é˜…è¯»æŒ‘æˆ˜', 'è‰ºæœ¯åˆ›ä½œ', 'æ•°å­¦é€Ÿç®—', 'è‹±è¯­æ¼”è®²', 'ç§‘å­¦å®éªŒ', 'ç¼–ç¨‹æŒ‘æˆ˜']
  const statuses = ['è¿›è¡Œä¸­', 'æˆåŠŸ', 'å¤±è´¥']
  const challenges = []

  for (let i = 0; i < Math.min(5, sortedStudents.length); i++) {
    const student = sortedStudents[i]  // å–é«˜åˆ†å­¦ç”Ÿ
    challenges.push({
      id: `c-${i}`,
      title: challengeTypes[i % challengeTypes.length],
      description: `å®Œæˆ ${[5, 10, 3, 2, 1, 8][i % 6]} ä¸ªä»»åŠ¡`,
      challenger: {
        name: student.name,
        avatar: student.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${student.name}`
      },
      status: statuses[i % statuses.length]
    })
  }

  return challenges
}, [students])

// å‹‹ç« æ•°æ®ç”Ÿæˆ
const generatedBadges = useMemo(() => {
  if (students.length === 0) return []

  return [...students].map((s, idx) => {
    const badges = []

    if (idx % 3 === 0) {
      badges.push({
        id: `b1-${idx}`,
        name: 'å­¦éœ¸ä¹‹æ˜Ÿ',
        description: 'å­¦ä¹ è¡¨ç°çªå‡º',
        image: s.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${s.name}`,
        icon: 'â­',
        awardedDate: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString()
      })
    }

    return { ...s, badges }
  })
}, [students])
```

**æ–‡ä»¶ä½ç½®ï¼š** `mobile/bigscreen/main.tsx:108-175`

---

### é—®é¢˜ 4: PKBoardCard é¡µé¢ç´¢å¼•è¶Šç•Œ

**ç—‡çŠ¶ï¼š**
- PK æ¦œå¡ç‰‡åœ¨é¡µé¢åˆ‡æ¢æ—¶æœ‰æ—¶æ˜¾ç¤ºç©ºç™½
- é¡µé¢ç´¢å¼•ä¸ä¼šé‡ç½®ï¼Œå¯¼è‡´åˆ‡æ¢åˆ°ä¸å­˜åœ¨çš„é¡µé¢

**æ ¹æœ¬åŸå› ï¼š**
- å½“ `pks` æ•°æ®é‡æ–°ç”Ÿæˆæ—¶ï¼Œé¡µé¢ç´¢å¼•ï¼ˆ`page` stateï¼‰æ²¡æœ‰é‡ç½®
- å¯èƒ½å¯¼è‡´ `page >= pages.length`ï¼Œè¶…å‡ºèŒƒå›´

**è§£å†³æ–¹æ¡ˆï¼š**
åœ¨ PKBoardCard ç»„ä»¶ä¸­æ·»åŠ  `useEffect` ç›‘å¬ `pks` å˜åŒ–ï¼š

```typescript
// âœ… å½“ PK æ•°æ®æ”¹å˜æ—¶é‡ç½®é¡µé¢
useEffect(() => {
  setPage(0)
}, [pks])
```

**æ–‡ä»¶ä½ç½®ï¼š** `mobile/bigscreen/components/PKBoardCard.tsx:34-37`

---

### é—®é¢˜ 5: å¤§é‡è°ƒè¯•æ—¥å¿—å¯¼è‡´ä»£ç æ··ä¹±

**ç—‡çŠ¶ï¼š**
- æºä»£ç åŒ…å«å¤§é‡ `console.log` è°ƒè¯•è¾“å‡º
- æ§åˆ¶å°è¾“å‡ºä¿¡æ¯è¿‡å¤šï¼Œéš¾ä»¥åŒºåˆ†å®é™…é—®é¢˜
- ç”Ÿäº§ç‰ˆæœ¬åŒ…å«è°ƒè¯•ä»£ç ï¼Œå½±å“ä»£ç è´¨é‡

**è°ƒè¯•æ—¥å¿—ç¤ºä¾‹ï¼š**
```javascript
// âŒ åˆ é™¤çš„è°ƒè¯•æ—¥å¿—
console.log(`âœ… Updated student ${id}: ${data.data.name} - Score: ${data.data.score}`)
console.log(`[API] POINTS_UPDATED: ${ids.length} students, reason: ${reason}`)
console.log(`[WS-Mock] HABIT_CHECKIN: ${studentIds.length} students for habit ${habitId}`)
```

**è§£å†³æ–¹æ¡ˆï¼š**
åªä¿ç•™å¿…è¦çš„é”™è¯¯å¤„ç†æ—¥å¿—ï¼Œåˆ é™¤æ‰€æœ‰è°ƒè¯•è¾“å‡ºï¼š

```typescript
// âœ… ä¿ç•™çš„é”™è¯¯å¤„ç†æ—¥å¿—
console.error('Failed to load teams:', error)
console.error('Polling error:', error)
console.error('Failed to update student ${id}:', response.statusText)
```

**æ¸…ç†èŒƒå›´ï¼š**
- `mobile/App.tsx`ï¼šåˆ é™¤ 3 å¤„ debug console.log
- `mobile/bigscreen/main.tsx`ï¼šä¿ç•™é”™è¯¯å¤„ç†æ—¥å¿—
- `mobile/bigscreen/services/sealosService.ts`ï¼šåˆ é™¤æ‰€æœ‰è°ƒè¯•ä»£ç 

**æ–‡ä»¶ä½ç½®ï¼š** `mobile/App.tsx:151, 170, 179`

---

### é—®é¢˜ 6: æœªä½¿ç”¨çš„å¯¼å…¥å’Œæ­»ä»£ç 

**ç—‡çŠ¶ï¼š**
- å¯¼å…¥äº†ä»æœªä½¿ç”¨çš„å‡½æ•°
- åŒ…å«äº†å¤§é‡å¼ƒç”¨çš„ mock æ•°æ®
- ä»£ç åº“ä¸­å­˜åœ¨å¤šä½™çš„ä»£ç 

**æœªä½¿ç”¨çš„å¯¼å…¥ï¼š**
```typescript
// âŒ åˆ é™¤çš„æœªä½¿ç”¨å¯¼å…¥
import { Challenge } from './types'
import { getStudents, getChallenges, getBadges, getPKs, getRecentTasks } from './services/sealosService'
```

**è§£å†³æ–¹æ¡ˆï¼š**

1. **main.tsx å¯¼å…¥æ¸…ç†ï¼š**
```typescript
// âœ… æ¸…ç†å
import { Student, Team } from './types'
import { getTeams } from './services/sealosService'
```

2. **sealosService.ts ç®€åŒ–ï¼š**

åˆ é™¤å‰ï¼ˆ96 è¡Œï¼‰ï¼š
```typescript
// åŒ…å«æ‰€æœ‰ mock æ•°æ®å’Œå‡½æ•°
let teams: Team[] = [...]
let students: Student[] = []
let badges: Badge[] = [...]
let pkMatches: PKMatch[] = [...]
let challenges: Challenge[] = [...]
let recentTasks: StudentTask[] = [...]

export const getStudents = async () => { ... }
export const getChallenges = async () => { ... }
export const getBadges = async () => { ... }
export const getPKs = async () => { ... }
export const getRecentTasks = async () => { ... }
export const subscribeToStudentChanges = () => { ... }
export const subscribeToChallengeChanges = () => { ... }
export const subscribeToPKChanges = () => { ... }
export const subscribeToTaskChanges = () => { ... }
```

åˆ é™¤åï¼ˆ10 è¡Œï¼‰ï¼š
```typescript
import { Team } from '../types'

const teams: Team[] = [
  { id: 't1', name: 'æ–°æ˜Ÿå‰é”‹', color: 'bg-cyan-500', textColor: 'text-cyan-400' },
  { id: 't2', name: 'æ—‹æ¶¡æ¯’è›‡', color: 'bg-purple-500', textColor: 'text-purple-400' },
  { id: 't3', name: 'çŒ©çº¢å®ˆå«', color: 'bg-red-500', textColor: 'text-red-400' },
  { id: 't4', name: 'ç¿¡ç¿ å“¨å…µ', color: 'bg-emerald-500', textColor: 'text-emerald-400' },
]

export const getTeams = async (): Promise<Team[]> => teams
```

**æ–‡ä»¶ä½ç½®ï¼š**
- `mobile/bigscreen/main.tsx:11-12`
- `mobile/bigscreen/services/sealosService.ts`ï¼ˆæ•´ä¸ªæ–‡ä»¶é‡å†™ï¼‰

---

### é—®é¢˜ 7: æ„å»ºå¤±è´¥æˆ–ç±»å‹é”™è¯¯

**ç—‡çŠ¶ï¼š**
- ä¿®æ”¹ä»£ç å `npm run build` å¤±è´¥
- TypeScript ç¼–è¯‘é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ„å»ºå‘½ä»¤
npm run build

# è¾“å‡ºï¼ˆæˆåŠŸï¼‰
âœ“ 1271 modules transformed.
dist/bigscreen/index.html            0.53 kB â”‚ gzip:   0.38 kB
dist/index.html                      1.87 kB â”‚ gzip:   0.87 kB
dist/assets/bigscreen-BJl7nfOY.js   20.75 kB â”‚ gzip:   6.85 kB
dist/assets/client-C_2d_5tV.js     143.69 kB â”‚ gzip:  46.12 kB
dist/assets/main-CkFlIIl7.js       382.49 kB â”‚ gzip: 123.72 kB
âœ“ built in 2.81s
```

---

### é—®é¢˜ 8: å¤§å±é™æ€èµ„æºè·¯å¾„é”™è¯¯

**ç—‡çŠ¶ï¼š**
- å¤§å±æ˜¾ç¤ºåŠ è½½å¤±è´¥ï¼ŒHTML å¼•ç”¨çš„ JS æ–‡ä»¶å“ˆå¸Œå€¼ä¸åŒ¹é…
- `display.html` å’Œ `admin.html` æŒ‡å‘æ—§çš„èµ„æºæ–‡ä»¶

**è§£å†³æ–¹æ¡ˆï¼š**

1. **æ„å»ºæ–°ç‰ˆæœ¬ï¼š**
```bash
npm run build
# ç”Ÿæˆæ–°çš„èµ„æºæ–‡ä»¶å’Œå“ˆå¸Œå€¼
```

2. **æ›´æ–° display.htmlï¼š**
```html
<!-- âŒ æ—§çš„å“ˆå¸Œå€¼ -->
<script type="module" crossorigin src="/assets/bigscreen-Cc0BpzZl.js"></script>

<!-- âœ… æ–°çš„å“ˆå¸Œå€¼ -->
<script type="module" crossorigin src="/assets/bigscreen-BJl7nfOY.js"></script>
```

3. **æ›´æ–° admin.htmlï¼š**
```html
<!-- âŒ æ—§çš„å“ˆå¸Œå€¼ -->
<script type="module" crossorigin src="/assets/main-CJusgVie.js"></script>

<!-- âœ… æ–°çš„å“ˆå¸Œå€¼ -->
<script type="module" crossorigin src="/assets/main-CkFlIIl7.js"></script>
```

4. **å¤åˆ¶æ„å»ºäº§ç‰©åˆ°å…¬å¼€ç›®å½•ï¼š**
```bash
cp -r /home/devbox/project/mobile/dist/* /home/devbox/project/public/
```

**æ–‡ä»¶ä½ç½®ï¼š**
- `public/display.html`
- `public/admin.html`

---

## å…³é”®æŠ€æœ¯å†³ç­–

### 1. HTTP è½®è¯¢ vs WebSocket

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‰æ‹© |
|------|------|------|------|
| WebSocket | çœŸæ­£å®æ—¶ï¼Œä½å»¶è¿Ÿ | Sealos åå‘ä»£ç†ä¸æ”¯æŒ WSS | âŒ ä¸å¯è¡Œ |
| HTTP è½®è¯¢ | æ‰€æœ‰ç¯å¢ƒæ”¯æŒï¼Œæ˜“è°ƒè¯• | è½»å¾®å»¶è¿Ÿï¼ˆ2ç§’ï¼‰ | âœ… é€‰æ‹© |

**è½®è¯¢é—´éš”é€‰æ‹©ï¼š2000ms**
- è¶³å¤Ÿé¢‘ç¹è¿›è¡Œå®æ—¶æ˜¾ç¤º
- ä¸ä¼šå¯¹æœåŠ¡å™¨é€ æˆè¿‡è½½
- ç”¨æˆ·ä½“éªŒæµç•…

### 2. æ•°æ®å˜åŒ–æ£€æµ‹æ–¹æ³•

```typescript
// æ–¹æ¡ˆ Aï¼šJSON å­—ç¬¦ä¸²å…¨é‡æ¯”è¾ƒï¼ˆå·²é€‰æ‹©ï¼‰
const newData = JSON.stringify(mappedStudents)
if (lastData !== newData) {
  // æ•°æ®æœ‰å˜åŒ–
}

// æ–¹æ¡ˆ Bï¼šæ·±åº¦å¯¹æ¯”ï¼ˆä¼šäº§ç”Ÿæ€§èƒ½é—®é¢˜ï¼‰
// æ–¹æ¡ˆ Cï¼šå­—æ®µçº§åˆ«æ¯”è¾ƒï¼ˆå¤æ‚åº¦é«˜ï¼‰
```

é€‰æ‹©å­—ç¬¦ä¸²æ¯”è¾ƒçš„åŸå› ï¼š
- ç®€æ´æ˜“æ‡‚
- å‡†ç¡®æ£€æµ‹ä»»ä½•æ•°æ®å˜åŒ–
- æ€§èƒ½å¯æ¥å—ï¼ˆJSON.stringify å¾ˆå¿«ï¼‰

### 3. useMemo ä¾èµ–ç®¡ç†

```typescript
// âœ… æ­£ç¡®ï¼šä¾èµ– studentsï¼Œç¡®ä¿å­¦ç”Ÿå˜åŒ–æ—¶é‡æ–°ç”Ÿæˆæ•°æ®
const generatedPks = useMemo(() => {
  // ç”Ÿæˆ PK æ•°æ®
}, [students])

// âŒ é”™è¯¯ï¼šä¾èµ–ä¸ºç©ºï¼Œæ•°æ®ä¸ä¼šæ›´æ–°
const generatedPks = useMemo(() => {
  // ç”Ÿæˆ PK æ•°æ®
}, [])
```

---

## ä»£ç è´¨é‡æ”¹è¿›

### æ¸…ç†å‰åå¯¹æ¯”

| æŒ‡æ ‡ | æ¸…ç†å‰ | æ¸…ç†å | æ”¹è¿› |
|------|--------|--------|------|
| sealosService.ts è¡Œæ•° | 96 è¡Œ | 10 è¡Œ | â†“ 89.6% |
| æœªä½¿ç”¨çš„å¯¼å…¥ | 6 ä¸ª | 0 ä¸ª | âœ“ æ¶ˆé™¤ |
| console.log è°ƒè¯•è¯­å¥ | 7 å¤„ | 0 å¤„ | âœ“ æ¶ˆé™¤ |
| æ­»ä»£ç å‡½æ•° | 8 ä¸ª | 0 ä¸ª | âœ“ æ¶ˆé™¤ |
| æ„å»ºæˆåŠŸ | âœ“ | âœ“ | ä¿æŒ |
| åŠŸèƒ½å®Œæ•´æ€§ | 100% | 100% | ä¿æŒ |

### æ¸…ç†å†…å®¹è¯¦ç»†åˆ—è¡¨

**åˆ é™¤çš„è°ƒè¯•æ—¥å¿—ï¼š**
1. `mobile/App.tsx:151` - `âœ… Updated student...`
2. `mobile/App.tsx:170` - `[API] POINTS_UPDATED...`
3. `mobile/App.tsx:179` - `[WS-Mock] HABIT_CHECKIN...`

**åˆ é™¤çš„æœªä½¿ç”¨å¯¼å…¥ï¼š**
1. `mobile/bigscreen/main.tsx` - `Challenge` ç±»å‹
2. `mobile/bigscreen/main.tsx` - `getStudents` å‡½æ•°
3. `mobile/bigscreen/main.tsx` - `getChallenges` å‡½æ•°
4. `mobile/bigscreen/main.tsx` - `getBadges` å‡½æ•°
5. `mobile/bigscreen/main.tsx` - `getPKs` å‡½æ•°
6. `mobile/bigscreen/main.tsx` - `getRecentTasks` å‡½æ•°

**åˆ é™¤çš„æ­»ä»£ç ï¼š**
1. `mobile/bigscreen/services/sealosService.ts` - æ‰€æœ‰ mock æ•°æ®
2. `mobile/bigscreen/services/sealosService.ts` - `getStudents()` å‡½æ•°
3. `mobile/bigscreen/services/sealosService.ts` - `getChallenges()` å‡½æ•°
4. `mobile/bigscreen/services/sealosService.ts` - `getBadges()` å‡½æ•°
5. `mobile/bigscreen/services/sealosService.ts` - `getPKs()` å‡½æ•°
6. `mobile/bigscreen/services/sealosService.ts` - `getRecentTasks()` å‡½æ•°
7. `mobile/bigscreen/services/sealosService.ts` - æ‰€æœ‰ subscribe* å‡½æ•°

---

## éƒ¨ç½²æŒ‡å—

### 1. æ„å»ºæ­¥éª¤
```bash
cd /home/devbox/project/mobile
npm run build
```

### 2. éƒ¨ç½²æ­¥éª¤
```bash
# å¤åˆ¶æ„å»ºäº§ç‰©åˆ°å…¬å¼€ç›®å½•
cp -r /home/devbox/project/mobile/dist/* /home/devbox/project/public/

# éªŒè¯æ–‡ä»¶
ls -la /home/devbox/project/public/
```

### 3. éªŒè¯è®¿é—®è·¯ç”±

| è·¯ç”± | åº”ç”¨ | HTML æ–‡ä»¶ | è¯´æ˜ |
|------|------|---------|------|
| `/admin` | æ•™å¸ˆç«¯ï¼ˆClassHeroï¼‰ | `admin.html` | ç­çº§ç®¡ç†å’Œå­¦ç”Ÿç§¯åˆ†ç®¡ç† |
| `/display` | å¤§å±æ˜¾ç¤º | `display.html` | å®æ—¶æ•°æ®å¤§å±å±•ç¤º |
| `/bigscreen/` | å¤§å±åº”ç”¨ | `bigscreen/index.html` | å¤§å±åº”ç”¨ä¸»æ–‡ä»¶ |

### 4. è¿è¡Œç¯å¢ƒå˜é‡

```bash
# API åœ°å€é…ç½®
REACT_APP_API_URL=https://esboimzbkure.sealosbja.site/api
```

---

## æ•…éšœæ’æŸ¥

### ç—‡çŠ¶ï¼šå¤§å±ä¸æ˜¾ç¤ºæ•°æ®

**æ£€æŸ¥æ¸…å•ï¼š**
1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰
2. æ£€æŸ¥ç½‘ç»œè¯·æ±‚æ˜¯å¦æ­£å¸¸
3. éªŒè¯ API ç«¯ç‚¹æ˜¯å¦å¯è¾¾
4. æ£€æŸ¥ `console` ä¸­çš„é”™è¯¯ä¿¡æ¯

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æµ‹è¯• API
fetch('https://esboimzbkure.sealosbja.site/api/students')
  .then(r => r.json())
  .then(d => console.log(d))
```

### ç—‡çŠ¶ï¼šå¤§å±æ˜¾ç¤ºå­¦ç”Ÿä¸æ›´æ–°

**æ£€æŸ¥æ¸…å•ï¼š**
1. éªŒè¯è½®è¯¢æ˜¯å¦å·¥ä½œï¼š
```javascript
// æŸ¥çœ‹è½®è¯¢æ—¥å¿—
// åº”è¯¥æ¯ 2 ç§’çœ‹åˆ°ä¸€æ¬¡ç½‘ç»œè¯·æ±‚
```
2. æ•™å¸ˆç«¯ä¿®æ”¹ç§¯åˆ†åï¼Œç­‰å¾… 2-3 ç§’è§‚å¯Ÿå¤§å±
3. æ£€æŸ¥ `wsConnected` çŠ¶æ€ï¼ˆå³ä¸Šè§’è¿æ¥æŒ‡ç¤ºï¼‰

### ç—‡çŠ¶ï¼šæ„å»ºå¤±è´¥

**å¸¸è§åŸå› å’Œè§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ¸…ç† node_modules å’Œé‡æ–°å®‰è£…
rm -rf node_modules package-lock.json
npm install

# å†æ¬¡æ„å»º
npm run build
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. è½®è¯¢é—´éš”ä¼˜åŒ–

å½“å‰é…ç½®ï¼š2000msï¼ˆ2ç§’ï¼‰

```typescript
// å¯æ ¹æ®éœ€è¦è°ƒæ•´ï¼š
pollInterval = setInterval(pollStudents, 2000)  // å½“å‰ï¼š2ç§’
// pollInterval = setInterval(pollStudents, 1000)  // å¯é€‰ï¼š1ç§’ï¼ˆæ›´å®æ—¶ï¼‰
// pollInterval = setInterval(pollStudents, 5000)  // å¯é€‰ï¼š5ç§’ï¼ˆèŠ‚çœå¸¦å®½ï¼‰
```

**å»ºè®®ï¼š** ä¿æŒ 2000msï¼Œæ˜¯å®æ—¶æ€§å’Œæ€§èƒ½çš„æœ€ä½³å¹³è¡¡

### 2. å¤§æ•°æ®é›†ä¼˜åŒ–

å¦‚æœå­¦ç”Ÿæ•°é‡è¶…è¿‡ 100ï¼Œè€ƒè™‘ï¼š

```typescript
// åˆ†é¡µåŠ è½½
const PAGE_SIZE = 50
const currentPageStudents = students.slice(currentPage * PAGE_SIZE, (currentPage + 1) * PAGE_SIZE)

// è™šæ‹Ÿæ»šåŠ¨ï¼ˆé«˜çº§ï¼‰
import { FixedSizeList } from 'react-window'
```

### 3. å†…å­˜ä¼˜åŒ–

å½“å‰å®ç°å·²ä½¿ç”¨ `useMemo` ç¼“å­˜è®¡ç®—ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—ã€‚

---

## å®‰å…¨æ€§è€ƒè™‘

### 1. API ç«¯ç‚¹å®‰å…¨

- æ‰€æœ‰ API è°ƒç”¨ä½¿ç”¨ HTTPS
- åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åº”å®æ–½èº«ä»½éªŒè¯
- å®æ–½é€Ÿç‡é™åˆ¶é˜²æ­¢æ»¥ç”¨

### 2. æ•æ„Ÿæ•°æ®

å½“å‰å®ç°ä¸å­˜å‚¨æœ¬åœ°æ•æ„Ÿæ•°æ®ï¼Œæ‰€æœ‰ä¿¡æ¯ä» API å®æ—¶è·å–ã€‚

### 3. CORS é…ç½®

ç¡®ä¿ API æœåŠ¡å™¨æ­£ç¡®é…ç½® CORS ä»¥å…è®¸æ¥è‡ªå¤§å±çš„è¯·æ±‚ã€‚

---

## æµ‹è¯•éªŒè¯æ¸…å•

- [x] æ„å»ºæˆåŠŸï¼ˆæ— é”™è¯¯æˆ–è­¦å‘Šï¼‰
- [x] æ‰€æœ‰å¯¼å…¥æœ‰æ•ˆï¼ˆæ— æœªä½¿ç”¨çš„å¯¼å…¥ï¼‰
- [x] æ‰€æœ‰è°ƒè¯•ä»£ç å·²ç§»é™¤
- [x] å¤§å±è½®è¯¢å·¥ä½œæ­£å¸¸
- [x] PK æ¦œå•éšç§¯åˆ†æ›´æ–°
- [x] æŒ‘æˆ˜æ¦œéšç§¯åˆ†æ›´æ–°
- [x] è£èª‰å‹‹ç« æ˜¾ç¤ºæ­£ç¡®
- [x] é¡µé¢åˆ‡æ¢æ— å¼‚å¸¸
- [x] ç½‘ç»œè¿æ¥æŒ‡ç¤ºæ­£ç¡®

---

## ç›¸å…³æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æ–‡ä»¶

| æ–‡ä»¶ | åŠŸèƒ½ | ä¿®æ”¹å†…å®¹ |
|------|------|---------|
| `mobile/bigscreen/main.tsx` | å¤§å±ä¸»åº”ç”¨ | ä¿®æ”¹ PK/æŒ‘æˆ˜/å‹‹ç« ç”Ÿæˆé€»è¾‘ï¼Œåˆ é™¤æœªä½¿ç”¨å¯¼å…¥ |
| `mobile/bigscreen/components/PKBoardCard.tsx` | PK æ¦œå¡ç‰‡ | æ·»åŠ é¡µé¢é‡ç½®é€»è¾‘ï¼Œåˆ é™¤è°ƒè¯•æ—¥å¿— |
| `mobile/App.tsx` | æ•™å¸ˆç«¯ä¸»åº”ç”¨ | åˆ é™¤è°ƒè¯•æ—¥å¿— |
| `mobile/bigscreen/services/sealosService.ts` | API æœåŠ¡ | åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨å‡½æ•°å’Œ mock æ•°æ® |

### é…ç½®å’Œéƒ¨ç½²æ–‡ä»¶

| æ–‡ä»¶ | åŠŸèƒ½ | ä¿®æ”¹å†…å®¹ |
|------|------|---------|
| `public/admin.html` | æ•™å¸ˆç«¯ HTML å…¥å£ | æ›´æ–°èµ„æºå“ˆå¸Œå€¼ |
| `public/display.html` | å¤§å± HTML å…¥å£ | æ›´æ–°èµ„æºå“ˆå¸Œå€¼ |
| `public/index.html` | åº”ç”¨æ ¹ HTML | å¤åˆ¶è‡ªæ„å»ºäº§ç‰© |

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¸»è¦å˜æ›´ |
|------|------|---------|
| v1.0 | 2024-11-22 | é¦–ä¸ªç”Ÿäº§ç‰ˆæœ¬ï¼Œå®Œæˆä»£ç æ¸…ç†å’Œä¼˜åŒ– |

---

## è”ç³»ä¸æ”¯æŒ

å¦‚éœ€æŠ€æœ¯æ”¯æŒæˆ–é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æœ¬æ–‡æ¡£å¯¹åº”çš„ç« èŠ‚
2. æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯
3. æœåŠ¡å™¨æ—¥å¿—

---

---

## é—®é¢˜ 9: å‹‹ç« æˆäºˆåç›¸å…³æ˜¾ç¤ºé—®é¢˜ï¼ˆ2025-11-26ï¼‰

### 9.1 å¤§å±ç«¯å‹‹ç« æˆäºˆæ—¥æœŸæ¶ˆå¤±

**ç—‡çŠ¶ï¼š**
- å‹‹ç« æˆäºˆåï¼Œå¤§å±ç«¯å‹‹ç« å±•ç¤ºåŒºåŸŸçš„æˆäºˆæ—¥æœŸä¸æ˜¾ç¤º

**æ ¹æœ¬åŸå› ï¼š**
- å‰ç«¯ä»£ç ä½¿ç”¨ `badge.awardedDate` å­—æ®µ
- ä½† API è¿”å›çš„å­—æ®µåæ˜¯ `awarded_at`
- å­—æ®µåä¸åŒ¹é…å¯¼è‡´æ—¥æœŸæ— æ³•æ˜¾ç¤º

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// bigscreen/components/HonorBadgesCard.tsx:38
// âŒ åŸä»£ç 
åŠ å†•äº: {fmt(badge.awardedDate)}

// âœ… ä¿®å¤å - å…¼å®¹ä¸¤ç§å­—æ®µå
åŠ å†•äº: {fmt((badge as any).awarded_at || badge.awardedDate)}
```

**æ–‡ä»¶ä½ç½®ï¼š** `bigscreen/components/HonorBadgesCard.tsx:38`

---

### 9.2 å¤§å±å‹‹ç« å¡å¤´åƒæ˜¾ç¤ºé—®é¢˜

**ç—‡çŠ¶ï¼š**
- å‹‹ç« å¡ç‰‡ä¸­åº”è¯¥æ˜¾ç¤ºå­¦ç”Ÿå¤´åƒï¼Œä½†æ²¡æœ‰æ˜¾ç¤º

**æ ¹æœ¬åŸå› ï¼š**
- ä»£ç å°è¯•æ˜¾ç¤º `badge.image`ï¼ˆå‹‹ç« å›¾ç‰‡ï¼‰
- ä½† API æ²¡æœ‰è¿”å›å‹‹ç« å›¾ç‰‡å­—æ®µ
- åº”è¯¥æ˜¾ç¤ºçš„æ˜¯å­¦ç”Ÿå¤´åƒï¼Œè€Œä¸æ˜¯å‹‹ç« å›¾ç‰‡

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// bigscreen/components/HonorBadgesCard.tsx:29
// âŒ åŸä»£ç 
<img src={badge.image} alt={badge.name} className="w-20 h-20 rounded-full border-2 border-yellow-400 object-cover"/>

// âœ… ä¿®å¤å - æ˜¾ç¤ºå­¦ç”Ÿå¤´åƒ
<img src={student.avatar_url || '/assets/default-avatar.png'} alt={student.name} className="w-20 h-20 rounded-full border-2 border-yellow-400 object-cover"/>
```

**æ–‡ä»¶ä½ç½®ï¼š** `bigscreen/components/HonorBadgesCard.tsx:29`

---

### 9.3 å¤§å±å‹‹ç« å±•ç¤ºæ»šåŠ¨é€Ÿåº¦è¿‡å¿«

**ç—‡çŠ¶ï¼š**
- å‹‹ç« æ¨ªå‘æ»šåŠ¨é€Ÿåº¦å¤ªå¿«ï¼Œç”¨æˆ·æ— æ³•çœ‹æ¸…å†…å®¹

**è§£å†³æ–¹æ¡ˆï¼š**
```css
/* bigscreen/components/HonorBadgesCard.tsx:85 */
/* âŒ åŸé…ç½® */
animation: scroll 50s linear infinite;

/* âœ… ä¿®å¤å - è°ƒæ•´ä¸ºæ›´æ…¢çš„é€Ÿåº¦ */
animation: scroll 80s linear infinite;
```

**è°ƒæ•´è¯´æ˜ï¼š**
- ä» 50 ç§’å¢åŠ åˆ° 80 ç§’
- æ»šåŠ¨é€Ÿåº¦é™ä½ 37.5%
- ç”¨æˆ·æœ‰æ›´å¤šæ—¶é—´é˜…è¯»å‹‹ç« ä¿¡æ¯

**æ–‡ä»¶ä½ç½®ï¼š** `bigscreen/components/HonorBadgesCard.tsx:85`

---

### 9.4 å¤§å±æŒ‘æˆ˜æ“‚å°ç¼ºå°‘æŒ‘æˆ˜è€…åç§°

**ç—‡çŠ¶ï¼š**
- å¤§å±ç«¯æŒ‘æˆ˜æ“‚å°æ˜¾ç¤ºæŒ‘æˆ˜ä¿¡æ¯ï¼Œä½†æ²¡æœ‰æ˜¾ç¤ºæŒ‘æˆ˜è€…åç§°
- æ‰‹æœºç«¯å¯ä»¥æ­£å¸¸æ˜¾ç¤ºæŒ‘æˆ˜è€…åç§°

**æ ¹æœ¬åŸå› ï¼š**
1. API åªè¿”å›åŸºæœ¬æŒ‘æˆ˜å­—æ®µï¼Œæ²¡æœ‰ JOIN å­¦ç”Ÿè¡¨è·å–æŒ‘æˆ˜è€…ä¿¡æ¯
2. å‰ç«¯æœåŠ¡å±‚ç¡¬ç¼–ç äº†æŒ‘æˆ˜è€…ä¿¡æ¯ä¸º"ç³»ç»Ÿ"
3. å‰ç«¯ç»„ä»¶æœŸæœ› `challenger.name` å’Œ `challenger.avatar` å­—æ®µ

**è§£å†³æ–¹æ¡ˆåˆ†ä¸‰æ­¥ï¼š**

**æ­¥éª¤ 1ï¼šä¿®æ”¹ API è¿”å›æŒ‘æˆ˜è€…ä¿¡æ¯**
```javascript
// server.js:538-568
// âŒ åŸ SQL æŸ¥è¯¢
SELECT id, title, description, status, reward_points, reward_exp FROM challenges

// âœ… ä¿®å¤å - JOIN students è¡¨è·å–æŒ‘æˆ˜è€…ä¿¡æ¯
SELECT
  c.id,
  c.title,
  c.description,
  c.status,
  c.reward_points,
  c.reward_exp,
  c.challenger_id,
  s.name as challenger_name,
  s.avatar_url as challenger_avatar
FROM challenges c
LEFT JOIN students s ON c.challenger_id = s.id
ORDER BY c.created_at DESC
```

**æ­¥éª¤ 2ï¼šæ›´æ–°æœåŠ¡å±‚æ•°æ®æ˜ å°„**
```typescript
// bigscreen/services/sealosService.ts:66-75
// âŒ åŸä»£ç  - ç¡¬ç¼–ç æŒ‘æˆ˜è€…ä¿¡æ¯
cachedData.challenges = (result.data || []).map((c: any) => ({
  id: String(c.id),
  title: c.title || 'æœªå‘½åæŒ‘æˆ˜',
  description: c.description || '',
  status: c.status || 'active',
  challenger: {
    name: 'ç³»ç»Ÿ',
    avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=system'
  }
}))

// âœ… ä¿®å¤å - ä½¿ç”¨ API è¿”å›çš„æŒ‘æˆ˜è€…ä¿¡æ¯
cachedData.challenges = (result.data || []).map((c: any) => ({
  id: String(c.id),
  title: c.title || 'æœªå‘½åæŒ‘æˆ˜',
  description: c.description || '',
  status: c.status || 'active',
  challenger: {
    name: c.challenger_name || 'æœªçŸ¥æŒ‘æˆ˜è€…',
    avatar: c.challenger_avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=system'
  }
}))
```

**æ­¥éª¤ 3ï¼šæ›´æ–° WebSocket äº‹ä»¶å¤„ç†**
```typescript
// bigscreen/main.tsx:84-95
// âŒ åŸä»£ç  - æ–°æŒ‘æˆ˜äº‹ä»¶ä¹Ÿä½¿ç”¨ç¡¬ç¼–ç 
unsubscribeChallengeCreate = subscribe('challenge:created', (newChallenge: any) => {
  setChallenges((prev) => [{
    id: String(newChallenge.id),
    title: newChallenge.title,
    description: newChallenge.description,
    status: newChallenge.status,
    challenger: {
      name: 'ç³»ç»Ÿ',
      avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=system'
    }
  }, ...prev])
})

// âœ… ä¿®å¤å - ä½¿ç”¨äº‹ä»¶ä¸­çš„æŒ‘æˆ˜è€…ä¿¡æ¯
unsubscribeChallengeCreate = subscribe('challenge:created', (newChallenge: any) => {
  setChallenges((prev) => [{
    id: String(newChallenge.id),
    title: newChallenge.title,
    description: newChallenge.description,
    status: newChallenge.status,
    challenger: {
      name: newChallenge.challenger_name || 'æœªçŸ¥æŒ‘æˆ˜è€…',
      avatar: newChallenge.challenger_avatar || 'https://api.dicebear.com/7.x/avataaars/svg?seed=system'
    }
  }, ...prev])
})
```

**æ­¥éª¤ 4ï¼šæ›´æ–°å‰ç«¯ç»„ä»¶å…¼å®¹æ–°æ—§æ ¼å¼**
```typescript
// bigscreen/components/ChallengeArenaCard.tsx:22-48
// âœ… å…¼å®¹æ–°æ—§ä¸¤ç§æ•°æ®æ ¼å¼
{displayChallenges.map((challenge, index) => {
  const challengerName = (challenge as any).challenger_name || challenge.challenger?.name || 'æœªçŸ¥æŒ‘æˆ˜è€…';
  const challengerAvatar = (challenge as any).challenger_avatar || challenge.challenger?.avatar || '/assets/default-avatar.png';

  return (
    <div key={`${challenge.id}-${index}`} className="flex items-center p-2 mb-2 bg-slate-800/40 border border-slate-700/50 rounded-lg">
      <img
        src={challengerAvatar}
        alt={challengerName}
        className="w-9 h-9 rounded-full border-2 border-purple-400 mr-3 flex-shrink-0"
      />
      <div className="flex-grow overflow-hidden">
        <h4 className="font-bold text-sm text-purple-300 truncate">{challenge.title}</h4>
        <p className="text-xs text-slate-400 truncate">æŒ‘æˆ˜è€…: {challengerName}</p>
      </div>
      {/* çŠ¶æ€æ ‡ç­¾ */}
    </div>
  );
})}
```

**æ–‡ä»¶ä½ç½®ï¼š**
- `server.js:538-568` (API)
- `bigscreen/services/sealosService.ts:66-75` (æœåŠ¡å±‚)
- `bigscreen/main.tsx:84-95` (WebSocket)
- `bigscreen/components/ChallengeArenaCard.tsx:22-48` (ç»„ä»¶)

---

### 9.5 ç­çº§ç®¡ç†å­¦ç”Ÿè¯¦æƒ…é¡µç¼ºå°‘å‹‹ç« æˆäºˆè®°å½•

**ç—‡çŠ¶ï¼š**
- åœ¨ç­çº§ç®¡ç†çš„å­¦ç”Ÿä¸ªäººè¯¦æƒ…é¡µä¸­ï¼Œåªæ˜¾ç¤ºå‹‹ç« å›¾æ ‡å’Œåç§°
- æ²¡æœ‰æ˜¾ç¤ºå‹‹ç« çš„æˆäºˆæ—¥æœŸ

**è§£å†³æ–¹æ¡ˆï¼š**
é‡æ–°è®¾è®¡å‹‹ç« æ˜¾ç¤ºå¸ƒå±€ï¼Œæ·»åŠ æˆäºˆæ—¥æœŸä¿¡æ¯ï¼š

```typescript
// mobile/pages/ClassManage.tsx:1075-1122
// âŒ åŸå¸ƒå±€ - 3åˆ—ç®€å•æ˜¾ç¤º
<div className="grid grid-cols-3 gap-2">
  {badgeItems.map((b, i) => (
    <span key={`${b.id}-${i}`} className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-white border border-gray-200 text-gray-700 text-xs font-bold">
      <span>{b.icon}</span>
      <span>{b.name}</span>
    </span>
  ))}
</div>

// âœ… æ–°å¸ƒå±€ - 2åˆ—å¡ç‰‡å¼ï¼ŒåŒ…å«æˆäºˆæ—¥æœŸ
const formatDate = (dateStr?: string) => {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  const y = d.getFullYear();
  const m = `${d.getMonth()+1}`.padStart(2,'0');
  const dd = `${d.getDate()}`.padStart(2,'0');
  return `${y}-${m}-${dd}`;
};

<div className="grid grid-cols-2 gap-3">
  {badgeItems.map((b, i) => (
    <div key={`${b.id}-${i}`} className="flex flex-col p-2 rounded-lg bg-white border border-gray-200 shadow-sm">
      <div className="flex items-center gap-2 mb-1">
        <span className="text-lg">{b.icon}</span>
        <span className="text-xs font-bold text-gray-700">{b.name}</span>
      </div>
      <div className="text-[10px] text-gray-400 mt-1">
        æˆäºˆæ—¥æœŸ: {formatDate((b as any).awarded_at)}
      </div>
    </div>
  ))}
</div>
```

**æ”¹è¿›ç‚¹ï¼š**
1. ä» 3 åˆ—æ”¹ä¸º 2 åˆ—ï¼Œæ¯ä¸ªå‹‹ç« æœ‰æ›´å¤šç©ºé—´
2. ä»ç®€å•æ ‡ç­¾æ”¹ä¸ºå¡ç‰‡å¼è®¾è®¡
3. æ·»åŠ æˆäºˆæ—¥æœŸæ˜¾ç¤º
4. æ¯é¡µä» 12 ä¸ªæ”¹ä¸º 6 ä¸ªï¼Œä»¥å®¹çº³æ›´å¤šä¿¡æ¯

**æ–‡ä»¶ä½ç½®ï¼š** `mobile/pages/ClassManage.tsx:1075-1122`

---

### 9.6 å¤§å±ç«¯é™æ€èµ„æºè·¯å¾„é—®é¢˜

**ç—‡çŠ¶ï¼š**
- å¤§å±ç«¯é¡µé¢åŠ è½½åæ˜¾ç¤ºç©ºç™½
- æ§åˆ¶å°æ˜¾ç¤º 404 é”™è¯¯ï¼š`assets/index-CdmnUuP6.js` æ‰¾ä¸åˆ°

**æ ¹æœ¬åŸå› ï¼š**
- HTML ä¸­å¼•ç”¨ `/assets/index-CdmnUuP6.js`
- æœåŠ¡å™¨é…ç½® `/assets` æŒ‡å‘ `public/assets/`
- ä½†å®é™…æ–‡ä»¶åœ¨ `public/bigscreen/assets/`
- è·¯å¾„ä¸åŒ¹é…å¯¼è‡´æ–‡ä»¶æ— æ³•åŠ è½½

**è§£å†³æ–¹æ¡ˆï¼š**
```html
<!-- public/bigscreen/index.html -->
<!-- âŒ åŸè·¯å¾„ -->
<script type="module" crossorigin src="/assets/index-CdmnUuP6.js"></script>

<!-- âœ… ä¿®å¤å - ä½¿ç”¨æ­£ç¡®çš„ç›¸å¯¹è·¯å¾„ -->
<script type="module" crossorigin src="/bigscreen/assets/index-CdmnUuP6.js"></script>
```

**æœåŠ¡å™¨é…ç½®è¯´æ˜ï¼š**
```javascript
// server.js:58-60
app.use('/assets', express.static(path.join(__dirname, 'public/assets')));
app.use('/bigscreen', express.static(path.join(__dirname, 'public/bigscreen')));
```

- `/assets` â†’ `public/assets/` (ç§»åŠ¨ç«¯èµ„æº)
- `/bigscreen` â†’ `public/bigscreen/` (å¤§å±ç«¯èµ„æº)

**æ–‡ä»¶ä½ç½®ï¼š** `public/bigscreen/index.html:8`

---

## æ•°æ®åº“å­—æ®µæ˜ å°„è§„èŒƒ

### å‹‹ç« ç›¸å…³å­—æ®µ

| æ•°æ®åº“å­—æ®µ | API è¿”å›å­—æ®µ | å‰ç«¯ç±»å‹å®šä¹‰ | è¯´æ˜ |
|-----------|-------------|-------------|------|
| `awarded_at` | `awarded_at` | `awardedDate?` | å‹‹ç« æˆäºˆæ—¶é—´ |
| `badge_id` | `id` | `id` | å‹‹ç«  ID |
| `name` | `name` | `name` | å‹‹ç« åç§° |
| `icon` | `icon` | `icon` | å‹‹ç« å›¾æ ‡ |
| `description` | `description` | `description` | å‹‹ç« æè¿° |

**æ³¨æ„äº‹é¡¹ï¼š**
- å‰ç«¯ç±»å‹å®šä¹‰ä½¿ç”¨ `awardedDate`ï¼Œä½† API è¿”å› `awarded_at`
- éœ€è¦åœ¨å‰ç«¯åšå­—æ®µæ˜ å°„æˆ–å…¼å®¹å¤„ç†
- å»ºè®®ç»Ÿä¸€ä½¿ç”¨ `awarded_at` æˆ– `awardedDate`

### æŒ‘æˆ˜ç›¸å…³å­—æ®µ

| æ•°æ®åº“å­—æ®µ | API è¿”å›å­—æ®µ | å‰ç«¯ç±»å‹å®šä¹‰ | è¯´æ˜ |
|-----------|-------------|-------------|------|
| `challenger_id` | `challenger_id` | - | æŒ‘æˆ˜è€…å­¦ç”Ÿ ID |
| - | `challenger_name` | `challenger.name` | æŒ‘æˆ˜è€…å§“åï¼ˆJOIN è·å–ï¼‰ |
| - | `challenger_avatar` | `challenger.avatar` | æŒ‘æˆ˜è€…å¤´åƒï¼ˆJOIN è·å–ï¼‰ |
| `title` | `title` | `title` | æŒ‘æˆ˜æ ‡é¢˜ |
| `description` | `description` | `description` | æŒ‘æˆ˜æè¿° |
| `status` | `status` | `status` | æŒ‘æˆ˜çŠ¶æ€ |

**SQL JOIN ç¤ºä¾‹ï¼š**
```sql
SELECT
  c.id,
  c.title,
  c.description,
  c.status,
  c.challenger_id,
  s.name as challenger_name,
  s.avatar_url as challenger_avatar
FROM challenges c
LEFT JOIN students s ON c.challenger_id = s.id
```

---

## æ„å»ºå’Œéƒ¨ç½²æµç¨‹æ›´æ–°

### å®Œæ•´æ„å»ºæµç¨‹

```bash
# 1. æ„å»ºå¤§å±ç«¯
cd /home/devbox/project/arkok/bigscreen
npm run build

# 2. æ„å»ºç§»åŠ¨ç«¯
cd /home/devbox/project/arkok/mobile
npm run build

# 3. å¤åˆ¶æ„å»ºäº§ç‰©
cd /home/devbox/project/arkok
cp -r bigscreen/dist/* public/bigscreen/
cp -r mobile/dist/* public/

# 4. ä¿®å¤å¤§å±ç«¯èµ„æºè·¯å¾„ï¼ˆå¦‚æœéœ€è¦ï¼‰
# ç¡®ä¿ public/bigscreen/index.html ä¸­çš„ script src æŒ‡å‘ /bigscreen/assets/

# 5. é‡å¯æœåŠ¡å™¨
pkill -f "node.*server.js"
./entrypoint.sh start
```

### éªŒè¯æ¸…å•

- [ ] å¤§å±ç«¯å¯ä»¥æ­£å¸¸è®¿é—® (`/display` æˆ– `/screen`)
- [ ] å‹‹ç« å±•ç¤ºåŒºåŸŸæ˜¾ç¤ºæˆäºˆæ—¥æœŸ
- [ ] å‹‹ç« å¡ç‰‡æ˜¾ç¤ºå­¦ç”Ÿå¤´åƒ
- [ ] å‹‹ç« æ»šåŠ¨é€Ÿåº¦é€‚ä¸­ï¼ˆ80ç§’ï¼‰
- [ ] æŒ‘æˆ˜æ“‚å°æ˜¾ç¤ºæŒ‘æˆ˜è€…åç§°å’Œå¤´åƒ
- [ ] å­¦ç”Ÿè¯¦æƒ…é¡µæ˜¾ç¤ºå‹‹ç« æˆäºˆæ—¥æœŸ
- [ ] æ§åˆ¶å°æ—  404 é”™è¯¯
- [ ] æ§åˆ¶å°æ—  TypeScript é”™è¯¯

---

## æ•…éšœæ’æŸ¥æ›´æ–°

### ç—‡çŠ¶ï¼šå¤§å±ç«¯é¡µé¢ç©ºç™½

**æ£€æŸ¥æ­¥éª¤ï¼š**

1. **æ£€æŸ¥æ§åˆ¶å°é”™è¯¯**
```javascript
// æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
// æŸ¥çœ‹ Console æ ‡ç­¾é¡µ
// å¸¸è§é”™è¯¯ï¼š
// - 404: èµ„æºæ–‡ä»¶æ‰¾ä¸åˆ°
// - CORS: è·¨åŸŸè¯·æ±‚è¢«é˜»æ­¢
// - TypeError: æ•°æ®å­—æ®µä¸å­˜åœ¨
```

2. **æ£€æŸ¥ç½‘ç»œè¯·æ±‚**
```javascript
// æ‰“å¼€ Network æ ‡ç­¾é¡µ
// åˆ·æ–°é¡µé¢
// æ£€æŸ¥ï¼š
// - index.html æ˜¯å¦æˆåŠŸåŠ è½½ (200)
// - JS æ–‡ä»¶æ˜¯å¦æˆåŠŸåŠ è½½ (200)
// - API è¯·æ±‚æ˜¯å¦æˆåŠŸ (/api/students, /api/challenges)
```

3. **æ£€æŸ¥æ–‡ä»¶è·¯å¾„**
```bash
# éªŒè¯æ–‡ä»¶å­˜åœ¨
ls -la /home/devbox/project/arkok/public/bigscreen/assets/

# æ£€æŸ¥ HTML ä¸­çš„å¼•ç”¨è·¯å¾„
cat /home/devbox/project/arkok/public/bigscreen/index.html | grep "script"

# ç¡®ä¿è·¯å¾„åŒ¹é…
# HTML: /bigscreen/assets/index-XXX.js
# æ–‡ä»¶: public/bigscreen/assets/index-XXX.js
```

4. **æ£€æŸ¥æœåŠ¡å™¨é…ç½®**
```javascript
// server.js ä¸­çš„é™æ€æ–‡ä»¶é…ç½®
app.use('/bigscreen', express.static(path.join(__dirname, 'public/bigscreen')));

// ç¡®ä¿è·¯å¾„æ­£ç¡®
// URL: http://domain/bigscreen/assets/index.js
// æ˜ å°„åˆ°: public/bigscreen/assets/index.js
```

### ç—‡çŠ¶ï¼šå‹‹ç« æˆ–æŒ‘æˆ˜æ•°æ®ä¸æ˜¾ç¤º

**æ£€æŸ¥æ­¥éª¤ï¼š**

1. **æ£€æŸ¥ API è¿”å›æ•°æ®**
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
fetch('/api/students')
  .then(r => r.json())
  .then(d => {
    console.log('å­¦ç”Ÿæ•°æ®:', d.data[0]);
    console.log('å‹‹ç« æ•°æ®:', d.data[0].badges);
  });

fetch('/api/challenges')
  .then(r => r.json())
  .then(d => {
    console.log('æŒ‘æˆ˜æ•°æ®:', d.data[0]);
    console.log('æŒ‘æˆ˜è€…ä¿¡æ¯:', {
      name: d.data[0].challenger_name,
      avatar: d.data[0].challenger_avatar
    });
  });
```

2. **æ£€æŸ¥å­—æ®µæ˜ å°„**
```typescript
// ç¡®è®¤å‰ç«¯ä»£ç ä½¿ç”¨æ­£ç¡®çš„å­—æ®µå
// å‹‹ç« æ—¥æœŸ: awarded_at (API) vs awardedDate (å‰ç«¯)
// æŒ‘æˆ˜è€…: challenger_name (API) vs challenger.name (å‰ç«¯)
```

3. **æ£€æŸ¥æ•°æ®åº“**
```sql
-- æ£€æŸ¥å‹‹ç« æˆäºˆè®°å½•
SELECT sb.*, b.name, b.icon, s.name as student_name
FROM student_badges sb
JOIN badges b ON sb.badge_id = b.id
JOIN students s ON sb.student_id = s.id
LIMIT 5;

-- æ£€æŸ¥æŒ‘æˆ˜è®°å½•
SELECT c.*, s.name as challenger_name, s.avatar_url
FROM challenges c
LEFT JOIN students s ON c.challenger_id = s.id
LIMIT 5;
```

---

---

## é—®é¢˜ 10: PK æ¦œå’ŒæŒ‘æˆ˜æ“‚å°å¸ƒå±€é—®é¢˜ï¼ˆ2025-11-26ï¼‰

**ç—‡çŠ¶ï¼š**
- PK æ¦œå’ŒæŒ‘æˆ˜æ“‚å°çš„æ˜¾ç¤ºåŒºåŸŸå¸ƒå±€æ··ä¹±
- ä¹‹å‰æ˜¯å›ºå®šåœ¨ä¸€ä¸ªä½ç½®ä¸”å±å¹•è‡ªé€‚åº”
- ç°åœ¨é™æ­¢ä¸åŠ¨ï¼Œå†…å®¹è¶…å‡ºå±å¹•æ— æ³•æ»šåŠ¨

**æ ¹æœ¬åŸå› ï¼š**
- å¸ƒå±€ä½¿ç”¨äº† `flex-shrink-0` å’Œ `flex-grow`ï¼Œå¯¼è‡´é«˜åº¦åˆ†é…ä¸å‡
- PK æ¦œè®¾ç½®ä¸ºä¸æ”¶ç¼©ï¼Œå æ®äº†è¿‡å¤šç©ºé—´
- æŒ‘æˆ˜æ“‚å°è¢«å‹ç¼©ï¼Œæ— æ³•æ­£å¸¸æ˜¾ç¤º

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// bigscreen/main.tsx:132-139
// âŒ åŸå¸ƒå±€ - ä½¿ç”¨ flex-shrink-0 å’Œ flex-grow
<div className="lg:col-span-1 flex flex-col gap-6 h-full min-h-0">
  <div className="flex-shrink-0">
    <PKBoardCard pks={pks} teamsMap={teamsMap} students={students} />
  </div>
  <div className="flex-grow min-h-0">
    <ChallengeArenaCard challenges={challenges} />
  </div>
</div>

// âœ… ä¿®å¤å - ä½¿ç”¨å›ºå®šæ¯”ä¾‹åˆ†é…é«˜åº¦
<div className="lg:col-span-1 flex flex-col gap-6 h-full min-h-0">
  <div className="h-1/2 min-h-0">
    <PKBoardCard pks={pks} teamsMap={teamsMap} students={students} />
  </div>
  <div className="h-1/2 min-h-0">
    <ChallengeArenaCard challenges={challenges} />
  </div>
</div>
```

**å¸ƒå±€è¯´æ˜ï¼š**
- ä½¿ç”¨ `h-1/2` å°†å³ä¾§åˆ—å¹³å‡åˆ†é…ç»™ PK æ¦œå’ŒæŒ‘æˆ˜æ“‚å°
- æ¯ä¸ªç»„ä»¶å æ® 50% çš„é«˜åº¦
- `min-h-0` ç¡®ä¿å†…å®¹å¯ä»¥æ­£å¸¸æ»šåŠ¨
- ä¸¤ä¸ªç»„ä»¶éƒ½æœ‰å›ºå®šçš„å®¹å™¨é«˜åº¦ï¼Œå†…éƒ¨å¯ä»¥è‡ªé€‚åº”æ»šåŠ¨

**ç»„ä»¶å†…éƒ¨æ»šåŠ¨æœºåˆ¶ï¼š**

1. **PK æ¦œ** (`PKBoardCard.tsx`):
   - ä½¿ç”¨åˆ†é¡µæœºåˆ¶ï¼Œæ¯ 5 ç§’è‡ªåŠ¨ç¿»é¡µ
   - æ ¹æ®å®¹å™¨é«˜åº¦åŠ¨æ€è®¡ç®—æ¯é¡µæ˜¾ç¤ºçš„ PK æ•°é‡
   - ä½¿ç”¨ `ResizeObserver` ç›‘å¬å®¹å™¨å¤§å°å˜åŒ–

2. **æŒ‘æˆ˜æ“‚å°** (`ChallengeArenaCard.tsx`):
   - ä½¿ç”¨å‚ç›´æ»šåŠ¨åŠ¨ç”»
   - å†…å®¹é‡å¤ä¸¤æ¬¡å®ç°æ— ç¼å¾ªç¯
   - åŠ¨ç”»æ—¶é•¿æ ¹æ®æŒ‘æˆ˜æ•°é‡åŠ¨æ€è®¡ç®—

**æ–‡ä»¶ä½ç½®ï¼š** `bigscreen/main.tsx:132-139`

---

---

## é—®é¢˜ 11: æŒ‘æˆ˜æ“‚å°æŒ‘æˆ˜è€…ä¿¡æ¯ç¼ºå¤±çš„æ ¹æœ¬åŸå› ï¼ˆ2025-11-26ï¼‰

**ç—‡çŠ¶ï¼š**
- å³ä½¿ä¿®å¤äº† API å’Œå‰ç«¯æ˜¾ç¤ºä»£ç ï¼ŒæŒ‘æˆ˜æ“‚å°ä»ç„¶ä¸æ˜¾ç¤ºæŒ‘æˆ˜è€…åç§°
- æ‰€æœ‰ç°æœ‰æŒ‘æˆ˜çš„ `challenger_id` å­—æ®µéƒ½æ˜¯ `null`

**æ ¹æœ¬åŸå› ï¼š**
åˆ›å»ºæŒ‘æˆ˜æ—¶ï¼Œå‰ç«¯å’Œåç«¯éƒ½æ²¡æœ‰å¤„ç† `challenger_id` å­—æ®µï¼š

1. **åç«¯ API é—®é¢˜** (`server.js:497-533`):
   - åˆ›å»ºæŒ‘æˆ˜çš„ API æ²¡æœ‰æ¥æ”¶ `challenger_id` å‚æ•°
   - INSERT è¯­å¥ä¸­æ²¡æœ‰åŒ…å« `challenger_id` å­—æ®µ
   - å¯¼è‡´æ‰€æœ‰æ–°åˆ›å»ºçš„æŒ‘æˆ˜éƒ½æ²¡æœ‰æŒ‘æˆ˜è€…ä¿¡æ¯

2. **å‰ç«¯ä»£ç é—®é¢˜** (`mobile/pages/ClassManage.tsx:355-371`):
   - åˆ›å»ºæŒ‘æˆ˜æ—¶æ²¡æœ‰ä¼ é€’ `challenger_id` å‚æ•°
   - è™½ç„¶ UI ä¸­å¯ä»¥é€‰æ‹©å‚ä¸è€…ï¼Œä½†æ²¡æœ‰å°†å…¶ä½œä¸ºæŒ‘æˆ˜è€…å‘é€

**å®Œæ•´è§£å†³æ–¹æ¡ˆï¼š**

### æ­¥éª¤ 1ï¼šä¿®å¤åç«¯ API

```javascript
// server.js:497-552
app.post('/api/challenges', async (req, res) => {
  try {
    // âœ… æ·»åŠ  challenger_id å‚æ•°
    const { title, description, status = 'active', reward_points = 0, reward_exp = 0, challenger_id } = req.body;

    // âœ… INSERT è¯­å¥åŒ…å« challenger_id
    const result = await pool.query(
      `INSERT INTO challenges (title, description, status, reward_points, reward_exp, challenger_id)
       VALUES ($1, $2, $3, $4, $5, $6)
       RETURNING id, title, description, status, reward_points, reward_exp, challenger_id`,
      [title, description || '', status, reward_points, reward_exp, challenger_id || null]
    );

    // âœ… è·å–å®Œæ•´çš„æŒ‘æˆ˜ä¿¡æ¯ï¼ˆåŒ…æ‹¬æŒ‘æˆ˜è€…å§“åå’Œå¤´åƒï¼‰
    const challengeId = result.rows[0].id;
    const fullChallengeResult = await pool.query(`
      SELECT
        c.id,
        c.title,
        c.description,
        c.status,
        c.reward_points,
        c.reward_exp,
        c.challenger_id,
        s.name as challenger_name,
        s.avatar_url as challenger_avatar
      FROM challenges c
      LEFT JOIN students s ON c.challenger_id = s.id
      WHERE c.id = $1
    `, [challengeId]);

    const challengeData = fullChallengeResult.rows[0];

    // âœ… å¹¿æ’­å®Œæ•´çš„æŒ‘æˆ˜ä¿¡æ¯ï¼ˆåŒ…æ‹¬æŒ‘æˆ˜è€…ä¿¡æ¯ï¼‰
    wss.clients.forEach((client) => {
      if (client.readyState === 1) {
        client.send(JSON.stringify({
          type: 'challenge:created',
          payload: challengeData,
          timestamp: new Date().toISOString()
        }));
      }
    });

    res.status(201).json({
      success: true,
      data: challengeData,
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    console.error('Error creating challenge:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      timestamp: new Date().toISOString()
    });
  }
});
```

### æ­¥éª¤ 2ï¼šä¿®å¤å‰ç«¯ä»£ç 

```typescript
// mobile/pages/ClassManage.tsx:355-371
const handlePublishChallenge = async () => {
  if(newChallenge.title && newChallenge.desc) {
    const pts = parseInt(String((newChallenge as any).rewardPoints));
    const exp = parseInt(String((newChallenge as any).rewardExp));

    try {
      const protocol = window.location.protocol;
      const host = window.location.host;
      const apiUrl = `${protocol}//${host}/api`;

      // âœ… ä½¿ç”¨ç¬¬ä¸€ä¸ªå‚ä¸è€…ä½œä¸ºæŒ‘æˆ˜è€…
      const challengerId = newChallenge.participantIds && newChallenge.participantIds.length > 0
          ? newChallenge.participantIds[0]
          : null;

      const response = await fetch(`${apiUrl}/challenges`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
              title: newChallenge.title,
              description: newChallenge.desc,
              status: 'active',
              reward_points: isNaN(pts) ? 10 : pts,
              reward_exp: isNaN(exp) ? 0 : exp,
              challenger_id: challengerId  // âœ… æ·»åŠ æŒ‘æˆ˜è€… ID
          })
      });

      // ... å…¶ä½™ä»£ç 
    } catch (error) {
      console.error('Error publishing challenge:', error);
    }
  }
};
```

**ä¸šåŠ¡é€»è¾‘è¯´æ˜ï¼š**
- UI ä¸­çš„"é€‰æ‹©å­¦ç”Ÿ"åŠŸèƒ½ç”¨äºé€‰æ‹©æŒ‘æˆ˜å‚ä¸è€…
- ç¬¬ä¸€ä¸ªè¢«é€‰æ‹©çš„å­¦ç”Ÿè‡ªåŠ¨æˆä¸ºæŒ‘æˆ˜è€…ï¼ˆ`challenger_id`ï¼‰
- å¦‚æœæ²¡æœ‰é€‰æ‹©ä»»ä½•å­¦ç”Ÿï¼Œ`challenger_id` ä¸º `null`ï¼Œæ˜¾ç¤ºä¸º"æœªçŸ¥æŒ‘æˆ˜è€…"

**æ–‡ä»¶ä½ç½®ï¼š**
- `server.js:497-552` (åç«¯ API)
- `mobile/pages/ClassManage.tsx:355-371` (å‰ç«¯åˆ›å»ºé€»è¾‘)

**éªŒè¯æ–¹æ³•ï¼š**
1. åœ¨æ•™å¸ˆç«¯åˆ›å»ºæ–°æŒ‘æˆ˜ï¼Œé€‰æ‹©ä¸€ä¸ªå­¦ç”Ÿä½œä¸ºå‚ä¸è€…
2. å‘å¸ƒæŒ‘æˆ˜åï¼Œæ£€æŸ¥å¤§å±ç«¯æŒ‘æˆ˜æ“‚å°
3. åº”è¯¥èƒ½çœ‹åˆ°æŒ‘æˆ˜è€…çš„åç§°å’Œå¤´åƒ

**æ³¨æ„äº‹é¡¹ï¼š**
- å·²å­˜åœ¨çš„æŒ‘æˆ˜ï¼ˆ`challenger_id` ä¸º `null`ï¼‰ä»ç„¶ä¸ä¼šæ˜¾ç¤ºæŒ‘æˆ˜è€…
- éœ€è¦é‡æ–°åˆ›å»ºæŒ‘æˆ˜æˆ–æ‰‹åŠ¨æ›´æ–°æ•°æ®åº“ä¸­çš„ `challenger_id` å­—æ®µ
- å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ SQL æ›´æ–°ç°æœ‰æŒ‘æˆ˜ï¼š
```sql
-- ç¤ºä¾‹ï¼šå°†æŒ‘æˆ˜ ID ä¸º 1 çš„æŒ‘æˆ˜è€…è®¾ç½®ä¸ºå­¦ç”Ÿ ID ä¸º 16 çš„å­¦ç”Ÿ
UPDATE challenges SET challenger_id = 16 WHERE id = 1;
```

---

## é—®é¢˜ 12: æŒ‘æˆ˜å‚ä¸è€…æ•°æ®æŒä¹…åŒ–é—®é¢˜ï¼ˆ2025-11-26ï¼‰

### 12.1 æŒ‘æˆ˜å‚ä¸è€…åˆ·æ–°åä¸¢å¤±

**ç—‡çŠ¶ï¼š**
- æ‰‹æœºç«¯å‘å¸ƒæŒ‘æˆ˜å¹¶æŒ‡å®šå‚ä¸è€…åï¼Œå‚ä¸è€…åç§°ä¼šæ˜¾ç¤ºåœ¨"è¿›è¡Œä¸­"æ ‡ç­¾ä¸­
- åˆ·æ–°é¡µé¢åï¼Œå‚ä¸è€…ä¿¡æ¯æ¶ˆå¤±ï¼Œæ˜¾ç¤ºä¸º"æœªæŒ‡å®š"
- å­¦ç”Ÿä¸ªäººä¿¡æ¯é¡µä¸­çœ‹ä¸åˆ°æŒ‘æˆ˜è®°å½•

**æ ¹æœ¬åŸå› ï¼š**
1. åç«¯APIåˆ›å»ºæŒ‘æˆ˜æ—¶æ²¡æœ‰ä¿å­˜å‚ä¸è€…åˆ° `challenge_participants` è¡¨
2. åç«¯APIè¿”å›æŒ‘æˆ˜æ—¶æ²¡æœ‰åŒ…å«å‚ä¸è€…ä¿¡æ¯
3. å‰ç«¯åŠ è½½æŒ‘æˆ˜æ—¶å°†participantsè®¾ç½®ä¸ºç©ºæ•°ç»„

**è§£å†³æ–¹æ¡ˆåˆ†ä¸‰æ­¥ï¼š**

**æ­¥éª¤ 1ï¼šä¿®æ”¹åç«¯åˆ›å»ºæŒ‘æˆ˜API**
```javascript
// server.js:489-565
app.post('/api/challenges', async (req, res) => {
  try {
    // âœ… æ¥æ”¶ participant_ids å‚æ•°
    const { title, description, status = 'active', reward_points = 0, reward_exp = 0, challenger_id, participant_ids = [] } = req.body;

    // åˆ›å»ºæŒ‘æˆ˜
    const result = await pool.query(
      `INSERT INTO challenges (title, description, status, reward_points, reward_exp, challenger_id)
       VALUES ($1, $2, $3, $4, $5, $6)
       RETURNING id, title, description, status, reward_points, reward_exp, challenger_id`,
      [title, description || '', status, reward_points, reward_exp, challenger_id || null]
    );

    const challengeId = result.rows[0].id;

    // âœ… æ’å…¥å‚ä¸è€…åˆ° challenge_participants è¡¨
    if (participant_ids && participant_ids.length > 0) {
      for (const studentId of participant_ids) {
        await pool.query(
          `INSERT INTO challenge_participants (challenge_id, student_id)
           VALUES ($1, $2)
           ON CONFLICT DO NOTHING`,
          [challengeId, studentId]
        );
      }
    }

    // âœ… è·å–å®Œæ•´çš„æŒ‘æˆ˜ä¿¡æ¯ï¼ˆåŒ…æ‹¬å‚ä¸è€…ï¼‰
    const fullChallengeResult = await pool.query(`
      SELECT
        c.id,
        c.title,
        c.description,
        c.status,
        c.reward_points,
        c.reward_exp,
        c.challenger_id,
        s.name as challenger_name,
        s.avatar_url as challenger_avatar,
        COALESCE(
          json_agg(
            json_build_object('student_id', cp.student_id)
          ) FILTER (WHERE cp.student_id IS NOT NULL),
          '[]'
        ) as participants
      FROM challenges c
      LEFT JOIN students s ON c.challenger_id = s.id
      LEFT JOIN challenge_participants cp ON c.id = cp.challenge_id
      WHERE c.id = $1
      GROUP BY c.id, s.name, s.avatar_url
    `, [challengeId]);

    const challengeData = fullChallengeResult.rows[0];

    // å¹¿æ’­å’Œè¿”å›
    wss.clients.forEach((client) => {
      if (client.readyState === 1) {
        client.send(JSON.stringify({
          type: 'challenge:created',
          payload: challengeData,
          timestamp: new Date().toISOString()
        }));
      }
    });

    res.status(201).json({
      success: true,
      data: challengeData,
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    console.error('Error creating challenge:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      timestamp: new Date().toISOString()
    });
  }
});
```

**æ­¥éª¤ 2ï¼šä¿®æ”¹åç«¯è·å–æŒ‘æˆ˜API**
```javascript
// server.js:570-608
app.get('/api/challenges', async (req, res) => {
  try {
    const result = await pool.query(`
      SELECT
        c.id,
        c.title,
        c.description,
        c.status,
        c.reward_points,
        c.reward_exp,
        c.challenger_id,
        s.name as challenger_name,
        s.avatar_url as challenger_avatar,
        COALESCE(
          json_agg(
            json_build_object('student_id', cp.student_id)
          ) FILTER (WHERE cp.student_id IS NOT NULL),
          '[]'
        ) as participants
      FROM challenges c
      LEFT JOIN students s ON c.challenger_id = s.id
      LEFT JOIN challenge_participants cp ON c.id = cp.challenge_id
      GROUP BY c.id, s.name, s.avatar_url
      ORDER BY c.created_at DESC
    `);
    res.json({
      success: true,
      data: result.rows,
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    console.error('Error fetching challenges:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      timestamp: new Date().toISOString()
    });
  }
});
```

**æ­¥éª¤ 3ï¼šä¿®æ”¹å‰ç«¯å‘é€å‚ä¸è€…åˆ—è¡¨**
```typescript
// mobile/pages/ClassManage.tsx:360-395
const handlePublishChallenge = async () => {
  if(newChallenge.title && newChallenge.desc) {
    const pts = parseInt(String((newChallenge as any).rewardPoints));
    const exp = parseInt(String((newChallenge as any).rewardExp));

    try {
      const protocol = window.location.protocol;
      const host = window.location.host;
      const apiUrl = `${protocol}//${host}/api`;

      const challengerId = newChallenge.participantIds && newChallenge.participantIds.length > 0
          ? newChallenge.participantIds[0]
          : null;

      const response = await fetch(`${apiUrl}/challenges`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
              title: newChallenge.title,
              description: newChallenge.desc,
              status: 'active',
              reward_points: isNaN(pts) ? 10 : pts,
              reward_exp: isNaN(exp) ? 0 : exp,
              challenger_id: challengerId,
              participant_ids: newChallenge.participantIds || []  // âœ… å‘é€å®Œæ•´å‚ä¸è€…åˆ—è¡¨
          })
      });

      if (!response.ok) {
          console.error('Failed to publish challenge:', response.statusText);
          return;
      }

      const data = await response.json();
      if (data.success && data.data) {
          // âœ… ä»APIè¿”å›çš„participantsä¸­æå–student_id
          const participantIds = (data.data.participants || []).map((p: any) => String(p.student_id));

          setChallenges(prev => [{
              id: String(data.data.id),
              title: data.data.title,
              desc: data.data.description,
              status: data.data.status,
              participants: participantIds,
              rewardPoints: data.data.reward_points,
              rewardExp: data.data.reward_exp,
              date: new Date().toISOString()
          }, ...prev]);
      }
    } catch (error) {
        console.error('Error publishing challenge:', error);
    }

    setNewChallenge({ title: '', desc: '', participantIds: [], rewardPoints: '', rewardExp: '' } as any);
  }
};
```

**æ­¥éª¤ 4ï¼šä¿®æ”¹å‰ç«¯åŠ è½½æŒ‘æˆ˜æ•°æ®**
```typescript
// mobile/App.tsx:172-191
// å¤„ç†æŒ‘æˆ˜æ•°æ®
if (challengesRes.ok) {
  const challengesData = await challengesRes.json();
  if (challengesData.success && Array.isArray(challengesData.data)) {
    setChallenges(challengesData.data.map((c: any) => {
      // âœ… ä»APIè¿”å›çš„participantsä¸­æå–student_id
      const participantIds = (c.participants || []).map((p: any) => String(p.student_id));
      return {
        id: String(c.id),
        title: c.title,
        desc: c.description,
        status: c.status,
        participants: participantIds,
        rewardPoints: c.reward_points || 0,
        rewardExp: c.reward_exp || 0,
        date: new Date().toISOString()
      };
    }));
  }
}
```

**æ–‡ä»¶ä½ç½®ï¼š**
- `server.js:489-565` (åˆ›å»ºæŒ‘æˆ˜API)
- `server.js:570-608` (è·å–æŒ‘æˆ˜API)
- `mobile/pages/ClassManage.tsx:360-395` (å‘é€æŒ‘æˆ˜)
- `mobile/App.tsx:172-191` (åŠ è½½æŒ‘æˆ˜)

**éªŒè¯æ–¹æ³•ï¼š**
1. åœ¨æ•™å¸ˆç«¯åˆ›å»ºæ–°æŒ‘æˆ˜ï¼Œé€‰æ‹©å‚ä¸è€…
2. å‘å¸ƒæŒ‘æˆ˜åï¼ŒæŸ¥çœ‹æŒ‘æˆ˜åˆ—è¡¨ä¸­çš„å‚ä¸è€…ä¿¡æ¯
3. åˆ·æ–°é¡µé¢ï¼ŒéªŒè¯å‚ä¸è€…ä¿¡æ¯ä»ç„¶å­˜åœ¨
4. æŸ¥çœ‹å­¦ç”Ÿä¸ªäººä¿¡æ¯é¡µï¼ŒéªŒè¯æŒ‘æˆ˜è®°å½•æ˜¾ç¤º

**æ³¨æ„äº‹é¡¹ï¼š**
- å·²å­˜åœ¨çš„æŒ‘æˆ˜ï¼ˆåœ¨ä¿®å¤ä¹‹å‰åˆ›å»ºçš„ï¼‰çš„participantséƒ½æ˜¯ç©ºæ•°ç»„
- éœ€è¦é‡æ–°åˆ›å»ºæŒ‘æˆ˜æ‰èƒ½çœ‹åˆ°å‚ä¸è€…ä¿¡æ¯
- æˆ–è€…æ‰‹åŠ¨æ›´æ–°æ•°æ®åº“ï¼š
```sql
-- ä¸ºç°æœ‰æŒ‘æˆ˜æ·»åŠ å‚ä¸è€…
INSERT INTO challenge_participants (challenge_id, student_id)
VALUES (æŒ‘æˆ˜ID, å­¦ç”ŸID);
```

---

### 12.2 å­¦ç”Ÿä¸ªäººä¿¡æ¯é¡µæ•°æ®æ˜¾ç¤º

**å½“å‰çŠ¶æ€ï¼š**
- âœ… å‹‹ç« æˆäºˆè®°å½•ï¼šå·²æ­£ç¡®æ˜¾ç¤ºï¼ˆä»APIè¿”å›çš„badgesæ•°æ®ï¼‰
- âœ… ä»»åŠ¡è®°å½•ï¼šä»£ç ä¸­å·²æœ‰æ˜¾ç¤ºé€»è¾‘ï¼ˆä» `selectedStudent.taskHistory` è¯»å–ï¼‰
- âœ… æŒ‘æˆ˜è®°å½•ï¼šç°åœ¨å¯ä»¥æ­£ç¡®æ˜¾ç¤ºï¼ˆé€šè¿‡ `getStudentChallenges` å‡½æ•°è¿‡æ»¤ï¼‰
- âœ… PKè®°å½•ï¼šå·²æ­£ç¡®æ˜¾ç¤ºï¼ˆé€šè¿‡ `getStudentPKHistory` å‡½æ•°è¿‡æ»¤ï¼‰

**æ•°æ®æ¥æºï¼š**
```typescript
// mobile/pages/ClassManage.tsx:124-130
const getStudentChallenges = (studentId: string) => {
    return challenges.filter(c => c.participants.includes(studentId));
};

const getStudentPKHistory = (studentId: string) => {
    return pkMatches.filter(pk => (pk.studentA === studentId || pk.studentB === studentId) && pk.status === 'finished');
};
```

**æ–‡ä»¶ä½ç½®ï¼š** `mobile/pages/ClassManage.tsx:124-130, 987-1267`

---

## é—®é¢˜ 13: å¤§å±å‹‹ç« æ»šåŠ¨é€Ÿåº¦è¿‡å¿«ï¼ˆ2025-11-26ï¼‰

**ç—‡çŠ¶ï¼š**
- å¤§å±ç«¯è£èª‰å‹‹ç« æ¨ªå‘æ»šåŠ¨é€Ÿåº¦å¤ªå¿«
- ç”¨æˆ·æ— æ³•çœ‹æ¸…å‹‹ç« å†…å®¹

**è§£å†³æ–¹æ¡ˆï¼š**
```css
/* mobile/bigscreen/components/HonorBadgesCard.tsx:85 */
/* âŒ åŸé…ç½® */
animation: scroll 50s linear infinite;

/* âœ… ä¿®å¤å - è°ƒæ•´ä¸ºæ›´æ…¢çš„é€Ÿåº¦ */
animation: scroll 120s linear infinite;
```

**è°ƒæ•´è¯´æ˜ï¼š**
- ä» 50 ç§’å¢åŠ åˆ° 120 ç§’
- æ»šåŠ¨é€Ÿåº¦é™ä½ 58.3%
- ç”¨æˆ·æœ‰æ›´å¤šæ—¶é—´é˜…è¯»å‹‹ç« ä¿¡æ¯

**æ–‡ä»¶ä½ç½®ï¼š** `mobile/bigscreen/components/HonorBadgesCard.tsx:85`

---

## æ•°æ®æŒä¹…åŒ–éªŒè¯

æ‰€æœ‰æ•°æ®éƒ½å·²æ­£ç¡®è¿æ¥åˆ°PostgreSQLæ•°æ®åº“ï¼š

| åŠŸèƒ½ | æ•°æ®è¡¨ | çŠ¶æ€ |
|------|--------|------|
| å­¦ç”Ÿä¿¡æ¯ | `students` | âœ… å·²è¿æ¥ |
| æŒ‘æˆ˜æ•°æ® | `challenges` | âœ… å·²è¿æ¥ |
| æŒ‘æˆ˜å‚ä¸è€… | `challenge_participants` | âœ… å·²è¿æ¥ |
| å‹‹ç« æˆäºˆè®°å½• | `student_badges` | âœ… å·²è¿æ¥ |
| ä»»åŠ¡åˆ†é… | `task_assignments` | âœ… å·²è¿æ¥ |
| PKè®°å½• | `pk_matches` | âœ… å·²è¿æ¥ |
| ä¹ æƒ¯æ‰“å¡ | `habit_checkins` | âœ… å·²è¿æ¥ |
| ç§¯åˆ†å†å² | `score_history` | âœ… å·²è¿æ¥ |

**éªŒè¯æ–¹æ³•ï¼š**
```bash
# è¿æ¥æ•°æ®åº“
PGPASSWORD=kngwb5cb psql -h ep-weathered-bird-a1yjvqxo.ap-southeast-1.aws.neon.tech -U neondb_owner -d neondb

# æŸ¥çœ‹æŒ‘æˆ˜å‚ä¸è€…
SELECT c.title, s.name as participant
FROM challenges c
JOIN challenge_participants cp ON c.id = cp.challenge_id
JOIN students s ON cp.student_id = s.id;

# æŸ¥çœ‹å‹‹ç« æˆäºˆè®°å½•
SELECT s.name, b.name as badge_name, sb.awarded_at
FROM student_badges sb
JOIN students s ON sb.student_id = s.id
JOIN badges b ON sb.badge_id = b.id
ORDER BY sb.awarded_at DESC;
```

---

## è·¯ç”±æ¸…ç†

**å·²åˆ é™¤çš„è·¯ç”±ï¼š**
- âŒ `/display` - æ—§çš„å¤§å±ç«¯è·¯ç”±ï¼ˆå·²åˆ é™¤ï¼‰
- âŒ `/display/*` - æ—§çš„å¤§å±ç«¯hashè·¯ç”±ï¼ˆå·²åˆ é™¤ï¼‰

**å½“å‰ä½¿ç”¨çš„è·¯ç”±ï¼š**
- âœ… `/screen` - å¤§å±ç«¯ï¼ˆæ­£å¼ä½¿ç”¨ï¼‰
- âœ… `/screen/*` - å¤§å±ç«¯hashè·¯ç”±
- âœ… `/admin` - æ•™å¸ˆç«¯/ç®¡ç†ç«¯
- âœ… `/student` - å­¦ç”Ÿç«¯

**ä»£ç ç»“æ„ï¼š**
- **æ­£åœ¨ä½¿ç”¨ï¼š** `mobile/bigscreen/` - ä½¿ç”¨HTTPè½®è¯¢çš„æ–°ç‰ˆæœ¬
- **å·²åºŸå¼ƒï¼š** `bigscreen.old.backup/` - ä½¿ç”¨WebSocketçš„æ—§ç‰ˆæœ¬ï¼ˆå·²å¤‡ä»½ï¼‰

**æ–‡ä»¶ä½ç½®ï¼š** `server.js:70-82`

---

---

## é—®é¢˜ 14: æ•°æ®æŒä¹…åŒ–å’Œä¸ªäººä¿¡æ¯é¡µæ˜¾ç¤ºé—®é¢˜ï¼ˆ2025-11-26 ä¸‹åˆï¼‰

### 14.1 ä»»åŠ¡æ‰§è¡Œäººåˆ·æ–°åä¸¢å¤±

**ç—‡çŠ¶ï¼š**
- å‘å¸ƒä»»åŠ¡å¹¶æŒ‡å®šæ‰§è¡Œäººåï¼Œä»»åŠ¡åˆ—è¡¨æ˜¾ç¤ºæ‰§è¡Œäººåç§°
- åˆ·æ–°é¡µé¢åï¼Œæ‰§è¡Œäººä¿¡æ¯æ¶ˆå¤±

**æ ¹æœ¬åŸå› ï¼š**
1. åç«¯ GET /api/tasks åªè¿”å›ä»»åŠ¡åŸºæœ¬ä¿¡æ¯ï¼Œæ²¡æœ‰è¿”å›æ‰§è¡Œäºº
2. å‰ç«¯åŠ è½½ä»»åŠ¡æ—¶å¼ºåˆ¶è®¾ç½® `assignedTo: []`

**è§£å†³æ–¹æ¡ˆï¼š**

**æ­¥éª¤ 1ï¼šä¿®æ”¹åç«¯ä»»åŠ¡APIè¿”å›æ‰§è¡Œäººä¿¡æ¯**
```javascript
// server.js:818-855
app.get('/api/tasks', async (req, res) => {
  try {
    const result = await pool.query(`
      SELECT
        t.id,
        t.title,
        t.description,
        t.exp_value,
        COALESCE(
          json_agg(
            json_build_object(
              'student_id', ta.student_id,
              'student_name', s.name,
              'student_avatar', s.avatar_url
            )
          ) FILTER (WHERE ta.student_id IS NOT NULL),
          '[]'
        ) as assigned_to
      FROM tasks t
      LEFT JOIN task_assignments ta ON t.id = ta.task_id
      LEFT JOIN students s ON ta.student_id = s.id
      GROUP BY t.id
      ORDER BY t.id DESC
    `);
    res.json({
      success: true,
      data: result.rows,
      timestamp: new Date().toISOString()
    });
  } catch (error) {
    console.error('Error fetching tasks:', error);
    res.status(500).json({
      success: false,
      error: error.message,
      timestamp: new Date().toISOString()
    });
  }
});
```

**æ­¥éª¤ 2ï¼šä¿®æ”¹å‰ç«¯åŠ è½½ä»»åŠ¡æ•°æ®**
```typescript
// mobile/App.tsx:231
// âŒ åŸä»£ç 
assignedTo: []

// âœ… ä¿®å¤å
assignedTo: (t.assigned_to || []).map((a: any) => String(a.student_id))
```

**æ–‡ä»¶ä½ç½®ï¼š**
- `server.js:818-855`
- `mobile/App.tsx:231`

---

### 14.2 æŒ‘æˆ˜äººåˆ·æ–°åä¸¢å¤±

**ç—‡çŠ¶ï¼š**
- å‘å¸ƒæŒ‘æˆ˜å¹¶æŒ‡å®šæŒ‘æˆ˜äººåï¼ŒæŒ‘æˆ˜åˆ—è¡¨ä¸æ˜¾ç¤ºæŒ‘æˆ˜äººåç§°
- è¿‡å¾€æŒ‘æˆ˜é¡µé¢ä¹Ÿä¸æ˜¾ç¤ºæŒ‘æˆ˜äºº

**æ ¹æœ¬åŸå› ï¼š**
1. Challenge ç±»å‹å®šä¹‰ç¼ºå°‘ `challengerId`, `challengerName`, `challengerAvatar` å­—æ®µ
2. å‰ç«¯åŠ è½½æŒ‘æˆ˜æ•°æ®æ—¶æ²¡æœ‰ä¿å­˜æŒ‘æˆ˜äººä¿¡æ¯
3. å‰ç«¯æ˜¾ç¤ºæ—¶ä½¿ç”¨é”™è¯¯çš„å­—æ®µï¼ˆ`participants[0]` è€Œä¸æ˜¯ `challengerName`ï¼‰

**è§£å†³æ–¹æ¡ˆï¼š**

**æ­¥éª¤ 1ï¼šæ·»åŠ  Challenge ç±»å‹å­—æ®µ**
```typescript
// mobile/types.ts:41-54
export interface Challenge {
  id: string;
  title: string;
  desc: string;
  status: 'active' | 'completed';
  result?: 'success' | 'fail';
  participants: string[];
  challengerId?: string;        // âœ… æ–°å¢
  challengerName?: string;      // âœ… æ–°å¢
  challengerAvatar?: string;    // âœ… æ–°å¢
  rewardPoints: number;
  rewardExp?: number;
  date?: string;
}
```

**æ­¥éª¤ 2ï¼šä¿®æ”¹å‰ç«¯åŠ è½½æŒ‘æˆ˜æ•°æ®**
```typescript
// mobile/App.tsx:185-187
challengerId: c.challenger_id ? String(c.challenger_id) : undefined,
challengerName: c.challenger_name || undefined,
challengerAvatar: c.challenger_avatar || undefined,
```

**æ­¥éª¤ 3ï¼šä¿®æ”¹å‰ç«¯æ˜¾ç¤ºæŒ‘æˆ˜äºº**
```typescript
// mobile/pages/ClassManage.tsx:1701, 1725
// âŒ åŸä»£ç 
{students.find(s=>s.id===c.participants[0])?.name || 'æœªæŒ‡å®š'}

// âœ… ä¿®å¤å
æŒ‘æˆ˜äºº: {c.challengerName || (c.challengerId && students.find(s=>s.id===c.challengerId)?.name) || 'æœªæŒ‡å®š'}
```

**æ–‡ä»¶ä½ç½®ï¼š**
- `mobile/types.ts:48-50`
- `mobile/App.tsx:185-187`
- `mobile/pages/ClassManage.tsx:1701, 1725`

---

### 14.3 å‹‹ç« æˆäºˆè®°å½•ä¸æ˜¾ç¤º

**ç—‡çŠ¶ï¼š**
- ç»™å­¦ç”Ÿæˆäºˆå‹‹ç« åï¼Œå­¦ç”Ÿä¸ªäººä¿¡æ¯é¡µä¸æ˜¾ç¤ºå‹‹ç« è®°å½•
- åˆ·æ–°é¡µé¢åå‹‹ç« è®°å½•æ¶ˆå¤±

**æ ¹æœ¬åŸå› ï¼š**
1. Student ç±»å‹å®šä¹‰ä¸­åªæœ‰ `badgeHistory` å­—æ®µï¼Œæ²¡æœ‰ `badges` å­—æ®µ
2. å‰ç«¯ä»£ç ä½¿ç”¨ `selectedStudent.badges` æ¥æ˜¾ç¤ºå‹‹ç« 
3. å‰ç«¯åŠ è½½å­¦ç”Ÿæ•°æ®æ—¶åªä¿å­˜äº† `badgeHistory`ï¼Œæ²¡æœ‰ä¿å­˜ `badges`

**è§£å†³æ–¹æ¡ˆï¼š**

**æ­¥éª¤ 1ï¼šæ·»åŠ  Student ç±»å‹çš„ badges å­—æ®µ**
```typescript
// mobile/types.ts:29
export interface Student {
  // ... å…¶ä»–å­—æ®µ
  badges?: Array<{id: number; name: string; icon: string; awarded_at: string}>;  // âœ… æ–°å¢
  badgeHistory?: StudentBadgeRecord[];
}
```

**æ­¥éª¤ 2ï¼šä¿®æ”¹å‰ç«¯åŠ è½½å­¦ç”Ÿæ•°æ®æ—¶ä¿å­˜ badges**
```typescript
// mobile/App.tsx:122, 356, 431
// åœ¨æ‰€æœ‰åŠ è½½å­¦ç”Ÿæ•°æ®çš„åœ°æ–¹æ·»åŠ 
badges: apiStudent.badges || [],
```

**æ–‡ä»¶ä½ç½®ï¼š**
- `mobile/types.ts:29`
- `mobile/App.tsx:122, 356, 431`

---

### 14.4 ä¸ªäººä¿¡æ¯é¡µå†å²è®°å½•ç”Ÿæˆ

**ç—‡çŠ¶ï¼š**
- å­¦ç”Ÿä¸ªäººä¿¡æ¯é¡µä¸æ˜¾ç¤ºä»»åŠ¡ã€æŒ‘æˆ˜ã€PKè®°å½•
- å³ä½¿æ•°æ®åº“ä¸­æœ‰æ•°æ®ï¼Œå‰ç«¯ä¹Ÿä¸æ˜¾ç¤º

**æ ¹æœ¬åŸå› ï¼š**
- `taskHistory`, `challengeHistory`, `pkHistory` å­—æ®µä»æ¥æ²¡æœ‰è¢«å¡«å……
- è¿™äº›å­—æ®µéœ€è¦ä» `tasks`, `challenges`, `pkMatches` æ•°æ®ä¸­è®¡ç®—ç”Ÿæˆ

**è§£å†³æ–¹æ¡ˆï¼š**

æ·»åŠ  useEffect è‡ªåŠ¨ç”Ÿæˆå†å²è®°å½•ï¼š

```typescript
// mobile/App.tsx:253-320
useEffect(() => {
  setStudents(prevStudents => prevStudents.map(student => {
    // ç”Ÿæˆä»»åŠ¡å†å²ï¼šåˆå¹¶å½“å‰ä»»åŠ¡å’Œå·²å®Œæˆä»»åŠ¡
    const currentTasks = tasks
      .filter(t => t.assignedTo?.includes(student.id))
      .map(t => ({
        id: `task-${t.id}-${student.id}`,
        taskId: t.id,
        title: t.title,
        exp: t.expValue || 0,
        date: t.createdAt || new Date().toISOString()
      }));

    // ä¿ç•™å·²å®Œæˆçš„ä»»åŠ¡ï¼ˆä¸åœ¨å½“å‰tasksåˆ—è¡¨ä¸­çš„ï¼‰
    const existingTaskHistory = student.taskHistory || [];
    const completedTasks = existingTaskHistory.filter(
      th => !tasks.find(t => t.id === th.taskId)
    );

    // åˆå¹¶å¹¶å»é‡ï¼ˆä½¿ç”¨ taskId å»é‡ï¼‰
    const taskHistoryMap = new Map();
    [...completedTasks, ...currentTasks].forEach(t => {
      taskHistoryMap.set(t.taskId, t);
    });
    const taskHistory = Array.from(taskHistoryMap.values());

    // ç”ŸæˆæŒ‘æˆ˜å†å²
    const challengeHistory = challenges
      .filter(c => c.participants.includes(student.id) || c.challengerId === student.id)
      .filter(c => c.status === 'completed')
      .map(c => ({...}));

    // ç”ŸæˆPKå†å²
    const pkHistory = pkMatches
      .filter(pk => pk.studentA === student.id || pk.studentB === student.id)
      .filter(pk => pk.status === 'finished')
      .map(pk => ({...}));

    return { ...student, taskHistory, challengeHistory, pkHistory };
  }));
}, [tasks, challenges, pkMatches]);
```

**å…³é”®ç‚¹ï¼š**
- ä»»åŠ¡å†å²åˆå¹¶å½“å‰ä»»åŠ¡å’Œå·²å®Œæˆä»»åŠ¡ï¼Œé¿å…ä»»åŠ¡å®Œæˆåæ¶ˆå¤±
- ä½¿ç”¨ `taskId` ä½œä¸ºå»é‡keyï¼Œé¿å…å¤šäººä»»åŠ¡é‡å¤æ˜¾ç¤º
- æŒ‘æˆ˜å†å²åªæ˜¾ç¤ºå·²å®Œæˆçš„æŒ‘æˆ˜
- PKå†å²åªæ˜¾ç¤ºå·²å®Œæˆçš„PK

**æ–‡ä»¶ä½ç½®ï¼š** `mobile/App.tsx:253-320`

---

### 14.5 ä¸ªäººä¿¡æ¯é¡µUIä¼˜åŒ–

**æ”¹è¿›å†…å®¹ï¼š**

1. **ä»»åŠ¡è®°å½•æ˜¾ç¤ºä¼˜åŒ–**
   - æ˜¾ç¤ºæ‰€æœ‰ä»»åŠ¡ï¼ˆè¿›è¡Œä¸­ + å·²å®Œæˆï¼‰
   - åŒºåˆ†çŠ¶æ€ï¼šè¿›è¡Œä¸­ï¼ˆæ©™è‰²ï¼‰/ å·²å®Œæˆï¼ˆç»¿è‰²ï¼‰
   - ä¸Šä¸‹æ»‘åŠ¨æŸ¥çœ‹ï¼ˆæœ€å¤§é«˜åº¦300pxï¼‰
   - æ˜¾ç¤ºæœ€è¿‘ä¸€ä¸ªæœˆçš„ä»»åŠ¡
   - æŒ‰æ—¥æœŸå€’åºæ’åˆ—

2. **æŒ‘æˆ˜è®°å½•æ˜¾ç¤ºä¼˜åŒ–**
   - æ˜¾ç¤ºæ‰€æœ‰å·²å®Œæˆçš„æŒ‘æˆ˜
   - åŒºåˆ†ç»“æœï¼šæˆåŠŸï¼ˆç»¿è‰²ï¼‰/ å¤±è´¥ï¼ˆçº¢è‰²ï¼‰
   - æ˜¾ç¤ºç§¯åˆ†å’Œç»éªŒå¥–åŠ±
   - ä¸Šä¸‹æ»‘åŠ¨æŸ¥çœ‹ï¼ˆæœ€å¤§é«˜åº¦300pxï¼‰
   - æ˜¾ç¤ºæœ€è¿‘ä¸€ä¸ªæœˆçš„æŒ‘æˆ˜

3. **PKè®°å½•æ˜¾ç¤ºä¼˜åŒ–**
   - æ˜¾ç¤ºæ‰€æœ‰å·²å®Œæˆçš„PK
   - åŒºåˆ†ç»“æœï¼šèƒœï¼ˆé»„è‰²ï¼‰/ è´¥ï¼ˆç°è‰²ï¼‰
   - æ˜¾ç¤ºå¯¹æ‰‹å§“åå’ŒPKä¸»é¢˜
   - ä¸Šä¸‹æ»‘åŠ¨æŸ¥çœ‹ï¼ˆæœ€å¤§é«˜åº¦300pxï¼‰
   - æ˜¾ç¤ºæœ€è¿‘ä¸€ä¸ªæœˆçš„PK

4. **å‹‹ç« å’Œä¹ æƒ¯ä¿æŒå·¦å³ç¿»é¡µ**
   - å‹‹ç« ï¼šæ¯é¡µ6ä¸ª
   - ä¹ æƒ¯ï¼šæ¯é¡µ9ä¸ª

**ä»£ç ç¤ºä¾‹ï¼š**
```typescript
// mobile/pages/ClassManage.tsx:1259-1352
<div className="max-h-[300px] overflow-y-auto space-y-2.5 pr-1">
  {selectedStudent.taskHistory
    .filter(rec => {
      const taskDate = new Date(rec.date);
      const oneMonthAgo = new Date();
      oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
      return taskDate >= oneMonthAgo;
    })
    .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime())
    .map(rec => {
      const task = tasks.find(t => t.id === rec.taskId);
      const isCompleted = !task;
      return (
        <div className="flex items-center justify-between bg-white p-3 rounded-xl border border-gray-100">
          <div className="flex flex-col flex-1">
            <div className="flex items-center gap-2">
              <span className="text-xs font-bold text-gray-800">{rec.title}</span>
              {isCompleted ? (
                <span className="text-[9px] font-bold px-1.5 py-0.5 rounded-full bg-green-100 text-green-600">å·²å®Œæˆ</span>
              ) : (
                <span className="text-[9px] font-bold px-1.5 py-0.5 rounded-full bg-orange-100 text-orange-600">è¿›è¡Œä¸­</span>
              )}
            </div>
            <span className="text-[10px] text-gray-400">{new Date(rec.date).toLocaleDateString()}</span>
          </div>
          <span className="text-[10px] font-bold px-2 py-0.5 rounded-full bg-blue-50 text-blue-600">ç»éªŒ + {rec.exp}</span>
        </div>
      );
    })
  }
</div>
```

**æ–‡ä»¶ä½ç½®ï¼š** `mobile/pages/ClassManage.tsx:1170-1352`

---

### 14.6 æŒ‘æˆ˜å‘å¸ƒé€»è¾‘ä¼˜åŒ–

**ç—‡çŠ¶ï¼š**
- æŒ‘æˆ˜å‘å¸ƒæ—¶é€‰æ‹©å­¦ç”Ÿåï¼Œé€‰æ‹©æ¡†æ²¡æœ‰æ¸…ç©º
- æ— æ³•åƒä»»åŠ¡å‘å¸ƒé‚£æ ·è‡ªåŠ¨é”å®šå­¦ç”Ÿ

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// mobile/pages/ClassManage.tsx:1645-1651
// âŒ åŸä»£ç 
onChange={e=>{
  const selectedId = e.target.value;
  setChallengeSelectId(selectedId);
  if (selectedId && !newChallenge.participantIds.includes(selectedId)) {
    setNewChallenge({...newChallenge, participantIds: [...newChallenge.participantIds, selectedId]});
  }
}}

// âœ… ä¿®å¤å
onChange={e=>{
  const selectedId = e.target.value;
  if (selectedId && !newChallenge.participantIds.includes(selectedId)) {
    setNewChallenge({...newChallenge, participantIds: [...newChallenge.participantIds, selectedId]});
    setChallengeSelectId(''); // æ¸…ç©ºé€‰æ‹©æ¡†ï¼Œå®ç°è‡ªåŠ¨é”å®š
  }
}}
```

**æ•ˆæœï¼š**
- é€‰æ‹©å­¦ç”Ÿåç«‹å³æ·»åŠ åˆ°æŒ‘æˆ˜äººåˆ—è¡¨
- é€‰æ‹©æ¡†è‡ªåŠ¨æ¸…ç©ºï¼Œå¯ä»¥ç»§ç»­é€‰æ‹©å…¶ä»–å­¦ç”Ÿ
- ä¸ä»»åŠ¡å‘å¸ƒé€»è¾‘ä¿æŒä¸€è‡´

**æ–‡ä»¶ä½ç½®ï¼š** `mobile/pages/ClassManage.tsx:1645-1651`

---

### 14.7 å¤šäººä»»åŠ¡é‡å¤æ˜¾ç¤ºé—®é¢˜

**ç—‡çŠ¶ï¼š**
- ä¸€ä¸ªä»»åŠ¡åˆ†é…ç»™å¤šä¸ªå­¦ç”Ÿæ—¶ï¼Œæ¯ä¸ªå­¦ç”Ÿçš„ä¸ªäººä¿¡æ¯é¡µéƒ½æ˜¾ç¤ºå¤šæ¡ç›¸åŒçš„ä»»åŠ¡è®°å½•
- ä¾‹å¦‚ï¼šä»»åŠ¡åˆ†é…ç»™å´é€¸æ¡å’Œåºå­ç¥ï¼Œä¸¤äººçš„ä»»åŠ¡è®°å½•ä¸­éƒ½å‡ºç°2æ¡ç›¸åŒçš„è®°å½•

**æ ¹æœ¬åŸå› ï¼š**
- ç”Ÿæˆ taskHistory æ—¶ä½¿ç”¨ `task-${t.id}-${student.id}` ä½œä¸º id
- ä½†æ˜¯åœ¨ Map å»é‡æ—¶ä½¿ç”¨ `t.id` ä½œä¸º key
- å¯¼è‡´åŒä¸€ä¸ªä»»åŠ¡ä¸ºä¸åŒå­¦ç”Ÿç”Ÿæˆäº†å¤šæ¡è®°å½•

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// mobile/App.tsx:273-278
// âŒ åŸä»£ç 
const taskHistoryMap = new Map<string, StudentTaskRecord>();
[...completedTasks, ...currentTasks].forEach(t => {
  taskHistoryMap.set(t.id, t);  // ä½¿ç”¨ t.id å»é‡
});

// âœ… ä¿®å¤å
const taskHistoryMap = new Map<string, StudentTaskRecord>();
[...completedTasks, ...currentTasks].forEach(t => {
  taskHistoryMap.set(t.taskId, t);  // ä½¿ç”¨ t.taskId å»é‡ï¼Œç¡®ä¿æ¯ä¸ªä»»åŠ¡åªå‡ºç°ä¸€æ¬¡
});
```

**æ•ˆæœï¼š**
- æ¯ä¸ªå­¦ç”Ÿçš„ä»»åŠ¡è®°å½•ä¸­ï¼Œæ¯ä¸ªä»»åŠ¡åªæ˜¾ç¤ºä¸€æ¬¡
- å¤šäººä»»åŠ¡ä¸ä¼šé‡å¤æ˜¾ç¤º

**æ–‡ä»¶ä½ç½®ï¼š** `mobile/App.tsx:276`

---

### 14.8 å¤§å±PKé¡µé¢åˆ‡æ¢é€»è¾‘ä¼˜åŒ–

**éœ€æ±‚ï¼š**
- PKé¡µé¢æ¯é¡µå›ºå®šæ˜¾ç¤º3ç§’
- åˆ°è¾¾æœ€åä¸€é¡µååœæ­¢ï¼Œä¸è¦å¾ªç¯å›ç¬¬ä¸€é¡µ

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// mobile/bigscreen/components/PKBoardCard.tsx:53-61
// âŒ åŸä»£ç 
useEffect(() => {
  if (pages.length <= 1) return
  const t = setInterval(() => setPage(p => (p + 1) % pages.length), 5000)
  return () => clearInterval(t)
}, [pages.length])

// âœ… ä¿®å¤å
useEffect(() => {
  if (pages.length <= 1) return
  const t = setInterval(() => setPage(p => {
    // åˆ°è¾¾æœ€åä¸€é¡µååœæ­¢ï¼Œä¸å†å¾ªç¯
    if (p >= pages.length - 1) return p
    return p + 1
  }), 3000) // æ¯é¡µå›ºå®š3ç§’
  return () => clearInterval(t)
}, [pages.length])
```

**æ”¹è¿›ç‚¹ï¼š**
- åˆ‡æ¢é—´éš”ä»5ç§’æ”¹ä¸º3ç§’
- åˆ°è¾¾æœ€åä¸€é¡µååœæ­¢è‡ªåŠ¨åˆ‡æ¢
- ä¸å†å¾ªç¯å›ç¬¬ä¸€é¡µ

**æ–‡ä»¶ä½ç½®ï¼š** `mobile/bigscreen/components/PKBoardCard.tsx:53-61`

---

### 14.9 ç­çº§ç®¡ç†é¡µæŒ‘æˆ˜åˆ—è¡¨ä¼˜åŒ–

**æ”¹è¿›å†…å®¹ï¼š**

1. **è¿‡å¾€æŒ‘æˆ˜æ ‡ç­¾ä¼˜åŒ–**
   - ä»"å·²å®Œæˆ"/"æœªå®Œæˆ"æ”¹ä¸º"æˆåŠŸ"/"å¤±è´¥"
   - æ›´æ¸…æ™°åœ°è¡¨è¾¾æŒ‘æˆ˜ç»“æœ

```typescript
// mobile/pages/ClassManage.tsx:1760-1761
// âŒ åŸä»£ç 
{c.result === 'success' ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}

// âœ… ä¿®å¤å
{c.result === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}
```

**æ–‡ä»¶ä½ç½®ï¼š** `mobile/pages/ClassManage.tsx:1760-1761`

---

## å®Œæ•´ä¿®æ”¹æ–‡ä»¶æ¸…å•ï¼ˆ2025-11-26ï¼‰

### åç«¯ä¿®æ”¹
1. **server.js**
   - ä¿®æ”¹ GET /api/tasks APIï¼Œè¿”å›æ‰§è¡Œäººä¿¡æ¯ï¼ˆç¬¬818-855è¡Œï¼‰

### å‰ç«¯ç±»å‹å®šä¹‰
2. **mobile/types.ts**
   - æ·»åŠ  Challenge ç±»å‹çš„æŒ‘æˆ˜äººå­—æ®µï¼ˆç¬¬48-50è¡Œï¼‰
   - æ·»åŠ  Student ç±»å‹çš„ badges å­—æ®µï¼ˆç¬¬29è¡Œï¼‰

### å‰ç«¯æ ¸å¿ƒé€»è¾‘
3. **mobile/App.tsx**
   - æ·»åŠ ç±»å‹å¯¼å…¥ï¼ˆç¬¬11è¡Œï¼‰
   - ä¿®å¤ä»»åŠ¡æ•°æ®åŠ è½½ï¼ˆç¬¬231è¡Œï¼‰
   - ä¿®å¤æŒ‘æˆ˜æ•°æ®åŠ è½½ï¼ˆç¬¬185-187è¡Œï¼‰
   - æ·»åŠ å­¦ç”Ÿ badges å­—æ®µåŠ è½½ï¼ˆç¬¬122, 356, 431è¡Œï¼‰
   - æ·»åŠ å†å²è®°å½•ç”Ÿæˆé€»è¾‘ï¼ˆç¬¬253-320è¡Œï¼‰
   - ä¿®å¤å¤šäººä»»åŠ¡å»é‡é€»è¾‘ï¼ˆç¬¬276è¡Œï¼‰

### å‰ç«¯UIç»„ä»¶
4. **mobile/pages/ClassManage.tsx**
   - ä¿®å¤æŒ‘æˆ˜å‘å¸ƒé€»è¾‘ï¼ˆç¬¬1645-1651è¡Œï¼‰
   - ä¿®å¤æŒ‘æˆ˜äººæ˜¾ç¤ºï¼ˆç¬¬1701, 1725è¡Œï¼‰
   - åˆ é™¤é‡å¤çš„æŒ‘æˆ˜è®°å½•æ˜¾ç¤ºï¼ˆç¬¬1170-1218è¡Œï¼‰
   - ä¼˜åŒ–ä»»åŠ¡è®°å½•æ˜¾ç¤ºï¼ˆç¬¬1263-1306è¡Œï¼‰
   - æ·»åŠ æŒ‘æˆ˜è®°å½•æ˜¾ç¤ºï¼ˆç¬¬1308-1352è¡Œï¼‰
   - ä¼˜åŒ–PKè®°å½•æ˜¾ç¤ºï¼ˆç¬¬1221-1261è¡Œï¼‰
   - ä¿®æ”¹è¿‡å¾€æŒ‘æˆ˜æ ‡ç­¾ï¼ˆç¬¬1760-1761è¡Œï¼‰

5. **mobile/bigscreen/components/PKBoardCard.tsx**
   - ä¿®æ”¹PKé¡µé¢åˆ‡æ¢é€»è¾‘ï¼ˆç¬¬53-61è¡Œï¼‰

---

## æ•°æ®æµç¨‹å›¾

### ä»»åŠ¡æ•°æ®æµç¨‹
```
åˆ›å»ºä»»åŠ¡ â†’ task_assignmentsè¡¨ â†’ GET /api/tasksè¿”å›assigned_to
         â†“
    å‰ç«¯åŠ è½½ â†’ ç”ŸæˆtaskHistory â†’ æ˜¾ç¤ºåœ¨ä¸ªäººä¿¡æ¯é¡µ
         â†“
    å®Œæˆä»»åŠ¡ â†’ åˆ é™¤ä»»åŠ¡ â†’ taskHistoryä¿ç•™å·²å®Œæˆè®°å½•
```

### æŒ‘æˆ˜æ•°æ®æµç¨‹
```
åˆ›å»ºæŒ‘æˆ˜ â†’ challengesè¡¨(challenger_id) + challenge_participantsè¡¨
         â†“
    GET /api/challengesè¿”å›challenger_nameå’Œparticipants
         â†“
    å‰ç«¯åŠ è½½ â†’ ä¿å­˜challengerId/challengerName â†’ æ˜¾ç¤ºæŒ‘æˆ˜äºº
         â†“
    ç”ŸæˆchallengeHistory â†’ æ˜¾ç¤ºåœ¨ä¸ªäººä¿¡æ¯é¡µ
```

### å‹‹ç« æ•°æ®æµç¨‹
```
æˆäºˆå‹‹ç«  â†’ student_badgesè¡¨
         â†“
    GET /api/studentsè¿”å›badgesæ•°ç»„
         â†“
    å‰ç«¯åŠ è½½ â†’ åŒæ—¶ä¿å­˜badgeså’ŒbadgeHistory
         â†“
    ä¸ªäººä¿¡æ¯é¡µä½¿ç”¨badgeså­—æ®µæ˜¾ç¤º
```

---

## æµ‹è¯•éªŒè¯æ¸…å•ï¼ˆ2025-11-26ï¼‰

- [x] ä»»åŠ¡æ‰§è¡Œäººåˆ·æ–°åä¿æŒ
- [x] æŒ‘æˆ˜äººåˆ·æ–°åä¿æŒ
- [x] å‹‹ç« æˆäºˆè®°å½•åˆ·æ–°åä¿æŒ
- [x] ä¸ªäººä¿¡æ¯é¡µæ˜¾ç¤ºä»»åŠ¡è®°å½•ï¼ˆè¿›è¡Œä¸­+å·²å®Œæˆï¼‰
- [x] ä¸ªäººä¿¡æ¯é¡µæ˜¾ç¤ºæŒ‘æˆ˜è®°å½•ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
- [x] ä¸ªäººä¿¡æ¯é¡µæ˜¾ç¤ºPKè®°å½•
- [x] ä¸ªäººä¿¡æ¯é¡µæ˜¾ç¤ºå‹‹ç« è®°å½•
- [x] å¤šäººä»»åŠ¡ä¸é‡å¤æ˜¾ç¤º
- [x] æŒ‘æˆ˜å‘å¸ƒé€‰æ‹©å­¦ç”Ÿåè‡ªåŠ¨é”å®š
- [x] å¤§å±PKé¡µé¢3ç§’åˆ‡æ¢ï¼Œä¸å¾ªç¯
- [x] ç­çº§ç®¡ç†é¡µè¿‡å¾€æŒ‘æˆ˜æ˜¾ç¤º"æˆåŠŸ"/"å¤±è´¥"æ ‡ç­¾

---

**æœ€åæ›´æ–°ï¼š** 2025å¹´11æœˆ26æ—¥ 15:00
**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 2.4
**ä½œè€…ï¼š** Claude Code
**æ›´æ–°å†…å®¹ï¼š**
- ä¿®å¤ä»»åŠ¡æ‰§è¡Œäººæ•°æ®æŒä¹…åŒ–é—®é¢˜
- ä¿®å¤æŒ‘æˆ˜äººæ•°æ®æŒä¹…åŒ–é—®é¢˜
- ä¿®å¤å‹‹ç« æˆäºˆè®°å½•æ˜¾ç¤ºé—®é¢˜
- æ·»åŠ ä¸ªäººä¿¡æ¯é¡µå†å²è®°å½•è‡ªåŠ¨ç”Ÿæˆé€»è¾‘
- ä¿®å¤å¤šäººä»»åŠ¡é‡å¤æ˜¾ç¤ºé—®é¢˜
- ä¼˜åŒ–æŒ‘æˆ˜å‘å¸ƒé€»è¾‘
- ä¼˜åŒ–ä¸ªäººä¿¡æ¯é¡µUIå¸ƒå±€
- ä¿®å¤å¤§å±PKé¡µé¢åˆ‡æ¢é€»è¾‘
- å®Œå–„æ•°æ®æµç¨‹è¯´æ˜

---

## 2025å¹´11æœˆ27æ—¥æ›´æ–°è®°å½•

### æ›´æ–°æ¦‚è¿°
æœ¬æ¬¡æ›´æ–°ä¸»è¦ä¼˜åŒ–äº†å‹‹ç« ç³»ç»Ÿã€æŒ‘æˆ˜ç³»ç»Ÿã€PKç³»ç»Ÿçš„æ˜¾ç¤ºå’Œäº¤äº’é€»è¾‘ï¼Œä¿®å¤äº†å¤šä¸ªæ•°æ®åŒæ­¥é—®é¢˜ã€‚

### 1. æ‰‹æœºç«¯é¦–é¡µå­¦ç”Ÿæ’åºä¼˜åŒ–
**é—®é¢˜ï¼š** å­¦ç”Ÿæ˜¾ç¤ºé¡ºåºä¸æ˜ç¡®
**è§£å†³æ–¹æ¡ˆï¼š**
- æ–‡ä»¶ï¼š`mobile/pages/Home.tsx:23`
- ä¿®æ”¹ï¼šæŒ‰ç»éªŒå€¼ï¼ˆexpï¼‰é™åºæ’åº
- å®ç°ï¼š`.sort((a, b) => (b.exp || 0) - (a.exp || 0))`

### 2. å¤§å±ç«¯PKé¡µæ»šåŠ¨é€»è¾‘ä¼˜åŒ–
**é—®é¢˜ï¼š** PKé¡µé¢æ¥å›åˆ‡æ¢ï¼Œç”¨æˆ·ä½“éªŒä¸ä½³
**è§£å†³æ–¹æ¡ˆï¼š**
- æ–‡ä»¶ï¼š`mobile/bigscreen/components/PKBoardCard.tsx:59-64`
- ä¿®æ”¹ï¼šå®ç°æ— é™å¾ªç¯æ»šåŠ¨ï¼ˆä»å³å¾€å·¦ï¼‰
- æŠ€æœ¯ï¼šä½¿ç”¨å¤åˆ¶ç¬¬ä¸€é¡µåˆ°æœ«å°¾çš„æŠ€å·§ï¼Œæ»šåŠ¨åˆ°å¤åˆ¶é¡µåç¬é—´è·³å›çœŸæ­£çš„ç¬¬ä¸€é¡µ
- é€Ÿåº¦ï¼šæ¯é¡µ4ç§’

### 3. å­¦ç”Ÿå¤´åƒæ ·å¼æ›´æ–°
**é—®é¢˜ï¼š** åŸæœ‰å¤´åƒé£æ ¼ä¸ç¬¦åˆéœ€æ±‚
**è§£å†³æ–¹æ¡ˆï¼š**
- ä½¿ç”¨è‡ªå®šä¹‰å¤´åƒå›¾ç‰‡ï¼ˆ1024.jpgï¼‰
- æ–‡ä»¶ä½ç½®ï¼š`public/assets/student-avatar.jpg`
- æ•°æ®åº“æ›´æ–°ï¼šæ‰€æœ‰28ä¸ªå­¦ç”Ÿçš„avatar_urlç»Ÿä¸€æŒ‡å‘è‡ªå®šä¹‰å¤´åƒ
- é£æ ¼ï¼šæ‰å¹³é£æ ¼Qç‰ˆå°å­¦ç”Ÿå½¢è±¡

### 4. æŒ‘æˆ˜ç³»ç»Ÿå®Œæ•´ä¿®å¤

#### 4.1 æŒ‘æˆ˜å¤±è´¥ä¸åŠ ç»éªŒå’Œç§¯åˆ†
**é—®é¢˜ï¼š** ç‚¹å‡»"å¤±è´¥"æŒ‰é’®åä»ç„¶åŠ åˆ†
**è§£å†³æ–¹æ¡ˆï¼š**
- æ–‡ä»¶ï¼š`mobile/App.tsx:542-553`
- ä¿®æ”¹ï¼šåªæœ‰`result === 'success'`æ—¶æ‰åŠ ç»éªŒå’Œç§¯åˆ†
- å¤±è´¥æ—¶åªè®°å½•å†å²ï¼Œä¸åŠ ä»»ä½•å¥–åŠ±

#### 4.2 æŒ‘æˆ˜çŠ¶æ€æ­£ç¡®æ˜¾ç¤º
**é—®é¢˜ï¼š** å¤§å±ç«¯æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ˜¾ç¤º"æˆåŠŸ"
**è§£å†³æ–¹æ¡ˆï¼š**
- åç«¯APIï¼š`server.js:578` - GET /api/challenges è¿”å› result å­—æ®µ
- åç«¯APIï¼š`server.js:620-621` - PUT /api/challenges/:id æ›´æ–° result å­—æ®µ
- å¤§å±ç«¯ï¼š`mobile/bigscreen/main.tsx:78-91` - æ ¹æ® status å’Œ result ç»¼åˆåˆ¤æ–­æ˜¾ç¤ºçŠ¶æ€

#### 4.3 æŒ‘æˆ˜è€…åç§°æ˜¾ç¤º
**é—®é¢˜ï¼š** æ‰‹æœºç«¯è¿›è¡Œä¸­çš„æŒ‘æˆ˜æ˜¾ç¤º"æœªæŒ‡å®šæŒ‘æˆ˜è€…"
**è§£å†³æ–¹æ¡ˆï¼š**
- æ–‡ä»¶ï¼š`mobile/pages/ClassManage.tsx:392-394`
- ä¿®æ”¹ï¼šä»APIè¿”å›æ•°æ®ä¸­æå– challengerIdã€challengerNameã€challengerAvatar

#### 4.4 ä¸ªäººä¿¡æ¯é¡µæŒ‘æˆ˜è®°å½•æ˜¾ç¤ºä¼˜åŒ–
**é—®é¢˜ï¼š** å¤±è´¥çš„æŒ‘æˆ˜ä»æ˜¾ç¤º"+ç§¯åˆ†"å’Œ"+ç»éªŒ"
**è§£å†³æ–¹æ¡ˆï¼š**
- æ–‡ä»¶ï¼š`mobile/pages/ClassManage.tsx:1328-1337`
- ä¿®æ”¹ï¼šåªæœ‰æˆåŠŸçš„æŒ‘æˆ˜æ‰æ˜¾ç¤ºå¥–åŠ±æ ‡ç­¾

### 5. å‹‹ç« ç³»ç»Ÿå…¨é¢ä¼˜åŒ–

#### 5.1 å‹‹ç« æˆäºˆåæ˜¾ç¤ºé—®é¢˜
**é—®é¢˜ï¼š** æˆäºˆå‹‹ç« åï¼Œæ‰‹æœºç«¯å’Œå¤§å±ç«¯ä¸æ˜¾ç¤º
**è§£å†³æ–¹æ¡ˆï¼š**
- åç«¯APIï¼š`server.js:155` - GET /api/students è¿”å›å®Œæ•´å‹‹ç« ä¿¡æ¯ï¼ˆåŒ…å«descriptionï¼‰
- å‰ç«¯ï¼š`mobile/App.tsx:694-706` - handleBadgeGrant æ›´æ–°å­¦ç”Ÿçš„ badges æ•°ç»„
- å¤§å±ç«¯ï¼š`mobile/bigscreen/main.tsx:134-141` - æ­£ç¡®æ˜ å°„å‹‹ç« æ•°æ®
- å¤§å±ç«¯ï¼š`mobile/bigscreen/main.tsx:286` - ä½¿ç”¨çœŸå®å­¦ç”Ÿæ•°æ®è€Œéæ¨¡æ‹Ÿæ•°æ®

#### 5.2 å‹‹ç« åˆ›å»ºæŒä¹…åŒ–
**é—®é¢˜ï¼š** æ–°åˆ›å»ºçš„å‹‹ç« åˆ·æ–°åæ¶ˆå¤±
**è§£å†³æ–¹æ¡ˆï¼š**
- åç«¯APIï¼š`server.js:962-992` - æ·»åŠ  POST /api/badges æ¥å£
- å‰ç«¯ï¼š`mobile/pages/ClassManage.tsx:725-752` - è°ƒç”¨APIä¿å­˜åˆ°æ•°æ®åº“
- åé¦ˆï¼šä½¿ç”¨ç»¿è‰²å¼¹çª—æ˜¾ç¤º"âœ… å‹‹ç« ã€ŒXXã€åˆ›å»ºæˆåŠŸï¼"

#### 5.3 å‹‹ç« ç¼–è¾‘åŠŸèƒ½
**é—®é¢˜ï¼š** å‹‹ç« ç¼–è¾‘åå¤§å±ç«¯ä¸æ›´æ–°
**è§£å†³æ–¹æ¡ˆï¼š**
- åç«¯APIï¼š`server.js:1015-1032` - PUT /api/badges/:id æ›´æ–°å‹‹ç« ä¿¡æ¯
- å‰ç«¯ï¼š`mobile/pages/ClassManage.tsx:815-822` - æ˜¾ç¤ºæˆåŠŸåé¦ˆ
- å¤§å±ç«¯ï¼šæ¯2ç§’è½®è¯¢è‡ªåŠ¨æ›´æ–°ï¼ˆé€šè¿‡JOIN badgesè¡¨è·å–æœ€æ–°æ•°æ®ï¼‰

#### 5.4 å‹‹ç« æˆäºˆè®°å½•
**æ–°åŠŸèƒ½ï¼š** æ·»åŠ å‹‹ç« æˆäºˆè®°å½•åŒºåŸŸ
**å®ç°ï¼š**
- åç«¯APIï¼š`server.js:1015-1032` - GET /api/badge-grants è¿”å›æœ€è¿‘ä¸€ä¸ªæœˆè®°å½•
- å‰ç«¯ï¼š`mobile/pages/ClassManage.tsx:1988-2007` - æ˜¾ç¤ºå‹‹ç« åç§°ã€æˆäºˆäººã€æ—¥æœŸ
- ä½ç½®ï¼šåœ¨å‹‹ç« æˆäºˆå’Œå‹‹ç« ç¼–è¾‘ä¹‹é—´
- æ’åºï¼šæŒ‰æ—¥æœŸé™åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰
- åˆ·æ–°ï¼šæˆäºˆå‹‹ç« åè‡ªåŠ¨åˆ·æ–°è®°å½•

#### 5.5 ä¸ªäººä¿¡æ¯é¡µå‹‹ç« å¡ç‰‡ç®€åŒ–
**ä¼˜åŒ–ï¼š** ç®€åŒ–å‹‹ç« å¡ç‰‡æ˜¾ç¤º
**ä¿®æ”¹ï¼š**
- æ–‡ä»¶ï¼š`mobile/pages/ClassManage.tsx:1146-1153`
- åˆ é™¤iconæ˜¾ç¤º
- åˆ é™¤"æˆäºˆ"ä¸¤å­—
- åªæ˜¾ç¤ºå‹‹ç« åç§°å’Œæ—¥æœŸ
- ç¼©å°å¡ç‰‡é—´è·

#### 5.6 å¤§å±ç«¯å‹‹ç« æ˜¾ç¤ºä¼˜åŒ–
**ä¼˜åŒ–ï¼š** å‹‹ç« æŒ‰æ—¥æœŸæ’åºï¼Œæ»šåŠ¨é€Ÿåº¦è°ƒæ•´
**ä¿®æ”¹ï¼š**
- æ–‡ä»¶ï¼š`mobile/bigscreen/components/HonorBadgesCard.tsx:59-64`
- æ’åºï¼šæŒ‰awarded_até™åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
- é€Ÿåº¦ï¼šä»120ç§’è°ƒæ•´ä¸º240ç§’ï¼ˆ4åˆ†é’Ÿå®Œæˆä¸€ä¸ªå¾ªç¯ï¼‰
- æ¸…ç†ï¼šåˆ é™¤æ— ç”¨çš„æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆä»£ç ï¼ˆgeneratedBadgesï¼‰

### 6. æ–°å¢APIæ¥å£

#### 6.1 åˆ›å»ºå‹‹ç« 
```
POST /api/badges
Body: { name, description, icon }
Response: { success, data: { id, name, description, icon } }
```

#### 6.2 æ›´æ–°å‹‹ç« 
```
PUT /api/badges/:id
Body: { name, description }
Response: { success, data: { id, name, description, icon } }
```

#### 6.3 è·å–å‹‹ç« æˆäºˆè®°å½•
```
GET /api/badge-grants
Response: { success, data: [{ id, badge_name, student_name, awarded_at }] }
```

### 7. æ•°æ®åº“å˜æ›´

#### 7.1 å‹‹ç« è¡¨ï¼ˆbadgesï¼‰
- å·²æœ‰å­—æ®µï¼šid, name, description, icon, created_at
- è¯´æ˜ï¼šdescriptionå­—æ®µç°åœ¨åœ¨æ‰€æœ‰APIä¸­è¿”å›

#### 7.2 å­¦ç”Ÿå‹‹ç« å…³è”è¡¨ï¼ˆstudent_badgesï¼‰
- å·²æœ‰å­—æ®µï¼šid, student_id, badge_id, awarded_at
- è¯´æ˜ï¼šé€šè¿‡JOIN badgesè¡¨è·å–æœ€æ–°å‹‹ç« ä¿¡æ¯

#### 7.3 æŒ‘æˆ˜è¡¨ï¼ˆchallengesï¼‰
- å·²æœ‰å­—æ®µï¼šid, title, description, status, result, challenger_id, reward_points, reward_exp
- è¯´æ˜ï¼šresultå­—æ®µï¼ˆsuccess/failï¼‰ç°åœ¨æ­£ç¡®æ›´æ–°å’Œè¿”å›

### 8. å‰ç«¯æ¶æ„ä¼˜åŒ–

#### 8.1 çŠ¶æ€ç®¡ç†
- æ·»åŠ  badgeGrants çŠ¶æ€ï¼šå­˜å‚¨å‹‹ç« æˆäºˆè®°å½•
- ä¼˜åŒ– students çŠ¶æ€ï¼šåŒ…å«å®Œæ•´çš„ badges æ•°ç»„

#### 8.2 æ•°æ®æµå‘
```
å‹‹ç« åˆ›å»ºæµç¨‹ï¼š
å‰ç«¯è¡¨å• â†’ POST /api/badges â†’ æ•°æ®åº“ â†’ è¿”å›æ–°å‹‹ç«  â†’ æ›´æ–°æœ¬åœ°çŠ¶æ€ â†’ æ˜¾ç¤ºåé¦ˆ

å‹‹ç« æˆäºˆæµç¨‹ï¼š
å‰ç«¯é€‰æ‹© â†’ POST /api/students/:id/badges/:badgeId â†’ student_badgesè¡¨
         â†“
    æ›´æ–°studentsçŠ¶æ€ï¼ˆæ·»åŠ åˆ°badgesæ•°ç»„ï¼‰
         â†“
    åˆ·æ–°æˆäºˆè®°å½• â†’ GET /api/badge-grants
         â†“
    å¤§å±ç«¯è½®è¯¢ â†’ GET /api/students â†’ è·å–æœ€æ–°badges â†’ æ˜¾ç¤º

å‹‹ç« ç¼–è¾‘æµç¨‹ï¼š
å‰ç«¯è¡¨å• â†’ PUT /api/badges/:id â†’ æ›´æ–°badgesè¡¨ â†’ æ˜¾ç¤ºåé¦ˆ
         â†“
    å¤§å±ç«¯è½®è¯¢ â†’ GET /api/students â†’ JOIN badgesè¡¨ â†’ è·å–æœ€æ–°åç§°/æè¿°
```

### 9. ç”¨æˆ·ä½“éªŒä¼˜åŒ–

#### 9.1 åé¦ˆæœºåˆ¶ç»Ÿä¸€
- å‹‹ç« åˆ›å»ºæˆåŠŸï¼šç»¿è‰²å¼¹çª—ï¼Œ2ç§’è‡ªåŠ¨æ¶ˆå¤±
- å‹‹ç« ç¼–è¾‘æˆåŠŸï¼šç»¿è‰²å¼¹çª—ï¼Œ2ç§’è‡ªåŠ¨æ¶ˆå¤±
- å‹‹ç« æˆäºˆæˆåŠŸï¼šç»¿è‰²å¼¹çª—ï¼Œæ˜¾ç¤ºæˆäºˆäººæ•°
- æ ·å¼ï¼šä¸ä¹ æƒ¯æ‰“å¡åé¦ˆä¿æŒä¸€è‡´

#### 9.2 å¤§å±ç«¯å®æ—¶æ›´æ–°
- å­¦ç”Ÿæ•°æ®ï¼šæ¯2ç§’è½®è¯¢ä¸€æ¬¡
- å‹‹ç« æ•°æ®ï¼šé€šè¿‡å­¦ç”Ÿæ•°æ®è‡ªåŠ¨æ›´æ–°
- æŒ‘æˆ˜æ•°æ®ï¼šæ¯5ç§’è½®è¯¢ä¸€æ¬¡
- PKæ•°æ®ï¼šæ¯2ç§’è½®è¯¢ä¸€æ¬¡

### 10. ä»£ç æ¸…ç†

#### 10.1 åˆ é™¤æ— ç”¨ä»£ç 
- åˆ é™¤ generatedBadges æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆé€»è¾‘ï¼ˆçº¦40è¡Œï¼‰
- åˆ é™¤ realBadges æœªä½¿ç”¨çš„çŠ¶æ€å˜é‡
- æ¸…ç†å¤§å±ç«¯æ— ç”¨çš„å‹‹ç« æ¨¡æ‹Ÿæ•°æ®

#### 10.2 ä»£ç ä¼˜åŒ–
- ç»Ÿä¸€åé¦ˆæ˜¾ç¤ºæ ·å¼
- ä¼˜åŒ–æ•°æ®æ˜ å°„é€»è¾‘
- æ”¹è¿›é”™è¯¯å¤„ç†

### 11. æµ‹è¯•éªŒè¯æ¸…å•ï¼ˆ2025-11-27ï¼‰

- [x] æ‰‹æœºç«¯é¦–é¡µæŒ‰ç»éªŒå€¼æ’åº
- [x] å¤§å±ç«¯PKé¡µæ— é™å¾ªç¯æ»šåŠ¨ï¼ˆ4ç§’/é¡µï¼‰
- [x] å­¦ç”Ÿå¤´åƒç»Ÿä¸€ä¸ºè‡ªå®šä¹‰å›¾ç‰‡
- [x] æŒ‘æˆ˜å¤±è´¥ä¸åŠ ç»éªŒå’Œç§¯åˆ†
- [x] æŒ‘æˆ˜çŠ¶æ€æ­£ç¡®æ˜¾ç¤ºï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
- [x] æŒ‘æˆ˜è€…åç§°æ­£ç¡®æ˜¾ç¤º
- [x] ä¸ªäººä¿¡æ¯é¡µæŒ‘æˆ˜è®°å½•åªæ˜¾ç¤ºæˆåŠŸçš„å¥–åŠ±
- [x] å‹‹ç« åˆ›å»ºåä¿å­˜åˆ°æ•°æ®åº“
- [x] å‹‹ç« æˆäºˆåæ‰‹æœºç«¯å’Œå¤§å±ç«¯éƒ½æ˜¾ç¤º
- [x] å‹‹ç« ç¼–è¾‘åå¤§å±ç«¯è‡ªåŠ¨æ›´æ–°
- [x] å‹‹ç« æˆäºˆè®°å½•æ˜¾ç¤ºæœ€è¿‘ä¸€ä¸ªæœˆ
- [x] ä¸ªäººä¿¡æ¯é¡µå‹‹ç« å¡ç‰‡ç®€åŒ–æ˜¾ç¤º
- [x] å¤§å±ç«¯å‹‹ç« æŒ‰æ—¥æœŸæ’åº
- [x] å¤§å±ç«¯å‹‹ç« æ»šåŠ¨é€Ÿåº¦è°ƒæ…¢
- [x] å‹‹ç« åˆ›å»º/ç¼–è¾‘æˆåŠŸæ˜¾ç¤ºç»¿è‰²åé¦ˆ

### 12. å¾…å®ç°åŠŸèƒ½

- [ ] å‹‹ç« æˆäºˆè®°å½•é•¿æŒ‰åˆ é™¤
- [ ] PKè®°å½•é•¿æŒ‰åˆ é™¤
- [ ] æ›´å¤šç”¨æˆ·äº¤äº’ä¼˜åŒ–

---

**æœ€åæ›´æ–°ï¼š** 2025å¹´11æœˆ27æ—¥ 13:00
**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 2.5
**ä½œè€…ï¼š** Claude Code
**æ›´æ–°å†…å®¹ï¼š**
- å®Œæ•´è®°å½•å‹‹ç« ç³»ç»Ÿä¼˜åŒ–
- å®Œæ•´è®°å½•æŒ‘æˆ˜ç³»ç»Ÿä¿®å¤
- æ·»åŠ æ–°å¢APIæ¥å£æ–‡æ¡£
- æ›´æ–°æ•°æ®æµå‘è¯´æ˜
- æ·»åŠ æµ‹è¯•éªŒè¯æ¸…å•
- è®°å½•ä»£ç æ¸…ç†å†…å®¹
