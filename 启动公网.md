# 公网访问启动指南

## ⚠️ 重要提示：确认公网网址

**每次创建新的 Devbox 实例时，公网网址都会改变！**

在开始之前，请先确认您当前的公网网址：

1. **查看 Devbox 控制台**：在 Sealos Devbox 控制台中查看当前实例的公网访问地址
2. **当前配置的网址**：`https://esboimzbkure.sealosbja.site`
3. **确认问题**：
   - ❓ 这是您当前 Devbox 实例的公网网址吗？
   - ❓ 如果网址已改变，请先更新技术文档中的生产环境URL

**如何更新网址：**
```bash
# 1. 在技术文档中搜索并替换旧网址
# 文件位置：/home/devbox/project/arkok/TECHNICAL_DOCUMENTATION.md

# 2. 使用以下命令批量替换（将 NEW_URL 替换为您的新网址）
cd /home/devbox/project/arkok
sed -i 's|esboimzbkure.sealosbja.site|NEW_URL|g' TECHNICAL_DOCUMENTATION.md
sed -i 's|esboimzbkure.sealosbja.site|NEW_URL|g' 启动公网.md

# 3. 提交更改到 GitHub
git add .
git commit -m "更新生产环境公网地址"
git push origin master
```

---

## 问题现象
公网地址长时间处于「准备中」状态

## 解决方案

### 1. 项目结构说明

本项目为 **arkok** 多应用系统，包含：
- **手机端程序**：对应公网访问路径 `/app`
- **大屏端程序**：对应公网访问路径 `/screen`

项目结构：
```
/home/devbox/project/
├── arkok/                      # 主项目目录
│   ├── server.js              # 后端服务器（Express + WebSocket）
│   ├── .env                   # 数据库配置文件
│   ├── public/                # 静态文件目录
│   │   ├── index.html         # 手机端（访问路径：/app）
│   │   └── bigscreen/         # 大屏端静态文件（访问路径：/screen）
│   ├── mobile/                # 手机端源码
│   └── bigscreen/             # 大屏端源码
└── entrypoint.sh              # 启动脚本
```

### 2. 启动服务

在 Devbox 实例中运行启动命令：

```bash
cd /home/devbox/project
./entrypoint.sh
```

或者使用后台启动：

```bash
cd /home/devbox/project
nohup ./entrypoint.sh > server.log 2>&1 &
```

### 3. 关键检查点

#### ✅ 监听地址配置
- **必须**：确保开发服务器运行在 `0.0.0.0` 而非 `localhost`
- **当前配置**：`arkok/server.js` 已正确配置为 `0.0.0.0:3000`
- **配置文件位置**：`/home/devbox/project/arkok/server.js:49`

```javascript
const server = http.createServer(app);
server.listen(PORT, '0.0.0.0', () => {
  console.log(`Server running at http://0.0.0.0:${PORT}`);
});
```

#### ✅ 端口配置
- 代码中使用端口：`3000`（在 .env 文件中配置）
- Devbox 开放端口：需确认与平台配置一致
- **注意**：entrypoint.sh 会加载 .env 文件中的 PORT 配置

#### ✅ 数据库连接配置
- **配置文件**：`/home/devbox/project/arkok/.env`
- **数据库服务**：Sealos PostgreSQL
- **自动连接**：entrypoint.sh 会自动加载 .env 文件并连接数据库

数据库配置参数：
```bash
DB_HOST=growark-postgresql.ns-bg6fgs6y.svc  # Sealos 数据库主机（集群内网地址）
DB_PORT=5432                                  # 数据库端口
DB_NAME=postgres                             # 数据库名
DB_USER=postgres                             # 数据库用户
DB_PASSWORD=kngwb5cb                         # 数据库密码
```

#### ✅ 路由映射配置
- **手机端**：`http://公网地址/app` → `/home/devbox/project/arkok/public/index.html`
- **大屏端**：`http://公网地址/screen` → `/home/devbox/project/arkok/public/bigscreen/index.html`
- **Admin管理端**：`http://公网地址/admin` → `/home/devbox/project/arkok/public/index.html`

### 4. 启动后的等待时间

启动服务后，内部网关需要 **2-5 分钟**准备，请耐心等待。

### 5. 服务状态检查

#### 检查服务是否运行
```bash
ps aux | grep "arkok/server.js" | grep -v grep
```

预期输出：
```
devbox   59527  0.5  0.0 11778092 61536 ?      Sl   04:14   0:00 node arkok/server.js
```

#### 查看实时日志
```bash
# 如果服务在后台运行，使用以下命令查看输出
# PID 需要替换为实际进程ID
tail -f /proc/$(pgrep -f "arkok/server.js")/fd/1
```

#### 手动测试服务
```bash
# 测试服务器是否启动
curl http://0.0.0.0:3000/health

# 测试学生数据API
curl http://0.0.0.0:3000/api/students

# 测试手机端页面
curl -I http://0.0.0.0:3000/app

# 测试大屏端页面
curl -I http://0.0.0.0:3000/screen
```

### 6. 配置文件说明

#### entrypoint.sh（启动脚本）
- **位置**：`/home/devbox/project/entrypoint.sh`
- **用途**：自动化启动脚本，确保数据库连接和服务器启动
- **启动命令**：`./entrypoint.sh [development|production]`
- **默认环境**：development
- **自动操作**：
  1. 切换到 `/home/devbox/project/arkok` 目录
  2. 加载 `.env` 环境变量文件
  3. 显示数据库连接配置信息
  4. 启动 Node.js 服务器（server.js）

#### .env（数据库配置文件）
- **位置**：`/home/devbox/project/arkok/.env`
- **用途**：存储数据库连接配置
- **重要**：请勿将密码提交到版本控制

示例配置：
```bash
# Node.js环境
NODE_ENV=development
PORT=3000

# 数据库配置（Sealos PostgreSQL）
DB_HOST=growark-postgresql.ns-bg6fgs6y.svc  # Sealos 集群内网地址
DB_PORT=5432
DB_NAME=postgres
DB_USER=postgres
DB_PASSWORD=kngwb5cb

# WebSocket配置
WS_ORIGIN=*
WS_PATH=/ws

# CORS配置
CORS_ORIGIN=*
CORS_CREDENTIALS=true

# 连接池配置
DB_POOL_MIN=2
DB_POOL_MAX=10
DB_IDLE_TIMEOUT=30000
DB_CONNECTION_TIMEOUT=10000
```

#### arkok/server.js（后端服务器）
- **位置**：`/home/devbox/project/arkok/server.js`
- **功能**：
  - 提供前端静态文件服务
  - 代理 API 请求到 PostgreSQL 数据库
  - 处理 WebSocket 实时通信
  - 学生数据管理（积分、经验值、等级等）
- **端口**：3000
- **API端点**：
  - `/api/students` - 获取学生列表和积分数据
  - `/api/docs` - API 文档
  - `/health` - 健康检查
  - `/ws` - WebSocket 连接
- **前端路径**：
  - `/app` - 手机端应用
  - `/screen` - 大屏端应用
  - `/admin` - 管理端应用

### 7. 环境区分

#### 开发环境（development）
```bash
./entrypoint.sh development
# 或
./entrypoint.sh
```

#### 生产环境（production）
```bash
./entrypoint.sh production
```

### 8. 常见问题排查

#### Q1: 公网地址仍显示"准备中"

**检查步骤**：
1. 服务是否已启动：`ps aux | grep "arkok/server.js"`
2. 是否等待 2-5 分钟（网关准备时间）
3. 检查服务器是否监听 0.0.0.0 地址（不是 localhost）
4. 检查端口是否为 3000
5. 检查健康检查接口：
   ```bash
   curl http://localhost:3000/health
   ```

#### Q2: 网页可以访问但没有数据

**可能原因**：数据库连接失败

**检查步骤**：
1. 查看服务器输出日志，检查是否有数据库连接错误
2. 验证 .env 文件是否存在：
   ```bash
   ls -la /home/devbox/project/arkok/.env
   ```
3. 检查 .env 文件中的数据库配置是否正确
4. 测试数据库连接：
   ```bash
   curl http://localhost:3000/api/students
   ```
5. 如果返回学生数据，说明连接正常

#### Q3: 如何修改数据库连接配置

**配置文件**：`/home/devbox/project/arkok/.env`

需要修改的参数：
- `DB_HOST` - 数据库主机地址
- `DB_PORT` - 数据库端口
- `DB_NAME` - 数据库名称
- `DB_USER` - 数据库用户名
- `DB_PASSWORD` - 数据库密码

修改后需重启服务：
```bash
# 停止旧服务
kill $(pgrep -f "arkok/server.js")

# 启动新服务
./entrypoint.sh
```

#### Q4: 如何切换到其他服务

本项目已固定为 arkok 项目，如需切换到其他服务：

1. 修改 `entrypoint.sh` 中的 `build_target` 变量（当前为 "server"）
2. 确保对应的服务文件存在于 `/home/devbox/project/arkok/` 目录
3. 更新 `.env` 文件中的相应配置
4. 重启服务

### 9. 快速启动命令

```bash
cd /home/devbox/project

# 后台启动
nohup ./entrypoint.sh > server.log 2>&1 &

# 查看启动日志
tail -f server.log
```

### 10. 停止服务

```bash
# 查找进程 ID
ps aux | grep "arkok/server.js"

# 杀死进程（优雅关闭）
kill <PID>

# 强制杀死进程
kill -9 <PID>
```

### 11. 生产环境部署建议

1. **使用生产环境模式**：
   ```bash
   ./entrypoint.sh production
   ```

2. **使用进程管理器**（推荐 PM2）：
   ```bash
   npm install -g pm2
   cd /home/devbox/project/arkok
   pm2 start server.js --name "arkok-server" --env production
   ```

3. **配置反向代理**（Nginx）：
   ```nginx
   server {
       listen 80;
       server_name your-domain.com;

       location / {
           proxy_pass http://localhost:3000;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection 'upgrade';
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
           proxy_cache_bypass $http_upgrade;
       }
   }
   ```

### 12. 数据备份与恢复

Sealos PostgreSQL 数据库会定期自动备份，如需手动备份：

```bash
# 导出数据库
pg_dump -h growark-postgresql.ns-bg6fgs6y.svc -U postgres -d postgres > backup.sql

# 导入数据库
psql -h growark-postgresql.ns-bg6fgs6y.svc -U postgres -d postgres < backup.sql
```

---

**最后更新**：2025-11-25
**文档位置**：`/home/devbox/project/启动公网.md`
**配置版本**：arkok-server-v1.0
**数据库**：Sealos PostgreSQL (growark-postgresql.ns-bg6fgs6y.svc)
